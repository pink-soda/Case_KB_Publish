邮件主题：回复: 回复： 回复： 回复： [案例号: CAS-01980-K8W3H8 ] % 重庆金高云信息技术有限公司帮用户反馈HIS系统更新报错 % 初次响应 CMIT:0001834

====第1封邮件====

发件人：Li Qi
发送时间：2020-03-02 16:51:48.029000+00:00
邮件内容:
李先生，您好：
如刚才电话沟通，我谨在此阐述问题涉及的范围定义：
问题范围：用户反馈医院的HIS系统运行更新时，需要访问server 2003的共享文件夹update下载更新，出现更新文件下载不了，弹出报错：“版本更新出错，连接数据库”
问题定义：协助用户分析并处理此问题。
如您对以上问题范围定义有任何疑问请直接与我联系。
鉴于刚才电话所沟通的内容，请您先检查SMB1.0功能是否均已在更新成功与失败的两台电脑上开启，检查方法如下：
打开控制面板-“启用或关闭windows功能”-SMB1.0/CIFS File Sharing Support是否已勾选，如未勾选，请先勾选并确定
之后，请在两台电脑上使用ProcessMonitor工具（见附件）分别抓取日志，步骤如下：
收集procmon日志信息：
a)      保存附件processmonitor.zip至本地计算机
b)      解压完成后，双击执行procmon.exe
c)      显示如下界面，并点击capture按钮，先暂停收集，准备进行捕获
d)      点击clear按钮，清空当前窗口，然后点击capture按钮，开始捕获
e)     待问题复现后，再次点击capture按钮，停止捕获
f)      点击File menu, 点击Save. 选择"All events" and "Native Process Monitor Format (PML)"点击OK，并将此文件回传给我进行分析，谢谢
PS：请记录出现弹框错误窗口的时间戳，方便问题定位范围

====第2封邮件====

发件人：Li Qi
发送时间：2020-03-03 16:40:39.767000+00:00
邮件内容:
李先生，您好：
如刚才电话沟通，由于刚才未能联系到用户，所以以此封邮件先向您说明一下目前的case进度：
经过对上午您反馈的成功与失败日志的对比发现，HIS系统的更新流程如下：
1， 访问共享中的auto_update.exe
2， 确认版本需要升级后，连接至数据库验证，之后会在本地创建update agent文件
3， 同步更新信息，查询并修改本地的注册表键值
4， 完成更新
从日志上看，怀疑目前问题出现在第二步上，在本地创建agent文件过程失败，看下对比的日志信息：
更新失败：
更新成功：
如果第二步在创建本地站点文件时失败，那么后续的步骤就无法继续进行。现在的问题就变成了为何在本地创建站点失败，根据与您的沟通，目前怀疑与本地账号权限相关。由于权限不足导致的无法写入造成更新失败
接下来的动作：
1， 检查两台电脑是否存在如下文件夹，文件夹内是否有内容
c:\windows\CSC\V20.0.6\namespace
2，问题电脑上创建新的本地账号，赋予本地管理员权限后，重启使用新的本地管理员权限账号登陆，再次尝试HIS更新
以上，由于现在未能成功联系上用户，我会继续尝试与用户联系，优先远程处理，请您知悉，谢谢
现场用户联系方式：13983689527 郝先生

====第3封邮件====

发件人：Li Qi
发送时间：2020-03-05 10:27:51.433000+00:00
邮件内容:
李先生，您好：
到现在还没有联系到用户，打电话一直无人接听。

====第4封邮件====

发件人：Li Qi
发送时间：2020-03-06 17:39:59.406000+00:00
邮件内容:
李先生，您好：
根据下午的远程结果，目前可以确认的几点信息如下：
1.	共享文件夹访问正常
2.	Auto_update.exe如果拷贝至在本地执行，可以正常更新，更新过程为，确认HIS软件版本号，如需要更新，检索D:\his文件夹是否存在，在此文件夹下创建临时文件夹用于获取更新文件，完成更新过程。整个过程目前看来是正常的
3.	如果在共享文件夹下直接双击执行，更新失败
4.	基于以上几点，目前问题出现在：双击旧版本软件，跳转至共享文件夹获取auto_update.exe时，未将该文件下载至本地或是否执行类似的指令。这个属于软件供应商的支持范畴。作为系统厂商，我们最多提供一些辅助内容
下一步动作：
协同HIS供应商，分析是否可以添加下载至本地的脚本指令，同时确定是以哪种协议进行的远程访问，以方便确认是否有对应的用户权限限制，谢谢

====第5封邮件====

发件人：Li Qi
发送时间：2020-03-09 17:21:10.226000+00:00
邮件内容:
李先生，您好：
如刚才沟通，该问题涉及HIS应用更新的实现方式及要求，对此我们并不是十分清楚需要的权限设计及访问机制，需要应用厂商进行解决，我们可以从旁协助处理。鉴于目前用户认可将update agent拷贝至本地运行的更新方式，且影响较小，经您的同意，此case将暂做归档处理，以下为案例总结，请您知悉：
Case No： CAS-01980-K8W3H8 
问题描述：
=====================
用户反馈医院的HIS系统运行更新时，需要访问server 2003的共享文件夹update下载更新，出现更新文件下载不了，弹出报错：“版本更新出错，连接数据库”
问题分析：
=====================
经测试，HIS应用的更新过程大致为：
1.	双击运行旧版本的应用程序nurse.exe
2.	在数据库查询HIS应用的版本信息
3.	如需更新，连接file server进行auto_update更新
目前用户反馈的问题发生在1-2的过程中，如果直接运行auto_update或拷贝至本地运行，则可以正常更新
同时在客户端访问数据库的agent也可以正常访问，说明客户端连接数据库正常。
因此问题出现在HIS应用是如何访问数据库进行查询的访问机制上及需要使用的协议和权限，这一点需要HIS厂商明确。
问题总结：
=====================
该问题涉及HIS应用更新的实现方式及要求，对此我们并不是十分清楚需要的权限设计及访问机制，需要应用厂商进行解决，我们可以从旁协助处理。鉴于目前用户认可将update agent拷贝至本地运行的更新方式，且影响较小，经您的同意，此case将暂做归档处理，之后系统会发送一封满意度邮件，请您方便时进行反馈。如有其它问题，您也可以随时与我们联系，最后感谢您这段时间对我工作的大力支持。
