邮件主题：答复: 回复: 回复: 回复: 回复: 回复: 回复: 回复: 回复: 回复: 回复: 回复: 回复: 答复: 转发: 回复: [案例号: CAS-02526-V3W8K2 ] % |P3|ICBC|神州网站政府版打开图片出现弹框提示 % 初次响应 CMIT:0001141

====第1封邮件====

发件人：Li Qi
发送时间：2020-07-01 14:23:02.354000+00:00
邮件内容:
占先生，您好：
如刚才电话沟通，我谨在此阐述问题涉及的范围定义：
问题范围：用户反馈打开图片会弹出选择使用什么应用打开的提示框，即便选择了始终使用此应用打开也还是会提示。
问题定义：协助用户分析上述问题。
如您对以上问题范围定义有任何疑问请直接与我联系。
请您按照如下步骤，进行确认：
1，点击开始--应用-默认应用的照片查看器，选择“照片”
2，如问题依旧，请继续点击“按文件类型指定默认应用”，选择.jpg类型进行“照片”的指定
请将上述尝试步骤的结果反馈给我，谢谢

====第2封邮件====

发件人：Li Qi
发送时间：2020-07-01 15:05:09.323000+00:00
邮件内容:
占先生，您好：
感谢您的回复，请查看以下注册表键值是否相同：
1，HKEY_CLASSES_ROOT\.jpg\OpenWithProgids
如有多余项请删除（默认为四条键值，表示使用“照片app”打开，卸载“照片app”后应只剩下三条，如上图）
2，HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows Photo Viewer\Capabilities\FileAssociations
如没有此键值，请手动添加（默认没有此键值，正常打开jpg文件不使用”windows 照片查看器”，而是使用“照片APP”）
再次查看勾选“始终使用此应用打开”是否生效。我这边卸载“照片app”后是可以的。

====第3封邮件====

发件人：zhanjian@sdc.icbc.com.cn
发送时间：2020-07-01 15:35:19.854000+00:00
邮件内容:
昨天已经删除过多余的长appid项，删除后还是反复跳的。 
目前两个值如下： 

====第4封邮件====

发件人：Li Qi
发送时间：2020-07-01 15:42:34.415000+00:00
邮件内容:
占先生，您好：
感谢您的反馈，请您使用附件内容抓取procmon日志，用于具体分析。
收集procmon日志信息：
a)      保存附件processmonitor.zip至本地计算机
b)      解压完成后，双击执行procmon.exe
c)      显示如下界面，并点击capture按钮，先暂停收集，准备进行捕获
d)      点击clear按钮，清空当前窗口，然后点击capture按钮，开始捕获，打开.jpg文件，并勾选“始终使用此应用打开”，关闭文件，再次打开
e)     待问题复现后，再次点击capture按钮，停止捕获
f)      点击File menu, 点击Save. 选择"All events" and "Native Process Monitor Format (PML)"点击OK，并将此文件回传给我进行分析，谢谢
以下为，请知悉： 

====第5封邮件====

发件人：zhanjian@sdc.icbc.com.cn
发送时间：2020-07-01 17:14:20.999000+00:00
邮件内容:
1、设置勾选“始终使用此应用打开”后自动打开testpic.jpg 
2、再次重新打开testpic.jpg弹框 
具体文件我用 zhanjian731@126.com 邮箱发你了。 

====第6封邮件====

发件人：Li Qi
发送时间：2020-07-02 10:46:39.878000+00:00
邮件内容:
占先生，您好：
感谢您的回复。根据您提供的日志内容，请先删除如下两处注册表的缓存记录，重新尝试看问题是否依旧：
1， HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Explorer\FileExts\.jpg\UserChoice整个项
2， HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Explorer\FileExts\.jpg\OpenWithList下的内容
删除后如下图：
以下是您提供的日志中，打开jpg文件时的部分过程，会根据当前用户的选择记录顺序进行打开，目前无法生效可能是由于记录信息错误导致，尝试删除这部分信息再次查看。
如上述步骤无法生效，您也可以尝试登陆另一个新账户，以查看是否可以解决该问题。

====第7封邮件====

发件人：zhanjian@sdc.icbc.com.cn
发送时间：2020-07-02 11:45:18.716000+00:00
邮件内容:
删除注册表项之后变为可以用Win10的3D画图打开，不再弹窗。但如果再设置为照片查看器之后，恢复到之前故障状态，又开始弹窗，没有其他变化。 
不再设置的情况下，在wps的excel附件的图片无法打开，如下提示： 
通过win+I的win10设置设置默认打开方式为照片查看器之后，恢复到之前故障状态，又开始弹窗，没有其他变化。 
且设置为3D画图之后，在wps的excel中弹的窗有所变化： 

====第8封邮件====

发件人：Li Qi
发送时间：2020-07-02 12:10:41.879000+00:00
邮件内容:
占先生，您好：
感谢您的回复，由于电话无法联系到您，所以邮件询问一下。请问有没有尝试过使用其他新账户登陆此系统，是否有同样问题？

====第9封邮件====

发件人：zhanjian@sdc.icbc.com.cn
发送时间：2020-07-02 14:06:38.499000+00:00
邮件内容:
切换用户后，默认的打开好像没有问题。但是不能做设定打开方式切换，一旦切换就会出现每次双击图片文件不停弹窗的问题。 

====第10封邮件====

发件人：Li Qi
发送时间：2020-07-02 15:54:25.998000+00:00
邮件内容:
占先生，您好：
请问默认的打开是用什么应用打开的？设置打开方式是在哪里设置的？是默认应用那里么？另外您之前提到卸载“照片”应用，之外还有其他的操作么？
请帮忙使用procmon按照上次方法继续抓取日志文件，之后请将日志上传至CDUC系统中，附件为CDUC的使用方法，稍后系统会为您发送登陆用户名和密码，请您查收，谢谢

====第11封邮件====

发件人：zhanjian@sdc.icbc.com.cn
发送时间：2020-07-02 16:34:16.184000+00:00
邮件内容:
默认是win10的照片app。设置打开方式是win+I的win10 metro的设置项默认应用那里的。没有什么其他操作。 
新用户下没有卸载“照片”应用也是同样情况。 
如果再抓取是要重新再切换个新用户？切用户这个太复杂了 

====第12封邮件====

发件人：Li Qi
发送时间：2020-07-02 18:48:30.153000+00:00
邮件内容:
黄先生 & 占先生，您们好：
如刚才电话沟通，请黄先生解压并运行附件CMGE-DataCollectionTool内容，之后将桌面新生成的logs文件夹压缩，并连同procmon日志一起发送给占先生。请占先生收到之后，帮忙一起上传至文件上传系统，谢谢两位的配合
另关于查询操作系统小版本的方法如下：
按Win+R，输入“msinfo32”，查看硬件抽象层即可
以下是黄先生提到的补丁信息：

====第13封邮件====

发件人：Li Qi
发送时间：2020-07-03 11:20:53.126000+00:00
邮件内容:
占先生，您好：
由于刚才电话未联系到您，想请问目前日志的收集情况，在之前的日志中，我们发现：工行的安控软件Pclient（TMS）阻止了openwith的运行，进而导致操作系统不清楚使用何种打开方式打开。因此怀疑可能与该软件的调用权限有关
上午也与黄先生联系，由于工行内部无法更改用户的UAC权限。现在想向您核实如下信息：
1， 可否使用其他电脑测试打开jpg文件，使用右键打开方式进行默认应用的选择后，并且在windows设置里设置照片打开的默认应用后，是否会遇到和黄先生一样的问题，每次打开都会弹框，要求选择打开方式
2， 关于组策略的配置应用，这个在我昨天给您的工具中有收集，请连同新账户下的procmon一并发送给我，谢谢

====第14封邮件====

发件人：Li Qi
发送时间：2020-07-08 11:11:14.012000+00:00
邮件内容:
黄先生 & 占先生，您好：
由于刚才电话未能打通，所以发送此邮件和您联系，目前看到的日志里，仍然怀疑因权限因素导致无法设置JPG的文件关联成功。请您尝试使用安全模式访问是否有此问题。另之前提到的data collection日志并没有收到，参见附件内容。请占先生帮忙收集之后，发送给我，仍然上传至之前的CDUC日志上传系统即可，谢谢。
进入安全模式方法：
按住shift+重启按钮，进入高级选项，选择启动设置，点击重启
以下为本次日志的部分分析内容。
正常系统行为的openwith操作：
故障系统行为的opernwith操作：

====第15封邮件====

发件人：Li Qi
发送时间：2020-07-09 17:39:12.933000+00:00
邮件内容:
黄先生 & 占先生，您好：
如刚才电话沟通，请使用附件的日志收集工具在正常启动模式下收集系统日志。
另外请在clean boot模式下，收集procmon日志。以下为进入clean boot的方法：
*	在运行栏内输入msconfig，调出系统配置，在“常规”下选择“有选择的启动”，勾选加载系统服务和加载启动项
*	在“服务”选项下，勾选“隐藏所有Microsoft服务”，再点击“全部禁用”-确定，重启进入Clean boot
*	       
*	步骤操作：
*	在运行栏内输入msconfig，调出系统配置
*	在“常规”选项下选择“有选择的启动”，勾选加载系统服务和加载启动项
*	在“服务”选项下，勾选“隐藏所有Microsoft服务”，再点击“全部禁用”-确定
*	重启进入Clean boot
上述两个日志收集完成后，请占先生帮忙上传至CDUC，谢谢

====第16封邮件====

发件人：Li Qi
发送时间：2020-07-15 16:59:16.278000+00:00
邮件内容:
黄先生，您好：
感谢您的接听，如刚才电话沟通，我谨以此封邮件总结一下目前的问题进度：
1， 截至现在，先后收集您的电脑的问题日志和占先生的电脑的对比日志两次。包括procmon日志及系统日志。从分析进度来看，由于工行本身的定制镜像，而且内部的策略限制及安控软件的影响，可能导致此问题的原因从组策略及软件受限方面并未找到可疑项，主要有以下几点：
*  由于您与占先生分发的组策略内容不同，不排除受组策略影响
*  运行进程integrity过高，不排除受权限影响阻止默认应用打开
*  日志中看到lockfile操作，不排除受安控软件限制影响
2， 从几次收集的日志来看，JPG文件的默认应用在windows设置及对应注册表上均已设置成功，并且在打开JPG文件时也确实成功读取到对应的键值，但是随即被svchost服务阻止。只是目前尚未搞清楚究竟为何会被阻止。
3， 基于第2点，在成功建立fileassociate之后，系统默认行为并不会调用openwith.exe（即弹框选项，这一点我在纯净版CMGE上已经验证），因此当前行为与系统默认行为不符。且进程integrity level过高（相较默认系统行为），引发原因还不明确。
综上所述，请帮忙进行以下操作进一步narrow down此问题
1， 安装照片UWP应用，方法如下：
管理员身份运行powershell：Add-AppxPackage -Register "C:\Program Files\WindowsApps\Microsoft.Windows.Photos_2018.18051.21218.0_x64__8wekyb3d8bbwe\AppxManifest.xml" -DisableDevelopmentMode
安装完成后，看问题是否复现
2， C:\Windows\System32\winevt\Logs 打包压缩
3， C:\Windows\System32\config 打包压缩
4， C:\windows\system32\adminscript.vbs
5， 将2-4的文件压缩后发送给占先生，@占先生，请帮忙继续上传至CDUC，谢谢

====第17封邮件====

发件人：huangxl@sdc.icbc.com.cn
发送时间：2020-07-16 08:45:07.987000+00:00
邮件内容:
所提及的路径不存在 
搜索到另一目录下有包之后，进行安装 
Add-AppxPackage -Register "C:\Program Files\WindowsApps\DeletedAllUserPackages\Microsoft.Windows.Photos_2018.18011.15918.0_neutral_split.scale-100_8wekyb3d8bbwe\AppxManifest.xml" -DisableDevelopmentMode 
其他类似在WindowsApps下的搜索的目录结构不同、缺乏文件无法安装 

====第18封邮件====

发件人：Li Qi
发送时间：2020-07-16 09:55:52.806000+00:00
邮件内容:
黄先生，您好：
感谢您的回复，您可以尝试将附件的文件解压拷贝至photos的路径下，然后再执行安装命令。看看可不可以。如果还是不行，您就先将以下几个文件夹打包拷贝给占先生，发送给我吧。谢谢
C:\Windows\System32\winevt\Logs 打包压缩
C:\Windows\System32\config 打包压缩
C:\windows\system32\adminscript.vbs
另外还想再问您一下，我们之前尝试过重置设置里的默认应用。当选择了重置之后，是否其他扩展名的默认应用均发生变化。还是没有发生变化？还有如果尝试打开一个.bmp文件或者.tif文件是否也会弹框让您选择打开方式呢？
另外，请使用管理员身份打开powershell运行以下命令，并将C:\temp\CustomFileAssoc.xml一并发送给我，谢谢
Dism.exe /online /export-defaultappassociations:C:\temp\CustomFileAssoc.xml

====第19封邮件====

发件人：huangxl@sdc.icbc.com.cn
发送时间：2020-07-16 11:25:07.930000+00:00
邮件内容:
无法放入文件，没有权限。可能安装文件的一致性控制了吧 
winevt\Logs、config等，很多被访问占用无法访问 
config文件很大另发 
jpg只是一个例子，其他的类似bmp、png等同样会出现问题。在各种过程中都是统一变化的。 

====第20封邮件====

发件人：huangxl@sdc.icbc.com.cn
发送时间：2020-07-16 11:31:51.766000+00:00
邮件内容:
config附件分包2： 
---------     
    此邮件信息仅供收件人查阅，所含任何评论、陈述或数据仅供收件人参考，若有改动，恕可能不另行通知。未经中国工商银行书面许可，请勿披露、复制、转载此邮件信息。任何第三方均不得查阅或使用此邮件信息。若您误收到本邮件，敬请及时通知
====第21封邮件====

发件人：huangxl@sdc.icbc.com.cn
发送时间：2020-07-16 11:32:20.860000+00:00
邮件内容:
config附件分包1： 
---------     
    此邮件信息仅供收件人查阅，所含任何评论、陈述或数据仅供收件人参考，若有改动，恕可能不另行通知。未经中国工商银行书面许可，请勿披露、复制、转载此邮件信息。任何第三方均不得查阅或使用此邮件信息。若您误收到本邮件，敬请及时通知
====第22封邮件====

发件人：Li Qi
发送时间：2020-07-16 14:28:00.293000+00:00
邮件内容:
黄先生，您好：
感谢您的回复，收到您发送的日志。不过好像确实因为权限原因在拷贝时被阻止了。我这边需要查看的相关文件并没有发送过来
麻烦您再看一下 下面的三个位置，可以先将他们拷贝至桌面，至少将（）内的几个文件拷贝出来。再进行压缩后上传，谢谢
*  C:\Windows\System32\winevt\Logs----这里的系统日志主要需要（application.evtx；Security.evtx；system.evtx这三个文件） 
*  C:\Windows\System32\config---这里的文件主要需要（default；SAM；security；software；system这五个文件）
*  C:\windows\system32\adminscript.vbs

====第23封邮件====

发件人：huangxl@sdc.icbc.com.cn
发送时间：2020-07-16 16:18:12.098000+00:00
邮件内容:
config目录下5个文件全部被占用，无法复制。 

====第24封邮件====

发件人：Li Qi
发送时间：2020-07-17 18:38:02.302000+00:00
邮件内容:
黄先生，您好：
感谢您的配合，经过今天一天的内部分析，现将问题进度向您汇报一下：
从最新收到的事件日志，可以看到在打开JPG文件的过程中，explorer进程在读取相应的注册表键值后，跳转至openwith.exe。进而提示用户选择打开方式。
注册表的相关键值被设置并保存，但从事件日志上可以看到，有未知进程再重新写入对应的键值，使其hash值发生变化，因此并未读取成功。基于上述判断，不排除有代码劫持的可能。
Explorer PID 9448 载入默认关联 8：26：39 AM
未知进程PID 5616设置 JPG文件关联    8：29：57 AM
未知进程PID 9928设置 JPG文件关联    8：30：08 AM
OpenWith.exe PID 11364设置 JPG文件关联 8：30：45 AM
为了进一步排查此问题，请使用附件运行SystemInternals Autoruns工具，在C盘根目录下创建log文件夹，同时帮忙执行如下操作：
1-    显示文件扩展名关联：在CMD中运行： assoc  >c:\log\assoc.txt
2-    显示文件扩展名所关联程序： 在CMD中运行 ftype  >c:\log\ftype.txt
3-    设置 .jpg 文件扩展名：在CMD中运行 assoc .jpg=jpegfile
4-    设置 .jpg 文件关联图片查看器 ftype jpegfile=%SystemRoot%\System32\rundll32.exe "%ProgramFiles%\Windows Photo Viewer\PhotoViewer.dll", ImageView_Fullscreen %1
5-    如果步骤4运行后文件没有正常打开，在弹框的打开方式中选择图片查看器打开，并同时勾选始终用此应用打开 .jpg 文件。
在运行以上1-5操作时，请使用PROCMON软件抓取日志。（启用PROCMON时，请以管理员方式运行）
最后，将C:\LOG文件夹；procmon日志；autoruns保存文件，打包压缩发送给我，谢谢

====第25封邮件====

发件人：Li Qi
发送时间：2020-07-21 17:22:29.479000+00:00
邮件内容:
黄先生，您好：
如刚才电话沟通，请您尝试做如下两个操作，我会在周四上午与您联系，确认操作结果，感谢您的配合：
1， 重命名 C:\Program Files (x86)\DSPClient\CEMS\EDSM\MedAdapter64.dll 这个文件，如有权限重命名成功，请尝试问题是否复现
2， 请解压附件工具至本地，按照如下步骤操作，将生成的VHDX文件发送给我
取消Use Volume Shadow Copy勾选，选择C盘，然后生成VHDX文件（文件路径自定义）。

====第26封邮件====

发件人：huangxl@sdc.icbc.com.cn
发送时间：2020-07-23 11:09:05.664000+00:00
邮件内容:
C:\Program Files (x86)\DSPClient\CEMS\EDSM>ren MedAdapter64.dll MedAdapter64.dll.bak 
拒绝访问。 
vhdx文件有57个G，没法邮件外发。 

====第27封邮件====

发件人：Li Qi
发送时间：2020-07-23 16:27:06.032000+00:00
邮件内容:
黄先生，您好：
感谢您的回复。请问上周五和您提到的方法是否有效，您可以参照附件内容试一下。
有关VHDX文件请占先生帮忙上传至sftp，具体方法如下：
为了更安全、快速地传输数据，您可以在Filezilla上使用以下账户信息登入神州网信网站。 
l  Filezilla client端下载URL：https://filezilla-project.org/download.php?type=client
l  登陆地址：sftp://ocean.cmgos.com 
l  用户名为：ICBC（区分大小写）
l  端口：22222 
l  密码：2qfs52ninbFB
登陆之后，上传至upload文件夹

====第28封邮件====

发件人：huangxl@sdc.icbc.com.cn
发送时间：2020-07-23 16:37:27.388000+00:00
邮件内容:
占剑有渠道能访问这个sftp？我们这边都是内网隔离的 
如果有的话，给我个地址，我先给占剑你吧 

====第29封邮件====

发件人：Li Qi
发送时间：2020-07-23 17:32:37.360000+00:00
邮件内容:
Yang Hong，您好：
刚刚收到用户反馈，尝试重命名MedAdapter64.dll文件失败，提示拒绝访问。建议用户收集P2V，用户表示包含个人信息，无法提供，是否有其他的排错方案，谢谢

====第30封邮件====

发件人：Yang Hong
发送时间：2020-07-24 16:03:39.279000+00:00
邮件内容:
Li先生 您好，
感谢电话中的沟通，从目前的日志，我们能看到在系统call起openwith.exe之前，系统在访问photoviewer.dll对应的配置文件。
从日志中，我们能看到Explorer.exe在访问标黄部分注册表时，无法打开。随后
在这些信息后，系统就尝试通过dcom来准备call其openwith.exe。
由于Windows 10默认是不包含photoviewer.exe，如果不是通过win 7升级到的windows 10，windows 10不应该有photoviewer.exe。
https://support.microsoft.com/en-sg/help/4027135/windows-10-photo-viewer <https://nam06.safelinks.protection.outlook.com/?url=https%3A%2F%2Fsupport.microsoft.com%2Fen-sg%2Fhelp%2F4027135%2Fwindows-10-photo-viewer&data=02%7C01%7CJesse.Jiang%40microsoft.com%7Ca5dcdaf5b33746eb97e008d734fcbe81%7C72f988bf86f141af91ab2d7cd011db47%7C1%7C0%7C637036132462136303&sdata=J24Ev7EOogf%2Fk5F3BUwH65hyHHk8xv7NrY6vjKA6Yyc%3D&reserved=0>  
Windows Photo Viewer isn't part of Windows 10, but if you upgraded from Windows 7 or Windows 8.1, you might still have it. To check, press and hold (or right-click) a photo in File Explorer, and select Open with. If Windows Photo Viewer isn't in the list, you cannot install it on Windows 10.﻿
从和您的电话中得知，目前的客户的电脑不是通过升级获得的，因此当前的photo viewer应该是用户后续自己安装上的。
我随后在自己的环境中，尝试安装了photoviewer.exe，
根据我的测试环境，command key位于print键值下，而不位于shell下。
根据本地的测试，在点击图片后，其会随后访问c:\program files\windows photo viewer\Photoviewer.dll，随后尝试打开图片、
由于Windows 10上直接安装photoviewer是不支持的，其本身是否支持这个应用，这个应用在使用时是否会产生问题，都是有可能出现的，且无法进行debug。另外，在现有日志中，explorer.execall其openwith的tid和explorer访问photoviewer的tid是相同的，因此在函数calsltack层面上，其是连续的。
后续的定位必须要排除photosviewer带来的影响。
下一步方案：
1）将默认打开方式，修改为mspaint进行定位。
1）卸载用户的DSP 进行观察。
如果问题依然存在，麻烦抓取process monitor 日志。
另外可以和用户询问下其设置windows photo viewer 的方法，如果可以，我们可以使用客户的方案在另外一台计算机上尝试进行复现。
Best Regards,
Yang Hong| Support Engineer 
Email: yaho@microsoft.com <mailto:bryu@microsoft.com> 
Phone: 86-510 6665 7753
Working Hours: Monday- Friday 9:00 AM -6:00 PM (UTC +08:00)

====第31封邮件====

发件人：Li Qi
发送时间：2020-07-24 17:11:25.845000+00:00
邮件内容:
占先生，您好：
感谢您的反馈，由于电话未联系到您，特发送此邮件说明一下目前的问题进展。
之前和黄先生做过沟通，目前该问题只出现在黄先生的电脑上，且从之前收到的日志分析，黄先生的电脑有关默认应用及文件关联的设置是正确的，因此不排除因工行的定制软件或域策略的阻止导致每次操作都会启动openwith的进程出现弹框。并且没办法在我们的环境中进行复现。
P2V的收集可以包含用户电脑上的所有设置内容，以避免重复收集日志给客户带来的困扰以及环境对测试的限制。
对于该问题的排查，基于用户数据安全考虑，目前无法收取P2V，则可能后续仍然需要多次的不同日志收集，才能找到最终原因。
从之前收集的日志中，可以看到操作系统在查找PhotoViewer时的打开位置是不对的，进而导致无法使用既有设置的PhotoViewer进行打开（由于CMGE默认不包含photoviewer.exe。从官方资料上看，这可能是由于CMGE的安装方式并非全新安装导致之前操作系统的部分组件遗留。https://support.microsoft.com/en-sg/help/4027135/windows-10-photo-viewer <https://nam06.safelinks.protection.outlook.com/?url=https%3A%2F%2Fsupport.microsoft.com%2Fen-sg%2Fhelp%2F4027135%2Fwindows-10-photo-viewer&data=02%7C01%7CJesse.Jiang%40microsoft.com%7Ca5dcdaf5b33746eb97e008d734fcbe81%7C72f988bf86f141af91ab2d7cd011db47%7C1%7C0%7C637036132462136303&sdata=J24Ev7EOogf%2Fk5F3BUwH65hyHHk8xv7NrY6vjKA6Yyc%3D&reserved=0> ），但由于黄先生使用其他的打开方式也有此问题，所以需要以其他的打开方式来进行问题分析。如下图：
默认的command key位于print键值下，并不位于shell下
黄先生的电脑的explorer.exe在访问时的query路径有误
综上分析，目前我们的问题主要集中在openwith为何被调用，这有如下两点可能：
1， PhotoViewer无法默认打开，是由于未找到正确注册表键值（这一点与PhotoViewer的安装方式有关），还是由于权限或第三方应用等问题被阻止访问？
2， 如果因为权限或第三方应用的原因，具体是什么？
接下来，优先排查第二点，想询问您一下，是否可以做如下的测试用于问题的narrow down分析：
1， 将用户电脑退域。
2， 卸载用户的DSP软件，并确保不存在C:\Program Files (x86)\DSPClient\CEMS\EDSM\MedAdapter64.dll 这个文件。
3， 尝试使用本地账户登录后，双击jpg图片，看问题是否复现。
4， 如问题复现，请将默认打开方式更改为mspaint进行procmon的日志收集
上述操作仅供问题分析使用，需要您使用域管理员账号进行协助操作。谢谢

====第32封邮件====

发件人：zhanjian@sdc.icbc.com.cn
发送时间：2020-07-24 20:49:23.045000+00:00
邮件内容:
让黄总的电脑退域测试太麻烦了吧？你如果觉得是dsp软件的问题，我有权限卸载黄总电脑的dsp软件 

====第33封邮件====

发件人：Li Qi
发送时间：2020-07-27 09:41:20.437000+00:00
邮件内容:
占先生，您好：
感谢您的回复。您可以先卸载DSP软件，然后看一下问题是否复现，如仍有问题，还是建议退域后再次观察一下，这对于我们进行问题的narrow down排查很有帮助，谢谢。

====第34封邮件====

发件人：zhanjian@sdc.icbc.com.cn
发送时间：2020-07-27 11:11:05.342000+00:00
邮件内容:
新文档安全技术支持： 
    我们发现dsp一个问题：我们有位领导的电脑T490S（win10政府版），装了dsp软件后双击打开图片始终会弹出框如下，勾上了“始终使用此应用打开.jpg文件”也没有效果，卸载dsp后双击图片就会生效不再弹框，还请dsp项目组协同神州网信公司李琦工程师一起分析解决领导的这个问题，谢谢。 

====第35封邮件====

发件人：ds_support@sdc.icbc.com.cn
发送时间：2020-07-27 11:24:16.530000+00:00
邮件内容:
您好，请问使用的DSPS是哪个版本，关于win10政府版打开图片问题在2019年7月版本有优化过，帮忙确认谢爱DSPS版本，如果版本没问题，帮忙获取下DSPS客户端日志，右键DSPS客户端托盘-日志采集，然后在弹出的对话框选一个目录，生成的日志会自动保存在该目录，等待弹出日志收集完成提示后将该日志反馈即可，谢谢 

====第36封邮件====

发件人：zhanjian@sdc.icbc.com.cn
发送时间：2020-07-27 11:29:02.051000+00:00
邮件内容:
dsp的版本为DSPClientOfficeV8.2.2005.2610，DSPS客户端日志请黄总按照方法做下回复：“右键DSPS客户端托盘-日志采集，然后在弹出的对话框选一个目录，生成的日志会自动保存在该目录，等待弹出日志收集完成提示后将该日志反馈”，谢谢 

====第37封邮件====

发件人：Li Qi
发送时间：2020-07-27 11:32:03.321000+00:00
邮件内容:
占先生 & DSP项目组同事，您们好：
感谢您的反馈，我们在之前的日志中看到DSP的medadapter.DLL文件会call起openwith程序。请DSP项目组同事帮忙判断重命名此文件是否影响DSP的正常使用，之前黄先生尝试过重命名操作，但是因权限不足，拒绝访问。还请您帮忙操作一下，谢谢

====第38封邮件====

发件人：ds_support@sdc.icbc.com.cn
发送时间：2020-07-27 13:47:46.406000+00:00
邮件内容:
您好，这个不能重命名，重命名后会影响双击打开文件，这是DSPS的双击拦截模块，文档双击打开时通过此模块做进程分组等，我们先通过日志看下，另外您这边的win10政府版是哪个版本，我刚刚测试了下好像没能复现 

====第39封邮件====

发件人：Li Qi
发送时间：2020-07-27 14:17:19.446000+00:00
邮件内容:
您好：
政府版是基于Windows 10 Enterprise-G 1803进行的开发。这个问题目前仅发现在黄先生的电脑上，是否会由于某些软件的设置触发的呢？

====第40封邮件====

发件人：Li Qi
发送时间：2020-07-28 15:38:33.471000+00:00
邮件内容:
Dear All：
循例问一下，该问题是否有任何进展，鉴于目前已明确该问题的产生是DSP引发，后续是否还需要我们提供支持的部分。盼复，谢谢

====第41封邮件====

发件人：Li Qi
发送时间：2020-07-30 09:55:26.854000+00:00
邮件内容:
占先生，您好：
如刚才电话沟通，鉴于目前问题定位至DSP软件，经您的同意，此case将暂做归档处理，以下为案例总结，请您知悉：
Case No：CAS-02526-V3W8K2
问题描述：
=====================
用户打开JPG图片会弹出选择打开方式的提示框，勾选始终使用此应用打开设置无效。
问题分析：
=====================
经日志分析，可以看到在windows设置文件关联方式正常的情况下，打开JPG文件的过程中被内部DSP软件阻止，因此windows无法找到对应的关联键值，选择弹出打开方式的弹框供用户选择。在用户卸载DSP之后，问题得到解决，目前正在由DSP项目组进行分析具体问题，目前判断OS流程正常
问题总结：
=====================
该问题属第三方应用问题。待DSP同事解决处理，如分析结果仍与OS有关，您可以再次致电联系我们，由于无法确认进度时间，目前经您的同意，此case将暂做归档处理。
以上，如您后续有任何问题，可随时与我们联系，感谢您的这段时间对我的工作的大力支持与配合，谢谢

====第42封邮件====

发件人：Li Qi
发送时间：2020-07-30 14:28:16.682000+00:00
邮件内容:
Yang Hong，您好：
用户卸载DSP之后，问题不再复现，目前已与DSP厂商联系，与用户协商，此case暂时关闭，如后续第三方厂商有需要操作系统协助分析的，我们再与您联系，谢谢

====第43封邮件====

发件人：Yang Hong
发送时间：2020-07-31 10:19:25.737000+00:00
邮件内容:
李先生 您好，
感谢您的确认，经过您的允许，接下来我会将此事件做一个归档处理。非常感谢您在案子中付出的时间与帮助，同时希望我们的服务让您满意。 
结案后，如果您有关于这个案例的任何相关问题，您都可以随时打电话或发邮件给我,我将尽快和您联系。
再次感谢您使用微软的产品与服务! 如果您有其它的问题与疑问，也请随时联系我们，并祝您工作顺利！
案例关闭后，系统会”随机”发送一封来自Microsoft Support的邮件，如果您正好收到，有时间可以对这一次服务进行反馈，方便我们未来的改进和提高，谢谢。
Best Regards,
Yang Hong| Support Engineer 
Email: yaho@microsoft.com <mailto:bryu@microsoft.com> 
Phone: 86-510 6665 7753
Working Hours: Monday- Friday 9:00 AM -6:00 PM (UTC +08:00)

====第44封邮件====

发件人：ds_support@sdc.icbc.com.cn
发送时间：2020-08-03 18:49:01.208000+00:00
邮件内容:
您好，目前分析该问题可能与dsp劫持explorer查询注册表有关，请按以下步骤操作验证是否可以解决该问题 
1、导入附件的注册表文件 
2、双击打开图片文件，查看是否还会弹出选择应用程序框，如果是进行一下步 
3、在选择应用程序框中选择 "画图" （注意要勾选上始终使用此应用），点击确定 
4、在次尝试双击打开图片文件，查看该问题是否解决 

====第45封邮件====

发件人：huangxl@sdc.icbc.com.cn
发送时间：2020-08-04 08:17:07.767000+00:00
邮件内容:
按流程操作了4个步骤。没有解决。 
