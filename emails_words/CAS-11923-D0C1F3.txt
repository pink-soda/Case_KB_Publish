邮件主题：回复: 回复: [案例号: CAS-11923-D0C1F3 ] % TAM-VDI用户-中国人寿客户反馈云桌面登录等待时间长问题 % 初次响应 CMIT:0001877

====第1封邮件====

发件人：Wei Liang
发送时间：2024-08-07 17:56:50.770000+00:00
邮件内容:
高女士 您好：
感谢您的电话接听。
根据您提供的信息，我谨在此阐述我们双方针对这个问题所涉及范围界定：
问题定义:
中国人寿客户反馈使用云桌面，用户登录系统后，执行锁屏操作再解锁进入桌面的过程时间过长，需要协助排查。
用户测试启用“关闭自动根证书更新”组策略会减少锁屏解锁时间，但是不确定是不是这个问题导致的解锁时间过长。
问题范围:
我们将协助您分析处理上述问题，并对定义的问题给予最大的技术支持。
如果能及时解决问题，或问题属于产品设计的行为，或问题涉及到三方，我们将考虑关闭案例。如果存在多个问题，则我们考虑拆分案例进行分析。
接下来，我们将开始合作解决这个问题。如果您对以上的问题范围界定有任何异议，请尽快告知。如果您有其他任何疑问。也欢迎随时与我联系。
请您从以下链接下载所需的工具：
https://cduc.cmgos.com/download.php?id=1525&token=1MtT3dQDRg14eoRYmSNTifkmJAg33xHf
准备两台VDI终端，一台正常的环境，一台“关闭自动根证书更新”组策略的环境，按照以下步骤操作收集相关信息和日志：
1）双击procmon.exe运行，点击Accept后，到达此页面，会有有大量条目出现，先后点击1，2暂停抓取并清除当前条目。当前已经是可抓取状态；
2）点击下图的图标开始抓取。
3）解压wpr.zip后运行wprui.exe，按照下图所示配置，即勾选“First level triage”、“CPU usage”、“File I/O activity”、 “Registry I/O activity”、“Handle usage”、“Minifilter I/O activity”后，配置Performance scenario 为General。
4）点击“Start”后，开始抓取日志。
5）执行锁屏再次登录操作，等待一段时间后进入VDI桌面，复现解锁缓慢问题。
6）此时回到Process Monitor窗口，单击Capture图标，停止抓取；
7）点击File, 点击Save. 选择"All events" and "Native Process Monitor Format (PML)"点击OK。记录文件保存位置； 
8）将PML文件重命名为“解锁缓慢日志”。
9）返回到wprui界面，点击“Save”，按照提示保存对应的etl日志，将保存的etl日志压缩后通过CDUC上传。
10）将“解锁缓慢日志”压缩后通过CDUC上传。
11）双击运行CMGELogCollectorV2.exe，勾选所有选项，点击收集获取对应的系统日志，将生成的日志压缩包通过CDUC上传。
日志上传方法：
用户名：renshou
密码：renshou
注意：添加文件，点击上传后，跳转到新的页面点击保存。

====第2封邮件====

发件人：Wei Liang
发送时间：2024-08-08 10:32:19.483000+00:00
邮件内容:
高女士 您好：
日志已经收到，有任何进展会及时与您沟通，谢谢。

====第3封邮件====

发件人：Wei Liang
发送时间：2024-08-09 16:34:23.122000+00:00
邮件内容:
高女士 您好：
查看gsw日志文件，其procmon日志抓取有问题，锁屏解锁阶段的procmon日志没有收取，中间直接跳过了这段时间日志的抓取。
系统锁屏解锁操作时，会唤起logonui.exe进程，解锁进入桌面后，logonui.exe进程会退出。
查看gaoshuwen02的procmon日志，以最后一次的logonui.exe进程排查锁屏解锁过程。
查看这个时间点内的logonui.exe进程情况，查看logonui.exe进程加载的三方模块情况，其包含huawei hdp 组件，从组件名称看，这应该是hdp中用于凭据提供的provider。
从logonui.exe进程的文件和注册表访问来看，logonui.exe 在解锁过程中执行了一系列与用户界面加载、凭据验证、安全策略应用以及用户配置文件加载相关的操作。
查看文件访问情况，它多次访问C:\Program Files\Huawei\HDPServer\ginalog.txt文件，这应该与用户身份识别和验证有关。
应该是HDPServer中的组件参与了用户认证过程，为了排除HDPServer的影响，建议测试不安装HDPServer，直接在云桌面管理端测试解锁过程的时间占用情况。
或者是否有办法不使用HDPServer进行凭据验证，测试是否可以改善解锁时间占用。也可以排查当前云桌面登录方式是否可以调整，使用其他的登录配置。

====第4封邮件====

发件人：Wei Liang
发送时间：2024-08-12 16:54:20.078000+00:00
邮件内容:
高女士 您好：
查看您最新提供的日志，可以看到，负责管理用户登录界面的logonui.exe进程有一个明显的16秒左右的间隔时间，没有明确的操作记录。
查看logonui.exe加载的模块情况，有加载HWCredentialProvider.dll，根据其属性说明，它是华为HDP中的凭据提供程序，是用户身份验证的主要机制，在用户登录时以及其他系统身份验证场景中需要证明其身份时用于证明身份的方法。当前设备使用了此凭据提供程序完成用户身份验证。
Logonui.exe进程在访问C:\Program Files\Huawei\HDPServer\ginalog.txt文件，查看ginalog.txt文件，可以看到详细的用户认证过程。
Logonui通过HWCredProvCredential发起解锁请求。
HWCredProvCredential将请求发给HDPGina。
HDPGina将请求发送给Mainservice。
但是HDPGina经过15秒左右后才收到Mainservice的回复。
当收到回复后，很快就解锁成功。
解锁等待时间长主要出现在HDPGina发送请求，经过较长时间后才收到回复，导致解锁缓慢。
排查建议：
1）HWCredProvCredential和HDPGina是三方的凭据提供程序，您可以参考以下信息尝试不使用三方凭据提供程序，验证解锁情况。
https://bbs.huaweicloud.com/forum/thread-69538-1-1.html
2）HDPGina与Mainservice是三方应用，建议请应用提供商详细排查当前云桌面终端解锁缓慢的现象。

====第5封邮件====

发件人：Wei Liang
发送时间：2024-08-14 17:02:21.261000+00:00
邮件内容:
高女士 您好：
感谢您的电话接听。
如电话中所说，应用开发人员已经在排查这个问题。
如果针对当前案件需要我们协助，可以通过邮件或者400热线联系我们，谢谢

====第6封邮件====

发件人：Wei Liang
发送时间：2024-08-16 16:43:51.760000+00:00
邮件内容:
高女士 您好：
来信是想咨询当前案例进展情况。是否已经排查、确认了解锁时间长的原因和解决方案？
如果针对当前案件需要我们协助，可以通过邮件或者400热线联系我们，谢谢

====第7封邮件====

发件人：Wei Liang
发送时间：2024-08-20 17:31:26.806000+00:00
邮件内容:
高女士 您好：
感谢您的电话接听。
经过您的同意，我将暂时归档此案例。
工单的归档并不会影响我们为您提供技术支持服务，如有其他问题，您可以随时联系我们。
案例总结：
----
问题定义：
中国人寿客户反馈使用云桌面，用户登录系统后，执行锁屏操作再解锁进入桌面的过程时间过长，需要协助排查。
用户测试启用“关闭自动根证书更新”组策略会减少锁屏解锁时间，但是不确定是不是这个问题导致的解锁时间过长。
问题总结：
日志排查确认云桌面终端使用三方凭据提供程序HWCredentialProvider完成用户身份验证，解锁等待时间长主要出现在三方凭据提供程序相关的HDPGina发送请求，经过较长时间后才收到回复，导致解锁缓慢。
三方应用提供商已经在排查云桌面终端解锁缓慢的问题，如需CMIT协助，可以通过邮件或者400热线联系我们。
以上，如您后续有任何问题，可随时与我们联系，谢谢。
