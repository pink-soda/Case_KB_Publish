邮件主题：回复: [案例号: CAS-07964-V4N3T4 ] % 农业银行用户反馈CMGE系统下开启UWF保护机制导致安全策略执行变慢问题 % 初次响应 CMIT:0001963

====第1封邮件====

发件人：Wei Liang
发送时间：2023-01-09 16:36:17.061000+00:00
邮件内容:
赵女士 您好：
感谢您的电话接听。
根据您提供的信息，我谨在此阐述我们双方针对这个问题所涉及范围界定：
问题定义:
用户反馈CMGE系统下开启UWF保护机制，发现安全软件DLP的安全策略生效延迟，存在数据泄露风险，需要协助分析。
问题范围:
我们将协助您分析处理上述问题，并对定义的问题给予最大的技术支持。
如果能及时解决问题，或问题属于产品设计的行为，或问题涉及到三方，我们将考虑关闭案例。如果存在多个问题，则我们考虑拆分案例进行分析。
接下来，我们将开始合作解决这个问题。如果您对以上的问题范围界定有任何异议，请尽快告知。如果您有其他任何疑问。也欢迎随时与我联系。
请帮忙提供以下信息：
1）请您提供开启了UWF功能的设备具体型号。
2）请您在开启了UWF功能的设备上以管理员权限打开cmd命令行，执行以下命令，查看UWF配置，将显示的UWF配置内容复制保存到txt文档，并通过CDUC上传。
uwfmgr get-config
3）通过以下链接下载日志收集工具CMGELogCollectorV2.zip：
https://cduc.cmgos.com/download.php?id=771&token=QCEr0xQUk3ssFfnu5yuUtKrxpjOaSjSR
4）解压后运行CMGELogCollectorV2.exe，勾选所有选项，点击收集获取对应的系统日志，将生成的日志压缩包通过CDUC上传。
日志上传方法：
您可以登陆https://cduc.cmgos.com，通过数据上传系统上传您所收集的日志信息。
用户名：nonghangabc
密码：nonghangabc
注意：添加文件，点击上传后，跳转到新的页面点击保存。
========================================================================

====第2封邮件====

发件人：Wei Liang
发送时间：2023-01-12 17:13:03.890000+00:00
邮件内容:
赵女士 您好：
感谢您的电话接听。
日志已经收到，我会根据您这边的UWF配置情况做一些测试验证，有任何进展会及时与您联系沟通。

====第3封邮件====

发件人：Wei Liang
发送时间：2023-01-16 16:30:35.493000+00:00
邮件内容:
赵女士  您好：
感谢您的电话接听。
查看您这边设备的UWF覆盖设置类型为Disk：
在测试过程中发现UWF覆盖设置类型为Disk对磁盘性能有较大影响。为排除磁盘性能影响，请按照以下操作配置UWF覆盖设置类型为RAM，再次验证安全策略生效情况。
1）禁用UWF并重启计算机：
uwfmgr filter disable
2）重启计算机后，设置覆盖大小为当前设备内存大小的一半4096MB，覆盖类型为RAM，启用UWF，并重启计算机使UWF配置生效。
uwfmgr overlay set-size 4096
uwfmgr overlay set-type ram
uwfmgr filter enable
3）重启计算机后，验证安全策略情况。
您这边设备的UWF配置，建议“文件排除”策略不要包含“C:\Windows\System32\drivers”目录。

====第4封邮件====

发件人：Wei Liang
发送时间：2023-01-18 17:41:05.462000+00:00
邮件内容:
赵女士 您好：
感谢您的电话接听。
根据您的反馈，调整UWF的覆盖设置类型后，DLP的安全策略执行情况并没有改善。
为排除其他安全软件的影响，请您先只安装DLP应用，开启UWF，确认DLP安全策略执行情况，再逐步安装天擎、趋势等安全软件，排查此问题可能与哪些安全软件有关。
有相关测试结果后，请您在复现了DLP的安全策略执行缓慢问题的设备上，以管理员权限打开cmd命令行，执行fltmc命令，将输出的信息提供给我们。
fltmc

====第5封邮件====

发件人：Wei Liang
发送时间：2023-01-20 11:31:53.163000+00:00
邮件内容:
赵女士 您好：
感谢您的电话接听。
您可以让最终用户按照上一封的邮件说明进行相关测试，并将测试结果和收集的信息提供给我们。
如果针对当前案件还有需要我们帮助的地方, 欢迎随时联系我们。

====第6封邮件====

发件人：Wei Liang
发送时间：2023-01-29 15:32:44.819000+00:00
邮件内容:
赵女士 您好：
感谢您的电话接听。
请您与用户确认按照2023年1月18日的邮件说明排查应用情况，并将测试结果和收集的信息提供给我们。
如果针对当前案件还有需要我们帮助的地方, 欢迎随时联系我们。

====第7封邮件====

发件人：Wei Liang
发送时间：2023-01-31 16:56:26.783000+00:00
邮件内容:
赵女士 您好：
感谢您的电话接听。
我刚刚与您的同事张先生电话沟通了具体的测试情况，他会再次测试DLP、天擎以及趋势安全软件的安装与否，对开启UWF功能后DLP安全策略的影响。关于此问题，如果有任何进展会及时与您联系。
如果针对当前案件还有需要我们帮助的地方, 欢迎随时联系我们。

====第8封邮件====

发件人：Wei Liang
发送时间：2023-02-03 14:50:50.897000+00:00
邮件内容:
赵女士 您好：
昨天与您的同事张先生沟通了关于启用UWF功能后安全策略执行变慢问题的测试情况如下：
只安装一款安全软件并启用UWF功能后，都会出现安全策略生效变慢的问题，当再安装一款安全软件时，会导致安全策略生效所需时间更长。
今天联系了DLP厂商了解是否能提供试用版DLP软件进行测试，尝试复现问题，DLP厂商表示没有供单机测试使用的DLP应用版本。
针对此问题只能再查找其他方法尝试在测试环境中复现问题进行排查，我这边有任何进展会及时与您联系沟通。

====第9封邮件====

发件人：Wei Liang
发送时间：2023-02-13 15:11:21.981000+00:00
邮件内容:
赵女士 您好：
与您的同事张先生沟通确认无法提供对应的软件给神州网信进行测试复现问题，而且也无法将您那边的测试机系统转换成虚拟机提供给神州网信。
经过测试，请最终用户按照以下操作抓取登录系统后的procmon日志用于分析问题，具体操作如下：
1）以管理员权限打开cmd命令行，运行以下命令禁用UWF，并重启系统生效。
uwfmgr filter disable
2）重启系统关闭UWF后，运行gpedit.msc打开本地组策略编辑器，定位到：
“计算机配置”-“Windows设置”-“安全设置”-“本地策略”-“安全选项”中的策略“关机:清除虚拟内存页面文件”设置为“已禁用”
3）从以下链接下载procmon日志.zip文件，将其解压，保存到D:\logs\目录，其中包含以下几个文件。
https://cduc.cmgos.com/download.php?id=796&token=TCxhNVeripbIjbrIpHiHKIWFoAX0aEen
4）右键以管理员权限运行配置开机启动.bat，将procmon.bat脚本配置为“用户登录后自动运行”，脚本会自动退出。
5）以管理员权限打开cmd命令行，运行以下命令启用uwf，并重启系统生效。
uwfmgr filter enable
6）重启计算机并登录，出现cmd命令行运行procmon.exe可能会弹出“用户帐户控制”提示，选择“是”同意运行。
7）确认DLP安全策略经过较长时间生效后，右键以管理员权限运行D:\logs\stop.bat脚本停止procmon，将D:\logs\目录下uwf开头的文件压缩后通过CDUC上传。
8）再次禁用UWF功能后，重启计算机再次运行procmon.exe，策略生效后，右键以管理员权限运行D:\logs\stop.bat脚本停止procmon，此时获取DLP安全策略快速生效的procmon日志（D:\logs\目录下新的uwf开头的文件）压缩后上传。
注意：每次重启都会生成新的uwf文件，将旧的uwf文件覆盖。在运行stop.bat停止procmon后，及时复制对应的uwf文件并压缩。
日志上传方法：
您可以登陆https://cduc.cmgos.com，通过数据上传系统上传您所收集的日志信息。
用户名：nonghangabc
密码：nonghangabc
注意：添加文件，点击上传后，跳转到新的页面点击保存。

====第10封邮件====

发件人：Wei Liang
发送时间：2023-02-23 17:18:47.547000+00:00
邮件内容:
赵女士 您好：
与您的同事张先生沟通确认，按照以下操作再次抓取新的procmon日志和wpr etl日志，具体操作如下：
1）以管理员权限打开cmd命令行，运行以下命令禁用UWF，并重启系统生效。
uwfmgr filter disable
2）重启系统关闭UWF后，从以下链接下载wpr日志.zip文件，将其解压，保存到D:\logs\目录（相关文件已经更新，请清空原先的D:\logs\目录），其中包含以下几个文件。
https://cduc.cmgos.com/download.php?id=817&token=52WfMHzqXOXTtNZqSYyIBKHA6faj17mW
3）右键以管理员权限运行start.bat，将配置开机自动抓取procmon日志和wpr etl日志。
4）以管理员权限打开cmd命令行，运行以下命令启用uwf，并重启系统生效。
uwfmgr filter enable
5）重启计算机并登录，确认DLP安全策略经过较长时间生效后，右键以管理员权限运行D:\logs\stop.bat脚本停止日志收集，将D:\logs\目录下uwf.pml和uwf.etl的文件和uwf.etl.文件夹压缩后通过CDUC上传。
6）再次禁用UWF功能后，重启计算机确认策略生效后，右键以管理员权限运行D:\logs\stop.bat脚本停止日志收集，此时获取DLP安全策略快速生效的日志（D:\logs\目录下新的uwf.pml和uwf.etl的文件和uwf.etl.文件夹）压缩后上传。
注意：生成的日志文件比较大，每次重启都会生成新的uwf文件，将旧的uwf文件覆盖。在运行stop.bat停止日志收集后，及时复制对应的uwf文件并压缩。
日志上传方法：
您可以登陆https://cduc.cmgos.com，通过数据上传系统上传您所收集的日志信息。
用户名：nonghangabc
密码：nonghangabc
注意：添加文件，点击上传后，跳转到新的页面点击保存。
修改uwfs.sys驱动在fltmc中的高度方法：
1）以管理员权限打开cmd命令行，运行以下命令禁用UWF，并重启系统生效。
uwfmgr filter disable
2）运行regedit打开注册表编辑器，定位到：
HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\uwfs\Instances\uwfs
3）在注册表编辑器界面，修改右侧的Altitude键值设置为41000并保存（也可以根据fltmc查询显示的高度设置合适的数值）。
如果修改Altitude键值提示没有权限，右键点击uwfs选择权限，选择高级，更改所有者为administrators，并设置为完全控制权限，并保存，然后再修改Altitude键值。
4）再次右键点击uwfs选择权限，选择高级，添加一个主体everyone，类型为拒绝，点击显示高级权限，只勾选设置权限和删除，并保存确认。
5）开启UWF功能，重启计算机生效，以管理员权限打开cmd命令行，执行fltmc验证uwfs的高度情况。

====第11封邮件====

发件人：Wei Liang
发送时间：2023-02-27 15:16:27.943000+00:00
邮件内容:
张先生 您好：
针对您的环境中配置boot logging无法抓取对应日志的情况，重新修改了新的日志收集方法，具体操作如下：
1）以管理员权限打开cmd命令行，运行以下命令禁用UWF，并重启系统生效。
uwfmgr filter disable
2）重启系统关闭UWF后，运行gpedit.msc打开本地组策略编辑器，定位到：
“计算机配置”-“Windows设置”-“安全设置”-“本地策略”-“安全选项”中的策略“关机:清除虚拟内存页面文件”设置为“已禁用”
3）从以下链接下载proc.zip文件，将其解压，保存到D:\logs\目录，其中包含以下几个文件。
https://cduc.cmgos.com/download.php?id=823&token=gRWlHRZMNjHWUVbaAGLd2NjL4L3GYwmX
4）运行配置开机启动.bat，将proc.bat脚本配置为“用户登录后自动运行”，脚本会自动退出。
5）以管理员权限打开cmd命令行，运行以下命令启用uwf，并重启系统生效。
uwfmgr filter enable
6）重启计算机并登录，出现cmd命令行运行可能会弹出“用户帐户控制”提示，选择“是”同意运行。
7）确认DLP安全策略经过较长时间生效后，运行D:\logs\stop.bat脚本停止日志抓取，将D:\logs\目录下uwf开头的文件以及文件夹压缩后通过CDUC上传。
8）再次禁用UWF功能后，重启计算机再次运行proc.bat，策略生效后，运行D:\logs\stop.bat脚本停止日志抓取，此时获取DLP安全策略快速生效的proc和wpr日志（D:\logs\目录下新的uwf开头的文件以及文件夹）压缩后上传。
注意：每次重启都会生成新的uwf文件，将旧的uwf文件覆盖。在运行stop.bat停止后，及时复制对应的uwf文件和文件夹并压缩。

====第12封邮件====

发件人：Wei Liang
发送时间：2023-03-01 11:17:45.174000+00:00
邮件内容:
张先生 您好：
感谢您的回复，日志已经收到，有任何进展会及时与您联系沟通。

====第13封邮件====

发件人：Wei Liang
发送时间：2023-03-20 16:20:17.642000+00:00
邮件内容:
张先生 您好:
感谢您的电话接听。
麻烦您测试开启UWF功能且不进行文件排除配置时，是否也会出现DLP安全策略缓慢情况。
测试后请您以管理员权限打开cmd命令行，执行以下命令收集日志。
msinfo32 /nfo C:\SYSSUM.NFO /categories +systemsummary
将生成的日志C:\SYSSUM.NFO和系统日志文件夹C:\Windows\System32\winevt\Logs压缩后通过CDUC系统上传。
日志上传方法：
您可以登陆https://cduc.cmgos.com <https://cduc.cmgos.com/> ，通过数据上传系统上传您所收集的日志信息。
用户名：nonghangabc
密码：nonghangabc
注意：添加文件，点击上传后，跳转到新的页面点击保存。
