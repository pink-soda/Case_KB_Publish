邮件主题：回复: [案例号: CAS-10882-T7F5N8 ] % |P2|ICBC|工行用户反馈V2020-L版本系统安装KB5033371补丁失败（唐昊） % 初次响应 CMIT:0001715

====第1封邮件====

发件人：Wei Liang
发送时间：2024-02-22 16:28:36.798000+00:00
邮件内容:
许先生 您好：
感谢您的电话接听。
根据您提供的信息，我谨在此阐述我们双方针对这个问题所涉及范围界定：
问题定义:
工行反馈V2020-L系统安装补丁KB5033371失败，涉及到5-6台设备，需要协助排查。
问题范围:
我们将协助您分析处理上述问题，并对定义的问题给予最大的技术支持。
如果能及时解决问题，或问题属于产品设计的行为，或问题涉及到三方，我们将考虑关闭案例。如果存在多个问题，则我们考虑拆分案例进行分析。
接下来，我们将开始合作解决这个问题。如果您对以上的问题范围界定有任何异议，请尽快告知。如果您有其他任何疑问。也欢迎随时与我联系。
李彦龙的设备报错0x80071ab1，修复建议如下：
1）以管理员权限打开cmd命令行，运行如下命令：
fsutil resource setautoreset true c:\
chkdsk /f c:
2）重启计算机完成磁盘修复操作。
李小川的设备报错0x800f0922，可以尝试删除原先的EFI分区并重建新的EFI分区，再次验证是否可以正常安装补丁。具体的删除并重建EFI分区操作需要先与用户确定其没有特殊的启动项配置后，CMIT可以提供相关的创建EFI分区的操作方法。
针对更新报错为0x800f0985的杨金妹、唐昊、连晓英、姚述晨、许泽鹏的设备，可以进行以下操作，尝试校验操作系统组件情况后，及时使用日志收集工具收集CBS日志，尝试从日志中获取可能损坏的组件列表后 ，从其他的正常安装对应补丁的设备上复制相应的组件文件替换后，再次验证补丁安装情况。注意不同设备提示损坏的组件以及对应的组件版本不一致，需要针对每一台设备单独操作。收到替换相关组件后如果还是安装失败，建议重新安装对应的操作系统或者升级当前的操作系统到V2022-L版本。
1）以管理员身份运行命令提示符，运行如下命令：
sfc /scannow
dism /online /cleanup-image /scanhealth
2）使用日志收集工具收集日志并反馈。
具体排查情况如下：
李彦龙设备：
安装更新重启后，提示0x80071ab1错误。
查看具体的cbs日志，显示与创建hardlink文件时候出错有关。
涉及到hardlink操作，和ntfs文件系统有关，查看ntfs文件系统日志记录，有error 135错误。
杨金妹设备：
安装补丁报错提示：0x80073701，查询其错误描述为ERROR_SXS_ASSEMBLY_MISSING，与存储组件损坏或丢失有关。
查看对应的cbs日志已经被覆盖，无法查看到详细错误日志，但此设备上次也提交过另一个补丁安装失败的问题，也是同样的报错代码，涉及到一些组件包的manifest文件等。
唐昊设备：
在补丁安装过程中报错：0x800f0985，其错误描述为 PSFX_E_APPLY_REVERSE_DELTA_FAILED。
cbs日志中涉及的报错的组件为 Microsoft-Windows-UI-PCShell
连晓英设备：
cbs日志中涉及的报错的组件为 Microsoft-Windows-BootEnvironment-DVD-EFISYS
姚述晨设备：
cbs日志中涉及的报错的组件为 dual_bth.inf
李小川设备：
安装补丁完成，但是重启系统后应用更新错误，报错代码为0x800f0922，其错误描述为 CBS_E_INSTALLERS_FAILED
查看具体的cbs日志，日志显示与Boot File Servicing (BFSVC)有关。其安装失败后导致补丁回滚。
Boot File Servicing与EFI分区有关，可以尝试删除原先的EFI分区并重建新的EFI分区，再次验证是否可以正常安装补丁。
许泽鹏设备：
cbs日志中涉及的报错的组件为 dual_bth.inf

====第2封邮件====

发件人：Wei Liang
发送时间：2024-02-23 11:30:05.185000+00:00
邮件内容:
许先生 您好：
根据您新上传的岳宏达、崔雁博设备的日志，这两台设备都升级到了V2022-L版本。崔雁博设备报错与李彦龙设备出现同样错误，可以采用相同的修复方法。
岳宏达设备还是系统组件损坏或缺失问题，需要校验操作系统组件情况后，及时使用日志收集工具收集CBS日志，尝试从日志中获取可能损坏的组件列表后 ，从其他的正常安装对应补丁的设备上复制相应的组件文件替换后，再次验证补丁安装情况。操作建议如下：
崔雁博设备：
1）以管理员权限打开cmd命令行，运行如下命令：
fsutil resource setautoreset true c:\
chkdsk /f c:
2）重启计算机完成磁盘修复操作。
岳宏达设备：
1）以管理员身份运行命令提示符，运行如下命令：
sfc /scannow
dism /online /cleanup-image /scanhealth
2）及时使用日志收集工具收集日志并反馈。
具体分析如下：
岳宏达设备：
更新报错代码为0x8007000d
在cbs日志中查找对应时间点的日志，显示与Microsoft-Windows-SnippingTool-App、Microsoft-Windows-Lxss-Manager等组件的文件损害或缺失有关。
崔雁博设备：
安装更新重启后，提示0x80071ab1错误。
查看具体的cbs日志，显示与创建hardlink文件时候出错有关。
涉及到hardlink操作，和ntfs文件系统有关，查看ntfs文件系统日志记录，有error 135错误。

====第3封邮件====

发件人：Wei Liang
发送时间：2024-02-26 11:31:58.834000+00:00
邮件内容:
许先生 您好：
感谢您的电话接听。
李艳、王盼设备的日志分析和测试建议如下：
李艳设备：
安装更新补丁时报错0x80073712，此错误表示组件存储库已经损坏。
查看cbs日志也是直接提示由于损坏的manifest文件，将存储库标记为损坏。
查看系统日志，有ntfs文件系统错误。
建议操作：
1）以管理员权限打开cmd命令行，执行 chkdsk /f c:  按照提示操作，重启设备修复ntfs文件系统。
2）重启设备修复ntfs文件系统后，以管理员权限打开cmd命令行，执行 sfc /scannow  尝试修复系统组件。
3）sfc命令运行完成后，尝试再次安装补丁验证是否可以正常安装。
王盼设备：
是V2022-L系统，安装KB5033372完成，并重启设备应用补丁失败报错0x80070005（拒绝访问），补丁回滚。
查看cbs日志显示是操作驱动cpu.inf导致accessdenied，需要进一步收集日志排查出现accessdenied问题原因。
在系统日志中有ntfs系统问题警告和devmgr服务启动失败错误，devmgr是TMS的服务。
建议操作：
1）以管理员权限运行命令 chkdsk /f c: 检查、修复ntfs文件系统问题。
3）devmgr是TMS的服务，此时这个服务出现问题，建议先暂时卸载TMS安全软件。
4）在安装补丁后重启设备出现补丁回滚的情况，需要按照以下操作收集procmon boot logging 日志和wpr日志。
1. 正常安装完成KB5033372，暂时不重启。
2. 运行procmon.exe，选中options->Enable Boot Logging：
3. 配置Boot Logging选项：
4. 运行wprui.exe，按照下图所示配置，即勾选“First level triage”、“CPU usage”、“File I/O activity”、 “Registry I/O activity”、“Handle usage”、“Minifilter I/O activity”后，配置Performance scenario 为Boot，Number of iterations为 1
5. 点击“Start”后，选择保存路径，然后点击“Save”，会提示重启设备。
6. 重启设备复现补丁回滚问题，设备启动后，及时运行procmon.exe，会弹出窗口提示boot log日志已经收集，请点击Yes保存，并将文件存储到为boot_log.pml，将此日志压缩后上传。
7. 将保存的wpr ETL日志C:\trace.etl压缩后上传。

====第4封邮件====

发件人：Wei Liang
发送时间：2024-02-27 15:49:16.569000+00:00
邮件内容:
许先生 您好：
针对唐昊的设备，请您尝试按照以下操作修复系统组件后，再次验证安装KB5033371补丁是否成功。
1）以管理员身份运行命令提示符，运行如下命令：
sfc /scannow
2）从以下链接下载cbs日志中提示报错的组件文件，解压后以管理员权限运行 替换组件.bat 脚本。
   https://cduc.cmgos.com/download.php?id=1275&token=bL0gPJYXFHOtgyWSnyBodmgThNDsaZcC
3）再次离线安装KB5033371补丁，验证是否能够正常安装。如果还是安装失败，请使用CMGE日志收集工具收集日志并反馈。

====第5封邮件====

发件人：Wei Liang
发送时间：2024-02-29 17:19:33.044000+00:00
邮件内容:
许先生 您好：
感谢您的电话接听。
请您与最终用户沟通，手动替换系统组件后，再次安装KB5033371更新补丁是否成功。
如果有任何进展或疑问可以回复此邮件。

====第6封邮件====

发件人：Wei Liang
发送时间：2024-03-04 15:12:59.770000+00:00
邮件内容:
许先生 您好：
感谢您的电话接听。
请您与最终用户确认，再次安装KB5033371更新补丁是否成功。
如果有任何进展或疑问可以回复此邮件。

====第7封邮件====

发件人：Wei Liang
发送时间：2024-03-04 16:32:09.426000+00:00
邮件内容:
许先生 您好：
确认您的问题已经解决，我将归档此案例。
工单的归档并不会影响我们为您提供技术支持服务，如有其他问题，您可以随时联系我们。
案例总结：
----
问题定义：
工行反馈V2020-L系统安装补丁KB5033371失败（唐昊），需要协助排查。
问题总结：
以管理员权限运行 sfc /scannow 命令，并从正常设备上获取问题设备上出错的系统组件文件并手动替换，再次验证安装KB5033371补丁成功，案例关闭。
以上，如您后续有任何问题，可随时与我们联系，谢谢。
