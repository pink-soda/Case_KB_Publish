邮件主题：回复: 回复:【外来邮件，注意核实】回复: [案例号: CAS-05219-P5W5M3 ] % |P2|ICBC|分行安装补丁后调整TMS分组蓝屏协助分析 % 初次响应 CMIT:0001357

====第1封邮件====

发件人：Wei Liang
发送时间：2021-12-01 11:22:10.610000+00:00
邮件内容:
邓先生 您好：
根据刚才的电话沟通，我谨在此阐述我们双方针对这个问题所涉及范围界定：
问题定义:
工行云南行一体机安装11月补丁，调整TMS分组后，出现蓝屏问题。
问题范围:
我们将协助您分析处理上述问题，并对定义的问题给予最大的技术支持。
如果能及时解决问题，或问题属于产品设计的行为，或问题涉及到三方，我们将考虑关闭案例。如果存在多个问题，则我们考虑拆分案例进行分析。
接下来，我们将开始合作解决这个问题。如果您对以上的问题范围界定有任何异议，请尽快告知。如果您有其他任何疑问。也欢迎随时与我联系。
在出现蓝屏重启后，默认会在系统文件夹Window目录下生成MEMORY.DMP文件，如没有生成对应的dmp文件，请您在出现蓝屏前，按照以下方式配置蓝屏自动生成dmp文件。
1）右键点击此电脑，然后点击属性。
2）点击控制面板下面的高级系统设置。
3）在“系统属性“下面的”启动和故障恢复“里面，选择”设置“。
4)在“启动和故障恢复“界面内的”写入调试信息“部分，点击下拉菜单选择”完全内存转储“
将转储文件改为其他本地磁盘，例如D:\MEMORY.DMP，因为完全内存转储所需的空间较大，为当前计算机的内存大小。
当再次出现蓝屏的时候，等待生成dump文件。
基于您所说出现蓝屏后，无法进入系统，只能通过PE复制文件，请您复制以下文件：
通过PE进入系统后，访问操作系统分区，复制相关文件。
1）复制Windows目录下的MEMORY.DMP文件。
2）复制Windows\System32\winevt\Logs目录下的所有文件。
将对应的文件压缩，请麻烦 @吴毓杰 <mailto:win10sup@sdc.icbc.com.cn>  帮忙上传到sftp服务器。

====第2封邮件====

发件人：Wei Liang
发送时间：2021-12-01 11:38:07.286000+00:00
邮件内容:
邓先生 您好：
按照您提供的邮箱再发送一次，请您查收。

====第3封邮件====

发件人：Wei Liang
发送时间：2021-12-01 15:22:49.328000+00:00
邮件内容:
邓先生 您好：
请您使用Filezilla软件，使用以下账户信息登入神州网信网站上传dump日志。 
Filezilla client端下载URL：https://filezilla-project.org/download.php?type=client 
登陆地址：sftp://ocean.cmgos.com 
用户名为：ICBC（区分大小写） 
密码：2qfs52ninbFB
端口：22222
登陆之后，导航至/upload/，新建一个新文件夹重命名为TMS分组蓝屏，再上传dump日志。

====第4封邮件====

发件人：Wei Liang
发送时间：2021-12-02 15:52:14.112000+00:00
邮件内容:
邓先生 您好：
感谢您的电话接听。
当前dump显示蓝屏问题由蓝牙驱动RtkBtfilter.sys引起。相关分析情况如下：
dump的bugcheck code为7e，详细异常代码为0xc0000005，这表示发生了内存访问冲突。
查看出问题的call stack，在第8帧这里出现问题，抛出异常导致蓝屏。
第8帧的Wdf01000是系统提供的为基于框架的驱动程序的运行库，查看当前是哪个驱动使用了Wdf01000。查看第8帧的具体信息。
看到第8帧访问到了无效的内存，查看其 _FX_DRIVER_GLOBALS
查找其对应的FxDriver
查看RtkBtfilter具体信息
RtkBtfilter.sys是RealTek的蓝牙驱动，这个驱动是2019年的版本。
两个dump显示问题都是RtkBtfilter.sys引起。蓝屏问题在调整TMS分组后出现，请您确认TMS相关配置并进行一些测试：
1)       确认新的TMS分组对蓝牙设备的安全策略管控情况。
2)       其他未出现蓝屏问题的计算机是否有蓝牙设备？如果有蓝牙，蓝牙设备的生产厂家是什么，如RealTek还是Intel，对应的蓝牙驱动版本是多少。
3)       已经出现蓝屏的一体机，请您使用PE进入操作系统分区删除蓝牙驱动RtkBtfilter.sys，验证设备是否正常运行。（操作系统分区目录\windows\system32\drivers\RtkBtfilter.sys）。
4)       请您测试删除蓝牙驱动RtkBtfilter.sys后，再加入新的TMS分组是否出现蓝屏。（C:\windows\system32\drivers\RtkBtfilter.sys）。

====第5封邮件====

发件人：邓凯
发送时间：2021-12-07 11:23:15.298000+00:00
邮件内容:
两个dump显示问题都是RtkBtfilter.sys引起。蓝屏问题在调整TMS分组后出现，请您确认TMS相关配置并进行一些测试：
1)       确认新的TMS分组对蓝牙设备的安全策略管控情况。
2)       其他未出现蓝屏问题的计算机是否有蓝牙设备？如果有蓝牙，蓝牙设备的生产厂家是什么，如RealTek还是Intel，对应的蓝牙驱动版本是多少。
3)       已经出现蓝屏的一体机，请您使用PE进入操作系统分区删除蓝牙驱动RtkBtfilter.sys，验证设备是否正常运行。（操作系统分区目录
1)需要咨询中心安全部门，分行不知晓策略详细内容。
2）找了几台设备，包括笔记本和老型号一体机，目前看来蓝牙均为intel，蓝牙驱动显示为损坏状态。
3）使用PE删除驱动后设备可正常运行，但域用户丢失，只剩ICBC用户。
	-----原始邮件-----
	
====第6封邮件====

发件人：Wei Liang
发送时间：2021-12-07 15:24:09.923000+00:00
邮件内容:
邓先生 & 吴先生 你们好：
感谢电话接听。
此次电话沟通情况总结如下：
1)       行内禁止使用电脑蓝牙设备，但是未确认新的TMS分组具体安全策略管控信息。
2)       查看了几台未出现蓝屏问题的计算机，其蓝牙设备厂家均是Intel，蓝牙驱动显示为损坏状态。
3)       出现蓝屏的计算机，使用PE删除蓝牙驱动RtkBtfilter.sys，可以正常运行，但域用户丢失，只剩ICBC用户。
通过日志分析和实际测试情况，判断新的TMS分组策略与三方驱动RtkBtfilter.sys兼容性问题导致蓝屏，有如下建议：
1)       禁用蓝牙设备，并删除蓝牙驱动RtkBtfilter.sys。
2)       请TMS厂商协助分析与蓝牙驱动RtkBtfilter.sys兼容性问题。
您所说的删除蓝牙设备后，出现域用户丢失的问题，请您下载附件中的CMGELogCollector.zip，解压后运行，勾选全部选项，点击“收集”，运行几分钟后会在桌面生成日志压缩包。
将上述操作收取的日志上传到sftp服务器，我们会尝试分析域用户丢失问题。

====第7封邮件====

发件人：Wei Liang
发送时间：2021-12-07 16:13:39.297000+00:00
邮件内容:
附件的日志收集工具，请查收。

====第8封邮件====

发件人：Wei Liang
发送时间：2021-12-10 15:33:59.465000+00:00
邮件内容:
吴先生 您好：
感谢您的电话接听。
根据刚才的沟通情况，我将暂时归档此案例。
工单的归档并不会影响我们为您提供技术支持服务，如您有其他问题，您可以致电技术支持热线4008180055。
案例总结：
----
问题定义：
工行云南行一体机安装11月补丁，调整TMS分组后，出现蓝屏问题。
问题总结：
dump分析和相关测试验证，确认蓝牙驱动RtkBtfilter.sys引起蓝屏问题，删除RtkBtfilter.sys驱动可以正常启动设备。
问题分析：
当前dump显示蓝屏问题由蓝牙驱动RtkBtfilter.sys引起。相关分析情况如下：
dump的bugcheck code为7e，详细异常代码为0xc0000005，这表示发生了内存访问冲突。
查看出问题的call stack，在第8帧这里出现问题，抛出异常导致蓝屏。
第8帧的Wdf01000是系统提供的为基于框架的驱动程序的运行库，查看当前是哪个驱动使用了Wdf01000。查看第8帧的具体信息。
看到第8帧访问到了无效的内存，查看其 _FX_DRIVER_GLOBALS
查找其对应的FxDriver
查看RtkBtfilter具体信息
RtkBtfilter.sys是RealTek的蓝牙驱动，这个驱动是2019年的版本。
处理建议：
通过日志分析和实际测试情况，判断新的TMS分组策略与三方驱动RtkBtfilter.sys兼容性问题导致蓝屏，有如下建议：
1)       禁用蓝牙设备，并删除蓝牙驱动RtkBtfilter.sys，或者请硬件设备厂商提供新的蓝牙驱动RtkBtfilter.sys验证运行情况。
2)       请TMS厂商协助分析与蓝牙驱动RtkBtfilter.sys兼容性问题。
以上，如您后续有任何问题，可随时与我们联系，谢谢。
