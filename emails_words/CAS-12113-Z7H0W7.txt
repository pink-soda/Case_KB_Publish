邮件主题：回复: [案例号:CAS-12113-Z7H0W7] %|P2|ICBC|工行用户反馈V2022-L版本系统安装8B补丁报错问题-王学睿% 案例重新分配 CMIT:0001275

====第1封邮件====

发件人：Li Qi
发送时间：2024-09-05 16:53:08.070000+00:00
邮件内容:
Hi，team：
应客户要求，请帮忙将案例CAS-12113-Z7H0W7 “|P2|ICBC|工行用户反馈V2022-L版本系统安装8B补丁报错问题-王学睿”
按如下标题再拆分1个case：
用户反馈安装8B补丁失败问题，报错为：0x80071ab1

====第2封邮件====

发件人：Li Qi
发送时间：2024-09-06 09:50:21.814000+00:00
邮件内容:
许先生，您好：
如昨天电话沟通，我谨以此封邮件阐述我们双方针对这个问题所涉及范围界定： 
问题定义: 
用户反馈V2022-L版本系统安装8B补丁报错问题，涉及1台设备，需要协助分析处理。
问题范围: 
我们将协助您分析处理上述问题，并对定义的问题给予最大的技术支持。 
如果能及时解决问题，或问题属于产品设计的行为，或问题涉及到三方，我们将考虑关闭案例。如果存在多个问题，则我们考虑拆分案例进行分析。 
接下来，我们将开始合作解决这个问题。如果您对以上的问题范围界定有任何异议，请尽快告知。如果您有其他任何疑问。也欢迎随时与我联系。 
下一步动作：
用户当前的系统版本小版本号为17763.2114,对应补丁为21年8月的KB5005030,用户当前安装的补丁如下：
       8月补丁安装所需的前置补丁KB5005112也已经正常安装。从当前问题来看，应有部分补丁未正常安装导致此次8月累计更新安装失败。因此建议将当前系统中已显示安装的其余补丁尝试卸载后，恢复至系统的干净状态后再尝试安装，具体方法如下：
1.	优先卸载安装日期在2024年的所有补丁，包括
*  KB5037932
*  KB5034863
*  KB5035963
*  KB5037017
*  KB5040563
*  KB5041577
2.	以管理员身份打开cmd命令行，执行Dism /Online /Get-Packages | find "KB号"，获取程序包标识符
3.	再执行Dism /Online /Remove-Package /PackageName:程序包标识符 /quiet /norestart
4.	逐一卸载之后，可以通过如下命令确认当前系统安装补丁状态：Dism /Online /Get-Packages >c:\package\list\pkg.txt
5.	卸载之后再次尝试执行补丁安装，建议使用离线安装8月补丁，下载地址如下：https://support.cmgos.com/kb/5041578

====第3封邮件====

发件人：Li Qi
发送时间：2024-10-24 14:27:04.327000+00:00
邮件内容:
许先生，您好：
我刚才和王先生取得了联系，目前仍然没有安装成功8月补丁，用户表示在卸载已安装补丁时仍然存在问题，建议让用户提供卸载失败的截图，同时请指导用户再次安装8月补丁，并记录安装时间点，收集CMGECollector日志，务必额外勾选“升级日志”，方法如下：
下载链接：https://cduc.cmgos.com/download.php?id=1479&token=m1qgs2Xwo3hXokAIJvWUpJHeffUlC0Gg <https://cduc.cmgos.com/download.php?id=1479&token=m1qgs2Xwo3hXokAIJvWUpJHeffUlC0Gg> 
运行CMGELogCollector.exe，额外勾选“升级日志”，点击“收集”，运行几分钟后会在桌面生成日志压缩包，将日志上传到CDUC。
收集完毕后将在当前用户桌面生成CMGE_Log。点击确定，将直接打开文件夹并指定为压缩文件
您可以登陆https://cduc.cmgos.com <https://cduc.cmgos.com/> ，通过数据上传系统上传您所收集的日志信息 
用户名：ICBC001

====第4封邮件====

发件人：Li Qi
发送时间：2024-11-20 16:54:04.048000+00:00
邮件内容:
许先生，您好：
有关王学睿先生补丁安装失败的日志分析，我整理了相关两次上传日志的分析结果，请参照如下内容：
问题背景：由于在client端存在多次不同补丁安装失败的异常状态，导致无法安装最新的累计更新。
问题现象：在安装最新累计更新时，client端重启过程中出现错误导致rollback进而补丁安装失败。
问题分析：结合日志来看，错误发生在补丁安装的客户端重启阶段，这一阶段主要由poqexec来操作，也就是在系统运行状态时安装被pending的补丁相关内容。最终poqexec执行失败，导致补丁安装的失败。而造成poqexec执行失败的原因是多样的，两次日志也体现在了执行的不同过程中。
11-02的日志中：
09-04的日志中：
从上述两个日志来看，导致poqexec failure的错误有0x80070005 - E_ACCESSDENIED，也有0x80070002 - ERROR_FILE_NOT_FOUND，而造成这些错误的背后原因也可能有多个，诸如：相关服务被禁用，操作文件未找到，驱动文件异常且无法替换，组件缺失等等，其中两个日志中均提到的failure共同点是Driver’Update’Uninstall’Updates failed，指向的是cpu.inf，我这里列了几个怀疑方向，供后续尝试：
1.	检查是否存在c:\windows\logs\homegroup文件夹，我查看了正常的系统中并不存在此文件夹，请您查看下您的电脑上是否存在，然后先备份一下。
2.	请下载以下链接的压缩包，解压至本地后，以管理员身份执行start.bat脚本，这将启动必要的服务，删除以往的安装缓存及补丁状态和session记录，同时删除1的homegroup文件夹
https://cduc.cmgos.com/download.php?id=1682&token=j8qXE1mKOHE5kMegvr66Pp2k5NRwuzs6
3.	以管理员身份执行sfc /scannow，系统会自动检查补丁完整性
4.	重启电脑
5.	安装累计更新
如果上述仍然安装失败，则另外一个可能就是驱动需要更新，首先使用如下方法查看：
*  打开设备管理器 (devmgmt.msc)，找到处理器，切换到设备属性-详细信息，查看 “设备类 GUID”是否为f1aab1ba-6ee0-4d94-baeb-c9fd61f365cf
*  或者可以打开注册表编辑器（regedit），搜索“f1aab1ba-6ee0-4d94-baeb-c9fd61f365cf”，看是否可以定位是什么设备
如可以定位具体设备，可以更新该设备驱动程序，如无法定位请至官网下载对应机器型号的最新驱动进行更新，待更新驱动后，再次尝试安装累积更新补丁。

====第5封邮件====

发件人：Li Qi
发送时间：2024-11-20 17:04:16.388000+00:00
邮件内容:
许先生，您好：
有关王学睿先生补丁安装失败的日志分析，我整理了相关两次上传日志的分析结果，请参照如下内容：
问题背景：由于在client端存在多次不同补丁安装失败的异常状态，导致无法安装最新的累计更新。
问题现象：在安装最新累计更新时，client端重启过程中出现错误导致rollback进而补丁安装失败。
问题分析：结合日志来看，错误发生在补丁安装的客户端重启阶段，这一阶段主要由poqexec来操作，也就是在系统运行状态时安装被pending的补丁相关内容。最终poqexec执行失败，导致补丁安装的失败。而造成poqexec执行失败的原因是多样的，两次日志也体现在了执行的不同过程中。
11-02的日志中：
09-04的日志中：
从上述两个日志来看，导致poqexec failure的错误有0x80070005 - E_ACCESSDENIED，也有0x80070002 - ERROR_FILE_NOT_FOUND，而造成这些错误的背后原因也可能有多个，诸如：相关服务被禁用，操作文件未找到，驱动文件异常且无法替换，组件缺失等等，其中两个日志中均提到的failure共同点是Driver’Update’Uninstall’Updates failed，指向的是cpu.inf，我这里列了几个怀疑方向，供后续尝试：
1.	检查是否存在c:\windows\logs\homegroup文件夹，我查看了正常的系统中并不存在此文件夹，请您查看下您的电脑上是否存在，然后先备份一下。
2.	请下载以下链接的压缩包，解压至本地后，以管理员身份执行start.bat脚本，这将启动必要的服务，删除以往的安装缓存及补丁状态和session记录，同时删除1的homegroup文件夹
https://cduc.cmgos.com/download.php?id=1682&token=j8qXE1mKOHE5kMegvr66Pp2k5NRwuzs6
3.	以管理员身份执行sfc /scannow，系统会自动检查补丁完整性
4.	重启电脑
5.	安装累计更新
如果上述仍然安装失败，则另外一个可能就是驱动需要更新，首先使用如下方法查看：
*  打开设备管理器 (devmgmt.msc)，找到处理器，切换到设备属性-详细信息，查看 “设备类 GUID”是否为f1aab1ba-6ee0-4d94-baeb-c9fd61f365cf
*  或者可以打开注册表编辑器（regedit），搜索“f1aab1ba-6ee0-4d94-baeb-c9fd61f365cf”，看是否可以定位是什么设备
如可以定位具体设备，可以更新该设备驱动程序，如无法定位请至官网下载对应机器型号的最新驱动进行更新，待更新驱动后，再次尝试安装累积更新补丁。

====第6封邮件====

发件人：Li Qi
发送时间：2024-11-26 10:48:50.959000+00:00
邮件内容:
许先生，您好：
刚才与王学睿先生联系了一下，目前他需要尝试下离线安装补丁，但是目前他并没有办法获取到补丁，请帮忙下载如下两个补丁，并发送给他供他测试，另外请查看下WSUS端他的状态是否异常状态仍然存在，谢谢
下载链接：
https://support.cmgos.com/kb/5014699
https://support.cmgos.com/kb/5043064

====第7封邮件====

发件人：Li Qi
发送时间：2024-12-03 15:08:33.490000+00:00
邮件内容:
许先生，您好：
请指导王先生执行如下操作，并将收集日志文件发送给我，谢谢。
请先下载如下补丁：https://support.cmgos.com/kb/5046615
执行命令行方式安装，以管理员身份执行如下命令：
dism /Add-Package /PackagePath:“替换为KB5046615的本地存放路径”
并将安装结果告知，谢谢
之后收集如下内容：
1、在故障机器上以管理员身份运行如下命令，并上传txt文件（如果机器上无法运行此命令，则请忽略这一步）：
dism /online /Get-Packages /Format:Table >C:\hotfix.txt
2、将问题机器上的C:\windows\system32\config下的component.hive文件上传：
3、打开注册表，导航到如下路径，并右键导出保存为hive文件：
Computer\HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Component Based Servicing

====第8封邮件====

发件人：Li Qi
发送时间：2024-12-12 16:38:15.296000+00:00
邮件内容:
许先生，您好：
如刚才电话沟通，经与用户确认，用户重装系统以解决此问题，因此当前case暂做归档处理，以下为案例总结：
Case No：CAS-12113-Z7H0W7
问题描述：
=================
用户反馈V2022-L版本系统安装8B补丁报错问题，需要协助分析处理。
问题分析：
=================
从用户几次上传的日志来看，当前系统的补丁安装情况如下：
17763.2114（KB5005030）和17763.774（KB4516077）已经被替代，17763.5329（24年1B KB5034127）状态为Absent，17763.6293（24年9B KB5043050）状态为pending install
用户几次补丁安装失败均是在最新补丁安装时出现，也就是pending install状态的补丁，之前一直尝试的操作是希望可以清除当前系统的补丁安装异常状态，但删除后问题依然复现，因此只能排查当前补丁安装过程中pending的原因，由于发生在系统重启阶段，常规日志中并未发现具体报错信息，因此需要尝试收集procmon的boot logging日志。
目前日志中仍然怀疑的一个可能点是：AppX Deployment Service (AppXSVC)和App Readiness服务是否能正常启动运行，确保补丁在安装时两个服务处于running状态。
案例总结：
=================
经用户确认，由于用户决定重装系统解决此问题，因此后续日志不再收集，此case做归档处理。如后续有其他问题需求，可随时与我联系，谢谢
