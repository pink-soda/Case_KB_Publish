邮件主题：回复: 回复：回复: [案例号: CAS-09903-Z2V6L2 ] % |P2|ICBC|win10异常蓝屏需要分析 % 初次响应 CMIT:0001387

====第1封邮件====

发件人：Wei Liang
发送时间：2023-09-19 17:54:20.982000+00:00
邮件内容:
许先生 您好：
感谢您的电话接听。
根据您提供的信息，我谨在此阐述我们双方针对这个问题所涉及范围界定：
问题定义:
用户反馈林总的设备在公网环境下连接vpn出现异常蓝屏问题，需要协助分析。
问题范围:
我们将协助您分析处理上述问题，并对定义的问题给予最大的技术支持。
如果能及时解决问题，或问题属于产品设计的行为，或问题涉及到三方，我们将考虑关闭案例。如果存在多个问题，则我们考虑拆分案例进行分析。
接下来，我们将开始合作解决这个问题。如果您对以上的问题范围界定有任何异议，请尽快告知。如果您有其他任何疑问。也欢迎随时与我联系。
出现蓝屏问题的设备的dump文件已经下载并尝试分析，如有任何进展，会及时与您沟通，谢谢。

====第2封邮件====

发件人：Wei Liang
发送时间：2023-09-20 14:45:18.336000+00:00
邮件内容:
许先生 您好：
分析您提供的dump文件，显示由于bugcheck代码为0xa（IRQL_NOT_LESS_OR_EQUAL），这个错误检查是由使用不适当地址的内核模式设备驱动程序引起的。这个错误检查表明，在提高中断请求级别（IRQL）时，有人试图访问一个无效的地址。
发生了0xa的蓝屏，是由于读取了IRQL比较高的地址触发的。
查看出故障时的指令指针以及irql情况。
查看trap frame情况，显示访问了无效的内存地址。
查看出问题时的call stack情况，显示netmgr.sys驱动触发了DbgPrint操作，最终导致蓝屏。
查看netmgr.sys文件情况。
该文件位置为：C:\Windows\System32\Drivers\netmgr.sys。为2023年6月版本。
对比以前的案例情况，确认它是TMS的组件，需要三方应用厂商排查处理这个问题。

====第3封邮件====

发件人：Wei Liang
发送时间：2023-09-22 16:17:25.282000+00:00
邮件内容:
许先生 您好：
感谢您的电话接听。
经过您的确认，我将归档此案例。
工单的归档并不会影响我们为您提供技术支持服务，如有其他问题，您可以随时联系我们。
案例总结：
----
问题定义：
用户反馈林总的设备在公网环境下连接vpn出现异常蓝屏问题，需要协助分析。
问题总结：
通过分析蓝屏dump，显示netmgr.sys驱动触发了DbgPrint操作导致的蓝屏，需要netmgr排查其调用DbgPrint函数的方法。
netmgr.sys是TMS的组件，需要三方应用厂商排查、处理其驱动问题。
以上，如您后续有任何问题，可随时与我们联系，谢谢。

====第4封邮件====

发件人：Soul power ギ
发送时间：2023-09-28 10:05:55.786000+00:00
邮件内容:
工程师，我行林总的电脑在vpn场景下持续蓝屏，请再次分析问题原因。
________________________________
<https://wx.mail.qq.com/home/index?t=readmail_businesscard_midpage&nocheck=true&name=Soul+power+%E3%82%AE&icon=http%3A%2F%2Fthirdqq.qlogo.cn%2Fg%3Fb%3Doidb%26k%3DkWKvleptVSFL0k995Sp4SA%26kti%3DZM4hPQAAAAE%26s%3D640%26t%3D1556475341&mail=303642690%40qq.com&code=5XMK68WeTIkwBkEiM8xOzK-PRimSP4jqcugd2Y__YybNNa07Tzc73Qpbn5t6vmnVVL6TVwUdhptvWKYIIS31PA> 
 <http://thirdqq.qlogo.cn/g?b=oidb&k=kWKvleptVSFL0k995Sp4SA&kti=ZM4hPQAAAAE&s=640&t=1556475341> 
Soul power ギ
303642690@qq.com
--- 原始邮件 ---

====第5封邮件====

发件人：Wei Liang
发送时间：2023-09-28 15:40:09.994000+00:00
邮件内容:
许先生  您好：
感谢您的电话接听。
分析您提供的最新dump文件，显示由于bugcheck代码为0xa（IRQL_NOT_LESS_OR_EQUAL），这个错误检查是由使用不适当地址的内核模式设备驱动程序引起的。这个错误检查表明，在提高中断请求级别（IRQL）时，有人试图访问一个无效的地址。
发生了0xa的蓝屏，是由于读取了IRQL比较高的地址触发的。
查看出故障时的指令指针以及irql情况。
查看trap frame情况，显示访问了无效的内存地址。
查看出问题时的call stack情况，显示netmgr.sys驱动触发了strstr操作。
netmgr 试图在一个http的网络连接地址的string里面查找http/1.1的string。
这个网络连接的string所在的地址有special pool的保护，系统捕捉到这个异常触发蓝屏。
注：所谓special pool的工作原理，可以通俗理解为，在相关组件的内存块上下增加了用户监控的nonpaged pool内存，如果有人触及这段内存，就会直接触发蓝屏，得到问题发生现场的dump。special pool容易暴露不太好的驱动的bug。
林总这台设备在以前处理蓝屏问题时开启过special pool，针对ndis.sys、netmgr.sys、vwifimf.sys和nwifi.sys驱动开启了驱动程序验证。
中断请求级别 （IRQL） 定义处理器在任何给定时间运行的硬件优先级。在 Windows 驱动程序模型中，以较高 IRQL 运行的进程将抢占以较低 IRQL 运行的线程或中断。IRQL 为 0 表示处理器正在运行正常的内核或用户模式进程。IRQL 为 1 表示处理器正在运行异步过程调用 （APC） 或页面错误。IRQL 2 用于延迟过程调用 （DPC） 和线程调度。IRQL 2 被称为DISPATCH_LEVEL。
在DISPATCH_LEVEL这个级别，DPC(延迟过程) 和更低的中断被屏蔽，不能访问分页内存，所有的被访问的内存不能分页。在这个级别，能够访问的api大大减少。
下一步建议：
1）以管理员权限打开cmd命令行，运行verifier.exe，暂时关闭驱动程序验证工具，减少触发驱动的潜在问题的可能。
2）需要netmgr.sys驱动的三方应用厂商排查其驱动，处理其对应的IRQL级别使用。

====第6封邮件====

发件人：Wei Liang
发送时间：2023-09-28 16:19:12.413000+00:00
邮件内容:
许先生 您好：
分析您提供的最新的dump文件，它错误代码为0x7e，指系统线程生成了错误处理程序未捕获的异常。
具体分析如下：
报错代码为0x7e，第一个错误参数为c000005，它表示 STATUS_ACCESS_VIOLATION，发生了内存访问冲突。
发生错误检查的原因是，系统线程中抛出异常，任何给定的异常处理程序都无法处理该异常。检查call stack，可以看到操作系统正在初始化一个系统线程。
从 call stack中可以看到是IntcDAud触发了系统蓝屏。
再查看报错的几个参数，可以看到似乎异常是由驱动程序尝试使用完全无效的内存地址执行调用指令引起的。
使用 .exr 命令和错误检查的第三个参数的值转储该错误。
异常记录直接对应于在call stack中找到的内容。驱动程序 IntcDAud.sys 引用了前面显示的相同无效内存地址，这导致引发访问冲突错误。
IntcDAud.sys是系统的音频驱动程序，其是2018年的驱动，建议升级音频驱动程序。
下一步建议：
dump日志显示是音频驱动程序导致的蓝屏，建议在设备厂商官网更新最新的音频驱动后，观察是否再次出现蓝屏问题。

====第7封邮件====

发件人：Wei Liang
发送时间：2023-10-09 14:12:24.634000+00:00
邮件内容:
许先生 您好：
刚刚给您的电话没有接通。
来信是想了解近期林总设备是否再次出现蓝屏问题，关于此案例是否仍有疑问？
如果有任何进展或疑问可以回复此邮件。

====第8封邮件====

发件人：Wei Liang
发送时间：2023-10-10 15:55:23.689000+00:00
邮件内容:
许先生 您好：
感谢您与TAM确认这个案例可以关闭，我将归档此案例。
工单的归档并不会影响我们为您提供技术支持服务，如有其他问题，您可以随时联系我们。
案例总结：
----
问题定义：
用户反馈林总的设备在公网环境下连接vpn出现异常蓝屏问题，需要协助分析。
问题总结：
通过分析提供的蓝屏dump，显示netmgr.sys驱动触发了系统蓝屏，netmgr.sys是TMS的组件，需要三方应用厂商排查、处理其驱动问题。
还有一次蓝屏显示是音频总线驱动IntcDAud.sys触发的蓝屏，此驱动程序是2018年的版本，建议通过硬件设备厂商官网下载更新最新的音频总线驱动程序。
此设备在以前处理蓝屏问题时，开启了special pool功能，开启special pool容易暴露不太好的驱动的bug。可以通过以下操作关闭special pool配置。
以管理员权限打开cmd命令行，运行verifier.exe，暂时关闭驱动程序验证工具，减少触发驱动的潜在问题的可能。
以上，如您后续有任何问题，可随时与我们联系，谢谢。
