邮件主题：回复: [案例号: CAS-11869-N1L2C8 ] % |P1|ICBC|工行用户反馈V2020-L补丁安装失败问题 % 初次响应 CMIT:0001762

====第1封邮件====

发件人：Wei Liang
发送时间：2024-07-30 10:52:43.778000+00:00
邮件内容:
许先生 您好：
感谢您的电话接听。经过TAM与您沟通，此案例降为P2.
根据您提供的信息，我谨在此阐述我们双方针对这个问题所涉及范围界定：
问题定义:
工行用户反馈win7系统安装补丁失败，涉及的补丁为KB4474419、KB4530692和KB452523，不同的设备和云桌面虚拟机出现的问题有：补丁安装失败、重启 应用补丁卡在32%、有些云桌面虚拟机进入修复选项等，涉及多台win7的设备，需要协助排查。
问题范围:
我们将协助您分析处理上述问题，并对定义的问题给予最大的技术支持。
如果能及时解决问题，或问题属于产品设计的行为，或问题涉及到三方，我们将考虑关闭案例。如果存在多个问题，则我们考虑拆分案例进行分析。
接下来，我们将开始合作解决这个问题。如果您对以上的问题范围界定有任何异议，请尽快告知。如果您有其他任何疑问。也欢迎随时与我联系。
对于进入修复选项的设备，请您按照常规的修复系统引导项的操作，尝试进入系统启动过程，确认修复启动项后是否能正常进入系统。
卡在32%进度的设备，尝试使用winPE系统，进入PE环境下，测试是否能将新安装的补丁卸载，或者强制关机再启动能否进入系统。
提示更新补丁安装失败的设备，及时收集系统日志和CBS日志，将对应的日志目录压缩后通过CDUC上传，提供给CMIT进一步排查，谢谢。
CBS日志目录： C:\Windows\Logs
系统日志目录： C:\Windows\System32\winevt

====第2封邮件====

发件人：Wei Liang
发送时间：2024-07-31 09:37:19.137000+00:00
邮件内容:
许先生 您好：
日志分析显示问题设备在应用更新补丁处理驱动程序时，操作注册表出现了access denied错误导致补丁安装失败，出现回滚。
根据实际的案例处理经验，建议进行以下测试：
1）执行 sfc /scannow 扫描和修复系统文件
2）先更新堆栈更新（SSU）KB4490628，确保系统补丁更新过程的稳定性。
3）更新补丁过程中，建议先暂停或卸载三方安全软件（TMS安全应用软件），排除安全软件的影响。
4）cbs日志中未显示32%进度时等待超时的具体日志记录，建议在重启应用补丁前抓取procmon bootlogging日志进一步排查。
详细分析：
查看您提供的设备V10BJFHA2436072的日志，其安装KB4530692失败。
查看详细的cbs日志，显示在重启应用补丁过程中卡在32%进度，一直等待超时，没有更详细的日志记录。
Doqe是负责处理和跟踪驱动程序的安装过程，后续系统尝试重新启动以继续安装过程，还是出现类似错误，有timeout和accessdenied提示，最终导致回滚操作。
查看补丁安装重启前后时间点的cbs日志，有显示处理cpu.inf驱动时出现access denied错误。
查看对应的setupapidevlog，也显示0x5的错误记录，日志显示是设置驱动的注册表键值时出现access denied的错误。
去官网查询KB4530692的说明，其先决条件建议安装堆栈更新（SSU）KB4490628。

====第3封邮件====

发件人：Wei Liang
发送时间：2024-07-31 16:52:46.043000+00:00
邮件内容:
许先生 您好：
查看您新上传的李霞设备V10NXFH00004B1的日志，和上一台问题设备的问题是一样的，也是在应用更新补丁处理驱动程序时，操作注册表出现了access denied错误导致补丁安装失败，出现回滚。
建议进行以下测试：
1）执行 sfc /scannow 扫描和修复系统文件。
2）先更新堆栈更新（SSU）KB4490628，确保系统补丁更新过程的稳定性。
3）更新补丁过程中，建议先暂停或卸载三方安全软件（TMS安全应用软件），排除安全软件的影响。
4）cbs日志中未显示32%进度时等待超时的具体日志记录，建议在重启应用补丁前抓取procmon bootlogging日志进一步排查。
详细分析：
查看您提供新的问设备V10NXFH00004B1的日志，其安装KB4530692失败。
查看详细的cbs日志，显示在重启应用补丁过程中卡在32%进度，一直等待超时，没有更详细的日志记录。
查看补丁安装重启前后时间点的cbs日志，有显示处理cpu.inf驱动时出现access denied错误。
查看对应的setupapidevlog，也显示0x5的错误记录，日志显示是设置驱动的注册表键值时出现access denied的错误。

====第4封邮件====

发件人：Wei Liang
发送时间：2024-08-02 16:31:00.857000+00:00
邮件内容:
许先生 您好：
感谢您的电话接听。
根据您这边的统计，初步发现卡32%进度的问题设备未能安装KB4490628，需要我们排查未能获取这个补丁的原因。
我们会根据您的要求再次排查问题设备的日志，查找KB4490628的下载和安装情况，有任何进展会及时与您沟通，谢谢。

====第5封邮件====

发件人：Wei Liang
发送时间：2024-08-05 14:44:07.149000+00:00
邮件内容:
许先生 您好：
进一步查看问题设备的日志，发现其ssu版本分别为6.1.7601.24537（李霞V10NXFH00004B1设备）和6.1.7601.24554（V10BJFHA2436072设备）。
在官网查询详细信息，确认KB4490628的具体版本号为6.1.7601.24383，而问题设备的版本号都比KB4490628的版本号高，是已经安装了高版本的的ssu补丁，不再需要安装KB4490628补丁。
对比查看测试环境中成功安装KB4530692补丁的cbs记录，在32%进度期间，是执行Doqe过程，即处理和跟踪驱动程序的安装过程。
这是补丁更新过程中的驱动安装情况，涉及驱动安装过程的操作，建议排查三方安全软件的管控策略和操作对驱动安装的影响。
更具体的问题排查建议在重启应用补丁前配置procmon bootlogging，抓取启动过程中应用补丁的procmon日志分析。

====第6封邮件====

发件人：Wei Liang
发送时间：2024-08-06 11:42:52.562000+00:00
邮件内容:
许先生 您好：
感谢您的电话接听。
如电话中所说，堆栈更新（ssu）KB4490628是为了确保系统补丁更新过程的稳定性，如果设备已经安装了新版本的ssu补丁，就不会再安装被取代的KB4490628补丁。
而问题设备卡在32%进度，这是在执行Doqe过程，即处理和跟踪驱动程序的安装过程，问题设备由于未知原因，直接timeout超时，应用更新补丁失败，最后自动重启了三次后回滚。
在三次自动重启的过程中，有出现tiomeout和accessdenied错误记录。
从更新补丁安装过程排查问题，这个问题出现在补丁更新过程中的Doqe过程，涉及驱动安装过程的操作，建议排查三方安全软件的管控策略和操作对驱动安装的影响。
更具体的问题排查建议在重启应用补丁前配置procmon bootlogging，抓取启动过程中应用补丁的procmon日志分析。
由于问题设备在生产环境中无法进一步测试，您可以在测试环境中，安装与生产环境一致版本的安全软件，并应用相同的安全策略后，先安装KB4474419重启系统，再安装KB4490628和KB4530692，测试是否能复现生产环境中的问题。

====第7封邮件====

发件人：Wei Liang
发送时间：2024-08-07 11:48:50.547000+00:00
邮件内容:
许先生 您好：
如电话中所说，根据现有的问题设备的日志分析，问题设备卡在32%进度，这是在执行Doqe过程，即处理和跟踪驱动程序的安装过程，问题设备由于未知原因，直接timeout超时，应用更新补丁失败，最后自动重启了三次后回滚。
在三次自动重启的过程中，有出现tiomeout和accessdenied错误记录。
从更新补丁安装过程排查问题，这个问题出现在补丁更新过程中的Doqe过程，涉及驱动安装过程的操作，建议排查三方安全软件的管控策略和操作对驱动安装的影响。
更具体的问题排查建议在重启应用补丁前配置procmon bootlogging，抓取问题设备在启动过程中应用补丁的procmon日志分析。
您也可以将问题设备在WinPE环境中将问题设备系统转换为vhd镜像，提供给CMIT在测试环境中进一步测试排查。
Procmon bootlogging日志抓取配置：
1. 正常安装完成KB4530692，暂时不重启。
2. 运行procmon.exe，选中options->Enable Boot Logging：
3. 配置Boot Logging选项：
4. 重启问题设备，在第一次出现32%卡了15分钟timeout自动重启时，使用WinPE工具进入PE系统，复制C:\Windows\procmon.pmb文件，压缩后通过CDUC上传提供给CMIT进一步排查。

====第8封邮件====

发件人：Wei Liang
发送时间：2024-08-13 10:41:44.850000+00:00
邮件内容:
许先生 您好：
感谢您的电话接听。
如电话中所说，请您在问题设备上测试，可以复现实际生产环境中的问题后，再按照上一封的邮件说明，配置收取Procmon bootlogging日志，提供给我们进一步排查，谢谢。

====第9封邮件====

发件人：Wei Liang
发送时间：2024-08-15 15:51:05.035000+00:00
邮件内容:
许先生 您好：
如电话中所说，请您准备好能复现实际生产环境中安装补丁失败问题的设备后，我们再基于此设备进一步排查补丁安装失败的问题。
如果针对当前案件需要我们协助，可以通过邮件或者400热线联系我们，谢谢。

====第10封邮件====

发件人：Wei Liang
发送时间：2024-09-02 16:12:50.194000+00:00
邮件内容:
许先生 您好：
感谢您的电话接听。
请您确认有可以复现实际生产环境中安装补丁失败问题的设备后，我们再基于此设备进一步排查补丁安装失败的问题。
如果针对当前案件需要我们协助，可以通过邮件联系我们，谢谢。

====第11封邮件====

发件人：Wei Liang
发送时间：2024-09-02 17:51:39.582000+00:00
邮件内容:
许先生 您好：
感谢您的电话接听。
经过您的确认，我将暂时归档此案例。
工单的归档并不会影响我们为您提供技术支持服务，如有其他问题，您可以随时联系我们。
案例总结：
----
问题定义：
工行用户反馈win7系统安装补丁失败，涉及的补丁为KB4474419、KB4530692和KB452523，不同的设备和云桌面虚拟机出现的问题有：补丁安装失败、重启 应用补丁卡在32%、有些云桌面虚拟机进入修复选项等，涉及多台win7的设备，需要协助排查。
问题总结：
根据现有的问题设备的日志分析，问题设备卡在32%进度，这是在执行Doqe过程，即处理和跟踪驱动程序的安装过程，问题设备由于未知原因，直接timeout超时，应用更新补丁失败，最后自动重启了三次后回滚。
更具体的问题排查建议在重启应用补丁前配置procmon bootlogging，抓取问题设备在启动过程中应用补丁的procmon日志进一步分析。也可以将问题设备在WinPE环境中将问题设备系统转换为vhd镜像，提供给CMIT在测试环境中进一步测试排查。
当前的问题设备已经回滚处理，无问题复现环境，案例暂时归档，后续能复现问题后再重新分析排查。
以上，如您后续有任何问题，可随时与我们联系，谢谢。
