邮件主题：回复: [案例号: CAS-10518-X2V6X6 ] % 售前-安徽六安人民医院用户反馈软件使用问题 % 初次响应 CMIT:0001948

====第1封邮件====

发件人：Wei Liang
发送时间：2023-12-18 17:43:33.268000+00:00
邮件内容:
韩先生 您好：
感谢您的电话接听。
根据您提供的信息，我谨在此阐述我们双方针对这个问题所涉及范围界定：
问题定义:
安徽六安人民医院用户反馈医惠护理信息系统无法识别KEY的问题，在标准WIN10上不存在此问题，但是同一设备上的另一个系统可以识别当前KEY，需要协助排查。
问题范围:
我们将协助您分析处理上述问题，并对定义的问题给予最大的技术支持。
如果能及时解决问题，或问题属于产品设计的行为，或问题涉及到三方，我们将考虑关闭案例。如果存在多个问题，则我们考虑拆分案例进行分析。
接下来，我们将开始合作解决这个问题。如果您对以上的问题范围界定有任何异议，请尽快告知。如果您有其他任何疑问。也欢迎随时与我联系。
根据您提供的信息，在同一台设备上的同一个KEY，医惠护理信息系统无法识别，但是另一个系统可以识别，请您按照以下操作收集对应的日志。
一、Procmon日志
1）下载附件中的procmon.zip，解压后双击procmon.exe运行，点击Accept后，到达此页面，会有有大量条目出现，注意图标状态，显示如图所示图标，表示当前正在当前处于抓取状态；
2）运行医惠护理信息系统，点击再次识别，复现无法检测KEY的问题。
3）此时回到Process Monitor窗口，单击Capture图标，停止抓取；
4）点击File, 点击Save. 选择"All events" and "Native Process Monitor Format (PML)"点击OK。记录文件保存位置，并将PML文件打包压缩通过CDUC上传。
5）重复以上procmon抓取日志的操作，抓取医惠护理信息系统在标准WIN10上可以正常识别KEY的procmon日志，将日志压缩后通过CDUC上传。
二、系统日志
请您下载附件中的日志收集工具，解压后双击运行CMGELogCollectorV2.exe，勾选所有选项，点击收集获取对应的系统日志，将生成的日志压缩包通过CDUC上传。
日志上传方法：
用户名：LARMYYYH
密码：LARMYYYH
注意：添加文件，点击上传后，跳转到新的页面点击保存。

====第2封邮件====

发件人：Zhang Yandong
发送时间：2023-12-19 12:49:51.982000+00:00
邮件内容:
韩老师，您好！
以下是我们售后工程师发的邮件，我把2个工具压缩到了一个包里面，请检查一下是否可以收到，谢谢 ！
张彦东

====第3封邮件====

发件人：Zhang Yandong
发送时间：2023-12-19 15:56:10.594000+00:00
邮件内容:
Hi Wei Liang,
因客户没有收到我们的邮件，我再次转发给客户，客户依然说没有收到。 
我联系了我们公司的IT部门，对方给我的答复是 “邮件存在恶意软件，需要加密后发出“ ， IT部门的答复详见附件和邮件下文。
麻烦加密一下，再次发给客户，谢谢~
张彦东

====第4封邮件====

发件人：Wei Liang
发送时间：2023-12-19 16:08:26.188000+00:00
邮件内容:
韩先生 您好：
我的同事 @Zhang Yandong <mailto:zhangyd@cmgos.com>  反馈您未收到邮件，有可能是由于邮件附件原因未送达，重新给您发送相关操作邮件。
所需的工具可以通过以下链接下载：
https://cduc.cmgos.com/download.php?id=1206&token=PTSXSKMOCSUcKkjN2DEsr88qxALpwk5M
问题定义:
安徽六安人民医院用户反馈医惠护理信息系统无法识别KEY的问题，在标准WIN10上不存在此问题，但是同一设备上的另一个系统可以识别当前KEY，需要协助排查。
问题范围:
我们将协助您分析处理上述问题，并对定义的问题给予最大的技术支持。
如果能及时解决问题，或问题属于产品设计的行为，或问题涉及到三方，我们将考虑关闭案例。如果存在多个问题，则我们考虑拆分案例进行分析。
接下来，我们将开始合作解决这个问题。如果您对以上的问题范围界定有任何异议，请尽快告知。如果您有其他任何疑问。也欢迎随时与我联系。
根据您提供的信息，在同一台设备上的同一个KEY，医惠护理信息系统无法识别，但是另一个系统可以识别，请您按照以下操作收集对应的日志。
一、Procmon日志
1）通过链接下载tool.zip，解压后双击procmon.exe运行，点击Accept后，到达此页面，会有有大量条目出现，注意图标状态，显示如图所示图标，表示当前正在当前处于抓取状态；
2）运行医惠护理信息系统，点击再次识别，复现无法检测KEY的问题。
3）此时回到Process Monitor窗口，单击Capture图标，停止抓取；
4）点击File, 点击Save. 选择"All events" and "Native Process Monitor Format (PML)"点击OK。记录文件保存位置，并将PML文件打包压缩通过CDUC上传。
5）重复以上procmon抓取日志的操作，抓取医惠护理信息系统在标准WIN10上可以正常识别KEY的procmon日志，将日志压缩后通过CDUC上传。
二、系统日志
双击运行CMGELogCollectorV2.exe，勾选所有选项，点击收集获取对应的系统日志，将生成的日志压缩包通过CDUC上传。
日志上传方法：
用户名：LARMYYYH
密码：LARMYYYH
注意：添加文件，点击上传后，跳转到新的页面点击保存。

====第5封邮件====

发件人：Wei Liang
发送时间：2023-12-21 10:18:17.430000+00:00
邮件内容:
韩先生 您好：
感谢您的电话接听。
根据您的时间安排，我会在明天上午再次与您联系处理此案例。
如果有任何进展或疑问可以回复此邮件。

====第6封邮件====

发件人：Wei Liang
发送时间：2023-12-22 16:12:04.323000+00:00
邮件内容:
韩先生 您好：
移动护理应用无法访问KEY的问题，正在对比查看procmon日志，有任何进展会及时与您联系。
针对访问共享打印机时报错，提示“0x0000011b”问题，可以通过在共享端和被共享端添加一个注册表键值，并重启print spooler服务规避此问题。具体操作如下：
1）运行regedit，打开注册表编辑器，定位到以下注册表位置：
HKEY_LOCAL_MACHINE\System\CurrentControlSet\Control\Print
2）右键单机右侧界面空白位置，新建 – DWORD（32位）值：
3）将键值重命名为：RpcAuthnLevelPrivacyEnabled，并将键值设置为0。
4）运行services.msc打开服务管理界面，重启Print spooler服务，测试再次连接添加打印机。

====第7封邮件====

发件人：Wei Liang
发送时间：2023-12-26 16:20:18.963000+00:00
邮件内容:
韩先生 您好：
感谢您的电话接听。
在您的环境中，同一个ukey在同一台V2022-L系统上，运行ZSGL.exe应用可以正常识别并使用ukey登录，这表明在V2022-L系统上可以正常识别并使用ukey。
但是在运行移动护理.exe应用时，有一个弹窗提示，可以看到ukey对应的用户名称，但关闭弹窗提示后显示未检测到Key。
针对此问题，建议引入应用厂商排查其应用检测Key的逻辑，查找未检测到Key的原因。我们这边也可以协助排查，是否是移动护理.exe应用需要使用某些系统服务等。
由于您今天临时有其他安排，无法进行远程排查工作，我会明天再和您联系，尝试再次远程排查这个问题。
如果有任何进展或疑问可以回复此邮件。

====第8封邮件====

发件人：Wei Liang
发送时间：2024-01-03 17:25:56.004000+00:00
邮件内容:
韩先生 您好：
感谢您的电话接听。
当您安排好其他事情，可以通过远程协助方式处理、排查移动护理识别Key失败的问题时，您可以通过邮件、400热线等方式联系我们，我们会及时与您联系，继续处理这个问题。
如果有任何进展或疑问可以回复此邮件。

====第9封邮件====

发件人：Wei Liang
发送时间：2024-01-11 08:40:31.451000+00:00
邮件内容:
韩先生 您好：
感谢您的电话接听，并协助远程排查问题。
经过这段时间排查移动护理.exe应用检测Key的情况，判断问题出在应用通过调用BJCA提供的证书应用环境组件的接口CheckSoftDeviceEnv()，返回false，认为未插入Key。
尝试在本地环境中安装证书应用环境程序V3.2.1，并根据其组件接口说明文档，编写了一个xtxdemo应用，在V2022-L操作系统中执行CheckSoftDeviceEnv()操作，返回true。
在本地环境中测试的结果与实际环境中应用运行的结果不同，需要在实际环境中运行xtxdemo应用。
在查询证书应用环境组件的接口文档中，发现CheckSoftDeviceEnv()是用于检测软设备的运行环境是否正常，且可以通过BJCA证书助手配置日志级别，跟踪组件运行情况。
通过远程协助操作，在实际环境中复现问题，查看证书组件的跟踪日志，发现其有执行CheckSoftEnviroment操作，怀疑其在检测软件运行环境。
在用户环境中接上UsbKey后，在BJCA证书管理助手界面会显示“环境检测”功能，建议使用此功能检测软件运行环境并尝试修复其检测出的错误信息。
通过远程排查和测试，修复证书应用运行环境后，移动护理登录界面出现了变化，识别了Key，但是提示Key未绑定，需要用户了解其Key的相关设置操作。
证书应用运行环境出现问题可能与操作系统安装方式有关，此操作系统经过用户定制封装后再次部署。
经过应用分析以及在实际环境中测试，怀疑是证书应用的运行环境出现问题导致移动护理应用无法检测到Key，建议通过以下操作尝试修复证书软件运行环境。
1）以管理员权限运行BJCA证书助手。
2）插入UsbKey，此时在BJCA证书助手界面会显示“环境检测”功能。
3）运行“环境检测”，利用其提供的“修复环境”功能尝试修复软件运行环境。
4）打开移动护理应用，测试、验证是否可以正常识别UsbKey。

====第10封邮件====

发件人：Wei Liang
发送时间：2024-01-15 15:45:17.588000+00:00
邮件内容:
韩先生 您好：
感谢您的电话接听。
当您安排好其他事情后，可以按照1月11日的邮件说明进行对应的测试，验证是否可以解决移动护理应用识别Key的问题。
如果有任何进展或疑问可以回复此邮件。

====第11封邮件====

发件人：Wei Liang
发送时间：2024-01-17 17:46:59.097000+00:00
邮件内容:
韩先生 您好：
感谢您的电话接听。
经过您的确认，在上次远程协助处理的设备上，移动护理应用可以正常识别Key。
请您再找另一台出现同样问题的设备，按照1月11日的邮件说明进行对应的测试，验证是否可以解决移动护理应用识别Key的问题。
如果有任何进展或疑问可以回复此邮件。

====第12封邮件====

发件人：Wei Liang
发送时间：2024-01-22 17:59:45.599000+00:00
邮件内容:
韩先生 您好：
感谢您的电话接听。
从之前排查问题以及这次的BJCA证书助手运行环境检测结果，可以确认是由于BJCA组件的软证书环境检查未通过，导致无法识别Key的问题。
移动护理应用在识别Key的过程中，会进行软证书环境检查操作。如果未通过检查，就会显示未插入Key。
当前的BJCA证书助手未提供修复软证书环境检查的功能，根据您的安排，明天下午两点半，移动护理的工程师和BJCA证书的工程师会到达现场一块处理此问题，届时我会给您电话，一块沟通、处理这个问题。
如果有任何进展或疑问可以回复此邮件。

====第13封邮件====

发件人：Wei Liang
发送时间：2024-01-23 15:35:47.703000+00:00
邮件内容:
韩先生 您好：
感谢您的电话接听。
经过远程测试验证，在使用BJCA证书助手进行“环境检测”时，提示“软证书环境检查”未通过。
查看BJCA证书助手应用的日志记录，发现其报错提示无法加载bjca_softkey.db。
查看此文件的具体信息，发现此文件是2023-11-15日生成的，并不是测试当天的修改时间。
而在测试环境中，这个文件修改时间是安装并运行BJCA证书助手的时间点，且删除此文件后，再次运行会重新生成此文件。
在问题设备上，测试删除bjca_softkey.db文件后，再次运行“环境检测”功能，软件运行环境检查通过。
修复建议：
1）使用定制的系统镜像完成系统部署工作。
2）登录新安装的系统后，定位到C:\Users\AdministratorAppData\LocalLow\BJCA目录，删除bjca_softkey.db文件。
3）以管理员权限运行BJCA证书助手应用。
4）插入UsbKey，此时在BJCA证书助手界面会显示“环境检测”功能。
5）运行“环境检测”，利用其提供的“修复环境”功能尝试修复其运行环境。
6）打开移动护理应用，测试、验证是否可以正常识别UsbKey。

====第14封邮件====

发件人：Wei Liang
发送时间：2024-01-25 17:34:20.360000+00:00
邮件内容:
韩先生 您好：
感谢您的电话接听。
经过您的确认，我将归档此案例。
工单的归档并不会影响我们为您提供技术支持服务，如有其他问题，您可以随时联系我们。
案例总结：
----
问题定义：
安徽六安人民医院用户反馈医惠护理信息系统无法识别KEY的问题，在标准WIN10上不存在此问题，但是同一设备上的另一个系统可以识别当前KEY，需要协助排查。
问题总结：
经过远程排查发现这个问题的根本原因是BJCA证书助手检测“软证书环境检查”未通过，这与BJCA证书组件以及操作系统定制封装操作有关，验证删除bjca_softkey.db文件后，BJCA证书助手运行环境检查通过，问题解决。
修复建议：
1）使用定制的系统镜像完成系统部署工作。
2）登录新安装的系统后，定位到C:\Users\AdministratorAppData\LocalLow\BJCA目录，删除bjca_softkey.db文件。
3）以管理员权限运行BJCA证书助手应用。
4）插入UsbKey，此时在BJCA证书助手界面会显示“环境检测”功能。
5）运行“环境检测”，利用其提供的“修复环境”功能尝试修复其运行环境。
6）打开移动护理应用，测试、验证是否可以正常识别UsbKey。
或者在定制的系统镜像打包之前，先删除对应目录中的bjca_softkey.db文件，再打包、封装系统镜像。
以上，如您后续有任何问题，可随时与我们联系，谢谢。
