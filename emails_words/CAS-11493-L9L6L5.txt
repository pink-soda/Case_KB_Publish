邮件主题：回复: [案例号: CAS-11493-L9L6L5 ] % |P1|ICBC|工行用户反馈V2020-L版本系统安装KB5036896补丁后黑屏问题 % 初次响应 CMIT:0001995

====第1封邮件====

发件人：Wei Liang
发送时间：2024-06-05 16:44:14.809000+00:00
邮件内容:
许先生 您好：
感谢您的电话接听。
根据您提供的信息，我谨在此阐述我们双方针对这个问题所涉及范围界定：
问题定义:
工行浙江分行用户反馈V2020-L版本系统安装KB5036896补丁，重启后出现黑屏问题，需要协助排查。
问题范围:
我们将协助您分析处理上述问题，并对定义的问题给予最大的技术支持。
如果能及时解决问题，或问题属于产品设计的行为，或问题涉及到三方，我们将考虑关闭案例。如果存在多个问题，则我们考虑拆分案例进行分析。
接下来，我们将开始合作解决这个问题。如果您对以上的问题范围界定有任何异议，请尽快告知。如果您有其他任何疑问。也欢迎随时与我联系。
排查您提供的浙江分行和南京分行的问题设备的日志，问题是一致的，显示和网络驱动更新相关，但是黑屏问题与更新补丁的安装并没有直接联系。
根据最终用户的测试结果，安装更新补丁后，重启设备跳过磁盘检查后，更新补丁应用成功进入系统，并未出现黑屏问题。
结合实际测试结果，怀疑是NTFS文件系统问题导致的黑屏现象，建议先修复NTFS文件系统问题，再验证补丁安装是否能复现黑屏问题。
以浙江分行日志为例，具体分析如下：
CBS日志显示是处理和网络驱动更新相关的事务时找不到endpoint，可能是某个网络服务或者三方软件相关，但系统中禁用了许多服务，不好直接判断是什么导致的。
另外，系统日志中有大量NTFS报错，建议先进行文件系统修复操作：
修复建议：
磁盘修复操作：
1）建议先备份数据；
2）以管理员权限打开cmd命令行，运行chkdsk /r /f C: 尝试进行修复，按照提示重启，在重新启动过程中会尝试文件系统修复操作；
如果重启过程中文件系统修复困难，可以尝试通过进入WinPE系统，在PE环境中执行chkdsk修复。
3）文件系统修复完成后，以管理员权限打开cmd命令行，运行命令：sc config netsetupsvc type= own
4）然后安装补丁并重启，看是否可以完成配置；
5）假如补丁更新完成，再运行命令还原配置：sc config netsetupsvc type= share，如果还是无法更新补丁，需要尝试抓取重启应用补丁的过程日志。
关于系统日志中出现NTFS文件系统出现损坏，为什么会出现这种问题，根据经验，遇到最多的情况就是不正常关机导致的。在问题发生前某些软件等做了一些更改等导致NTFS文件系统损坏了，直到重启/关机/crash时问题发生。由于系统和软硬件的状态都在随时变化，系统也无法随时检查文件系统状态。
异常关机
event ID 6008
NTFS 文件损坏告警
event ID 55, 98
1. 当NTFS从磁盘读任何metadata(e.g. MFT records, directory index blocks, etc.)的时候会执行基本的健全性检查，以确保它结构良好，如果这些检查失败，则该文件被视为已损坏，然后在系统日志里面报NTFS 55，没有读取到这块问题的metadata数据的时候不会报错。
2. 将metadata元数据写入磁盘时，NTFS不会执行这些健全性检查，因为很影响性能。所以metadata元数据文件损坏在系统日志NTFS 55之前已经发生了，可能发生在几分钟之前，也有可能是几个小时之前。
可能原因：
//NTFS 55一般有以下可能原因：
多台服务器或存储同时对磁盘进行写操作
服务器意外重启/强制重启，OS 发出的一些涉及元数据的IO被中断
对磁盘进行变更，特别是扩展或者迁移磁盘/卷
硬件方面的原因，导致OS发出的数据通过SCSI/iSCSI/HBA 这样的硬件设备时IO没有写到正确的位置
文件系统过滤驱动比如杀毒软件，加密软件等 阻止了OS层面的一些IO 或者异常扫描导致文件层面的损坏
备份软件没有正常关闭文件handle
磁盘碎片过多
修复文件系统建议：
1. 保存所有未保存的数据并关闭所有打开的程序单击开始，以管理员模式运行CMD命令行
chkdsk  X: /f
2. 如果NTFS 55消息定期出现，例如每天或每周，请使用/R命令行选项运行chkdsk。此选项允许chkdsk定位硬盘上的坏扇区。请在此操作前备份磁盘数据，此修复不可逆，防止因修复命令导致数据丢失。
chkdsk  X: /f /R
3. 请确认当前磁盘状态，如果需要修复磁盘状态，都需要将磁盘数据进行备份，修复磁盘状态并不是数据恢复。

====第2封邮件====

发件人：Wei Liang
发送时间：2024-06-12 17:34:45.186000+00:00
邮件内容:
许先生 您好：
感谢您的电话接听。
确认不再出现黑屏问题，我将归档此案例。
工单的归档并不会影响我们为您提供技术支持服务，如有其他问题，您可以随时联系我们。
案例总结：
----
问题定义：
工行浙江分行用户反馈V2020-L版本系统安装KB5036896补丁，重启后出现黑屏问题，需要协助排查。
问题总结：
排查发现ntfs文件系统出现问题，通过WinPE或者系统安装光盘在修复模式下执行chkdsk命令修复文件系统问题后，重启设备不再出现修复磁盘错误提示，更新补丁也安装成功，不再复现黑屏问题，案例关闭。
分析说明：
从问题设备的日志分析，出现黑屏问题的直接原因是在操作系统启动过程中许多服务启动失败导致的黑屏，和安装更新补丁没有关系。
结合最终用户反馈有许多设备在重启时会显示修复磁盘错误，用户会手动跳过磁盘修复进入系统。用户测试如果让操作系统自动修复磁盘，需要较长时间且容易出现反复提示修复磁盘导致无法进入系统。
查看问题设备的具体日志，有一些服务启动失败显示：介质受写入保护。
这表明此服务启动失败与ntfs文件系统有关，磁盘分区出现写入保护，无法写入数据。
此时需要先解决ntfs文件系统问题，确认操作系统文件和服务都可以正常运行后，再测试、排查其他的问题。
如果在操作系统启动阶段无法完成ntfs文件系统修复操作，可以进入WinPE系统，或者使用系统安装光盘进入修复模式，再执行chkdsk /r /f C:修复。
为什么会出现ntfs文件系统错误的问题，根据经验，遇到最多的情况就是不正常关机导致的。在问题发生前某些软件等做了一些更改等导致ntfs文件系统损坏了，直到重启/关机/crash时问题发生。由于系统和软硬件的状态都在随时变化，系统也无法随时检查文件系统状态。
异常关机  event ID 6008
NTFS 文件损坏告警  event ID 55, 98
1. 当NTFS从磁盘读任何metadata(e.g. MFT records, directory index blocks, etc.)的时候会执行基本的健全性检查，以确保它结构良好，如果这些检查失败，则该文件被视为已损坏，然后在系统日志里面报NTFS 55，没有读取到这块问题的metadata数据的时候不会报错。
2. 将metadata元数据写入磁盘时，NTFS不会执行这些健全性检查，因为很影响性能。所以metadata元数据文件损坏在系统日志NTFS 55之前已经发生了，可能发生在几分钟之前，也有可能是几个小时之前。
可能原因：
NTFS 55一般有以下可能原因：
多台服务器或存储同时对磁盘进行写操作
服务器意外重启/强制重启，OS发出的一些涉及元数据的IO被中断
对磁盘进行变更，特别是扩展或者迁移磁盘/卷
硬件方面的原因，导致OS发出的数据通过SCSI/iSCSI/HBA 这样的硬件设备时IO没有写到正确的位置
文件系统过滤驱动比如杀毒软件，加密软件等 阻止了OS层面的一些IO 或者异常扫描导致文件层面的损坏
备份软件没有正常关闭文件handle
磁盘碎片过多
修复文件系统建议：
1. 保存所有未保存的数据并关闭所有打开的程序，单击开始，以管理员模式运行CMD命令行
chkdsk  X: /f
2. 如果NTFS 55消息定期出现，例如每天或每周，请使用/r命令行选项运行chkdsk。此选项允许chkdsk定位硬盘上的坏扇区。请在此操作前备份磁盘数据，此修复不可逆，防止因修复命令导致数据丢失。
chkdsk  X: /f /r
3. 确认当前磁盘状态，如果需要修复磁盘状态，都需要将磁盘数据进行备份，修复磁盘状态并不是数据恢复。
以上，如您后续有任何问题，可随时与我们联系，谢谢。
