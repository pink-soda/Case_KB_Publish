邮件主题：回复: [案例号: CAS-07201-P1H0Y6 ] % 联想OEM用户-农业银行百色分行用户反馈离线更新安装失败问题 % 初次响应 CMIT:0001193

====第1封邮件====

发件人：Wei Liang
发送时间：2022-09-26 10:53:49.807000+00:00
邮件内容:
林先生 您好：
刚刚给您电话没有接通。
根据您提供的信息，我谨在此阐述我们双方针对这个问题所涉及范围界定：
问题定义:
用户反馈多台设备离线更新补丁KB5013941安装失败，需要协助排查。
问题范围:
我们将协助您分析处理上述问题，并对定义的问题给予最大的技术支持。
如果能及时解决问题，或问题属于产品设计的行为，或问题涉及到三方，我们将考虑关闭案例。如果存在多个问题，则我们考虑拆分案例进行分析。
接下来，我们将开始合作解决这个问题。如果您对以上的问题范围界定有任何异议，请尽快告知。如果您有其他任何疑问。也欢迎随时与我联系。
请您按照以下方法帮忙收集相关系统日志进行分析。
1）请先复现安装更新补丁KB5013941失败的问题
2）通过以下链接下载日志收集工具CMGELogCollector.zip。
https://cduc.cmgos.com/download.php?id=644&token=TOGBo13NOJlb5eu6eioaKMT6khiA2tJA
3）在安装更新补丁失败的故障机上解压后运行CMGELogCollector.exe，勾选全部选项，点击“收集”，运行几分钟后会在桌面生成日志压缩包。
日志上传方法：
您可以登陆https://cduc.cmgos.com <https://cduc.cmgos.com/> ，通过数据上传系统上传您所收集的日志信息。
用户名：nhbsfh
密码：nhbsfh
注意：添加文件，点击上传后，跳转到新的页面点击保存。

====第2封邮件====

发件人：Wei Liang
发送时间：2022-09-28 11:16:41.449000+00:00
邮件内容:
林先生 您好：
感谢您的电话接听。
如果无法使用日志收集工具CMGElogCollector.exe收集相关日志，您可以按照以下步骤手动获取相关系统日志。
1）清空C:\Windows\SoftwareDistribution\Download中的所有内容。
2）安装离线更新补丁KB5013941，复现安装失败的问题。
3）复制故障机上的C:\Windows\Logs目录和C:\Windows\System32\Winevt\Logs目录，压缩后通过CDUC上传。
日志上传方法：
您可以登陆https://cduc.cmgos.com <https://cduc.cmgos.com/> ，通过数据上传系统上传您所收集的日志信息。
用户名：nhbsfh
密码：nhbsfh
注意：添加文件，点击上传后，跳转到新的页面点击保存。

====第3封邮件====

发件人：Wei Liang
发送时间：2022-09-28 17:36:52.742000+00:00
邮件内容:
林先生 您好：
感谢您的电话接听。
请您按照以下步骤提供相关日志信息。
1）查看C:\Windows\Winsxs\目录属性，提供具体截图，如图所示：
2）确认当前故障机的操作系统内部版本，如图所示，用于与正常升级的设备对比Winsxs目录缺少哪些文件。
3）以管理员权限打开cmd命令行，执行以下命令列出已经安装的更新补丁列表输出到C:\kb.txt，将C:\kb.txt文件提供给我们。
wmic qfe list > c:\kb.txt
4）以管理员权限打开cmd命令行，执行以下命令列出winsxs目录的文件列表输出到C:\winsxs.txt，将C:\winsxs.txt文件提供给我们。
tree /f c:\windows\winsxs > c:\winsxs.txt
5）清空C:\Windows\SoftwareDistribution\Download中的所有内容。
6）安装离线更新补丁KB5013941，复现安装失败的问题。
7）将故障机上的C:\Windows\Winsxs\目录属性截图、C:\kb.txt文件、C:\winsxs.txt文件C:\Windows\Logs目录和C:\Windows\System32\Winevt\Logs目录，压缩后通过CDUC上传。
8）请提供出现此更新补丁失败问题的设备硬件型号。
日志上传方法：
您可以登陆https://cduc.cmgos.com <https://cduc.cmgos.com/> ，通过数据上传系统上传您所收集的日志信息。
用户名：nhbsfh
密码：nhbsfh
注意：添加文件，点击上传后，跳转到新的页面点击保存。
V2022-L镜像下载：
您可以访问以下链接，输入设备上的激活标签上的SN序列号，验证通过后，从CMIT官网下载V2022-L镜像。
如果SN序列号前两位不是AA开头，从以下链接OEM用户下载：
https://download.cmgos.com/oem/login
如果SN序列号前两位是AA开头，从以下链接订单授权下载：
https://download.cmgos.com/pcibOrder/login

====第4封邮件====

发件人：Wei Liang
发送时间：2022-09-29 16:58:36.517000+00:00
邮件内容:
林先生 您好：
日志已经收到，有任何进展会及时与您联系，谢谢。

====第5封邮件====

发件人：Wei Liang
发送时间：2022-09-30 15:20:22.241000+00:00
邮件内容:
林先生 您好：
针对您这台收集日志的故障机，可以按照以下操作步骤反复测试每次安装失败后的cbs.log或CbsPersist日志，逐步替换对应文件，确认是否可以正常安装更新补丁KB5013941。
如果替换后还是提示一样的错误，可以按照以下步骤多次测试安装KB5013941，通过日志去确认去复制其余缺少的文件，看是否能成功安装更新补丁。
对比缺少的Winsxs中的目录和文件已经上传，您可以通过以下链接下载：
https://cduc.cmgos.com/download.php?id=683&token=q8o8B995elK9x4c5Q3TMrWApBKr1o2Ck
1）离线安装更新补丁KB5013941，如果提示安装失败，报错：0x800f081f。
2）打开dism.log，查看最新执行的dism安装失败时间，（可以搜索KB5013941，查看最新的安装和失败报错：800f081f，如当前日志显示16:11:03 报错）
3）打开C:\Windows\Logs\CBS\目录，查看日志文件修改时间，找距离报错时间点以后的最近的时间点的文件，如这个日志CbsPersist_20220929082152.log，修改时间是16:13。
4）打开CbsPersist_20220929082152.log，搜索“Unable to prestage file”查看最新的日志。
5）查看它的下一条“The payload directory”确认是缺少哪一个目录所在的文件。
6）提示缺少amd64_microsoft-windows-com-base.resources_31bf3856ad364e35_10.0.17763.1_zh-cn_08cc10727cf3e444目录，下载附件中的压缩文件base.zip，尝试将对应的目录及文件复制到C:\Windows\Winsxs\目录，再次验证升级情况。
如果提示没有权限复制文件夹到C:\Windows\Winsxs\目录，请按照以下操作为C:\Windows\Winsxs\修改安全属性后，再次复制文件夹。
1）右键点击文件夹，打开【属性】对话框，选择【安全】选项卡，单击【高级】按钮；
2）在高级安全设置界面，更改所有者为您当前所在的用户或用户组；
3）确定后，回到文件夹的【安全】选项卡界面，单击【编辑】按钮，在弹出的窗口中选择当前的组或用户名，勾选【完全控制】；（如果没有第2步添加的用户名， 可以手动添加对应的用户名）
4）点击确定后，关闭文件夹的【属性】对话框,，再次测试复制文件夹操作。

====第6封邮件====

发件人：Wei Liang
发送时间：2022-09-30 15:57:44.302000+00:00
邮件内容:
林先生 您好：
感谢您的电话接听，确认您的问题已经解决，我将暂时归档此案例。
工单的归档并不会影响我们为您提供技术支持服务，如您有其他问题，您可以致电技术支持热线4008180055。
案例总结：
----
问题定义：
用户反馈多台设备离线更新补丁KB5013941安装失败，需要协助排查。
问题总结：
用户通过升级到V2022-L系统跳过更新失败问题，同意关闭案例。
日志分析：
查看提供的日志，都是提示：加载一个或多个组件失败。（0x800f081f），涉及到C:\Windows\Winsxs\目录中的文件。
怀疑Winsxs目录中有多个组件丢失。
对比正常能够安装补丁的设备上的Winsxs目录，提供缺失的相关文件，请反复测试复制cbs日志中提到的缺失的文件及目录到故障机的Winsxs目录，验证是否可以正常更新。
以上，如您后续有任何问题，可随时与我们联系，谢谢。
