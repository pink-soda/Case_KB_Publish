邮件主题：回复: [案例号: CAS-02766-K0T1Q5 ] % VDI-电科VDI客户端激活失败问题 % 初次响应 CMIT:0001616

====第1封邮件====

发件人：Shi Guannan
发送时间：2020-08-11 18:52:02.594000+00:00
邮件内容:
Hi  Dev，
CETC今日（8月11日）部署VDI激活服务器出现激活失败问题。已创建Redmine issue     #9774 <https://cmit-pmit.chinanorth.cloudapp.chinacloudapi.cn/issues/9774> .
请协助排查问题，谢谢。
虚机环境：KVM，虚机部署在北京、上海多个服务器上
虚机系统：由V0-H离线升级到V2020-L
激活测试情况：
测试4台本地虚机，成功激活1台，其他3台激活失败。
激活失败现象一致：
1.查询VDI激活服务器portal 可以看到激活成功记录“创建授权码成功”
2.查询虚机CmitClient 应用日志，查看到激活申请后有两条连续的错误日志“使用内网激活服务器激活失败”
尝试的步骤：
1.在激活失败虚机，运行slmgr /rearm，重启后仍激活失败。
2.找到一台V2020-L虚机配置VDI激活成功。
已收取2台激活失败设备的CBR和licesingdiag日志。请协助 排查激活失败问题原因。
Guannan

====第2封邮件====

发件人：Shi Guannan
发送时间：2020-08-12 10:58:33.620000+00:00
邮件内容:
Hi Huili，
更新一下服务最新的测试进展：
*  使用现有的从V0-H升级到V2020-L虚机（工行基线版本），复现激活失败问题。
*  激活失败后，安装CmitClient  V3.1.0.5，激活成功。
接下来我们在准备纯净的V0-H升级到V2020-L虚机环境待验证以上问题。
Guannan

====第3封邮件====

发件人：Yao Huili
发送时间：2020-08-12 11:01:09.545000+00:00
邮件内容:
感谢提供新的信息， 研发部门正在进行调研。

====第4封邮件====

发件人：Shi Guannan
发送时间：2020-08-12 14:22:09.774000+00:00
邮件内容:
Hi Huili，
再更新一下我们的测试进展：
安装纯净的V0-H虚机离线升级到V2020-L，升级后直接配置vdi模式和VDI服务器地址，激活成功。
Guannan

====第5封邮件====

发件人：Yao Huili
发送时间：2020-08-12 14:45:33.365000+00:00
邮件内容:
Hi Guannan， 
谢谢更新最新的信息。根据目前提供电科虚拟机中的licesingdiag，研发内部无法判断root cause。
请查看业务的影响， 如果必要，建议根据微软FIJI 模板填写，升级到微软。  
慧莉

====第6封邮件====

发件人：Shi Guannan
发送时间：2020-08-12 15:38:54.101000+00:00
邮件内容:
Hi 文磊，
根据目前提供电科虚拟机中的licesingdiag，研发内部无法判断root cause。
请查看业务的影响， 如果必要，我们将根据微软FIJI流程将问题升级到微软。
Guannan

====第7封邮件====

发件人：/o=cmit/ou=Exchange Administrative Group (FYDIBOHF23SPDLT)/cn=Recipients/cn=user7a071bfa
发送时间：2020-08-12 15:41:05.869000+00:00
邮件内容:
Hi 冠男，
激活后项目才能验收，如无法激活项目无法验收。建议尽快处理
Best Regards!
王文磊
________________________________
www.cmgos.com <http://www.cmgos.com/> 
Email: wangwl@cmgos.com <mailto:wangwl@cmgos.com> 
Mobile: + 86 186 1036 8080

====第8封邮件====

发件人：Shi Guannan
发送时间：2020-08-12 17:40:42.826000+00:00
邮件内容:
Hi  Huili,
如VDI激活问题不能解决将影响CETC VDI Order的验收。请协助将此问题升级微软。
以下是Fiji模板，请帮忙review问题描述内容后升级微软，谢谢！
Field name
Description of content
Title
1.1      Issue Titles
*       [GSKU] V2020-L VDI Activation failed
Issue type
Code Defect, Documentation, Spec Defect or Servicing
Partner Priority
1 - This issue is blocking in some areas and must be fixed as soon as possible.
Partner Severity
2- The issue causes major functionality or other problems, and in some cases, may cause a product failure.
Partner Description
This should include a detailed description of the issue AND the Business Impact the issue causes to the project. Please also include any investigation details already completed by you on the issue. 
Repro steps
Please fill out the following template as much as you can and add it under Repro steps:
End user scenario:  End user placed a VDI order. The VM activation failed after the VDI server deployment was completed
Scope of impact: Not specific to VM product. Found in KVM and Hyper-V VM. 
How often does it repro (Repro Rate)? :75% 
Is there a local repro in Redmond? To be filled by Microsoft
Is the device recoverable? :
Found in OS version: CMGE V2020-L
Is this a regression from previous release? Provide build # where this was not broken:  N/A
Business justification? 
VDI order cannot be accepted by end user(CETC).
What is the impact if this is not fixed or serviced?
VDI order cannot be accepted by end user(CETC).
When is the fix needed by (Ship date/Milestone/Servicing release)?: 
Before 8/21/2020
Found by?: End user- CETC.
Steps to repro:
1.      Deploy V0-H in KVM.
2.      In-place upgrade VM Client to V2020-L. 
3.      Deploy VDI activation server in end user intranet. 
4.      Set VDI mode and VDI server host in VM Client.
5.      Wait 15 mins for the VM Client to trigger automatic activation.
Expected results: Activation succeeded
Actual results: Activation failed.
VDI Server Activation Records—Activation info: online create marker success.
VM Client Activation Status— Not Activated.
VM Client App Event Log – Error: Failed to activate system using intranet activation server
Guannan

====第9封邮件====

发件人：Shi Guannan
发送时间：2020-08-12 18:13:15.412000+00:00
邮件内容:
Hi  Zhenning,
目前CETC遇到的VDI激活失败问题，CMIT研发team在看过收取的日志后反馈无法判断问题原因，需要进一步升级微软进行问题分析。
我们已将业务影响和问题详情按照微软升级模板更新，等待研发提交微软处理。
如刚才沟通，有两点信息供参考：
1.      根据昨天现场的测试，CETC 内网部署的VDI服务器，可以正常激活2台VM（1台由H升级到2020，1台直接安装2020），说明VDI服务器下发激活授权文件功能是正常的。目前的激活失败问题发生在VM Client，与客户端环境有关。
2.      从产品角度来讲，VDI模式是从V2020-L版本开始支持的。默认V0-H 不支持虚机使用，从而由V0-H升级到V2020-L版本也不是产品支持的虚机使用场景。
另外，今天我们在本地环境中做了如下测试：
1． 纯净V0-H 
*  Hyper-V 部署纯净V0-H
*  离线升级到V2020-L
*  配置VDI激活模式
*  激活成功
2． 工行基线V0-H
*  Hyper-V 部署V0-H配置工行基线
*  离线升级到V2020-L
*  配置VDI激活模式
*  激活失败，现象与CETC失败现象一致
*  升级CmitClient 激活客户端版本到V3.1.0.5后激活成功
以上测试结果已经和研发team同步，目前研发尚无法给出问题原因。（=不能肯定CETC环境中升级CmitClient能成功激活，可以考虑让CETC升级试一下，但存在风险）
\\10.0.19.101\共享应用\RD Release\CMIT Activation Client - CIB\3.1.0.5 <file://10.0.19.101/共享应用/RD%20Release/CMIT%20Activation%20Client%20-%20CIB/3.1.0.5> 
如大家所知，问题升级微软后处理时效不会太快。。。补充以上信息，希望可以先尝试与用户进行沟通。
感谢！
Guannan

====第10封邮件====

发件人：Shi Guannan
发送时间：2020-08-13 10:57:41.472000+00:00
邮件内容:
Hi Huili,
补充一个问题日志，从CETC第三台激活失败设备收取的licensingdiag日志和CBR信息，如附件。
Guannan

====第11封邮件====

发件人：Yao Huili
发送时间：2020-08-13 14:38:10.629000+00:00
邮件内容:
Hi Guannan, 
此问题已经升级微软解决。谢谢及时更新相关信息和log! 后续会继续跟进。
351184 <https://partner.microsoft.com/en-us/dashboard/collaborate/engagements/1208/feedback/wits/Bugs/351184> 
Marker activation failed for V2020-L (based on RS5-G) upgrading from V0-H (based on RS4-G) in Client VM on KVM and Hyper-V <https://partner.microsoft.com/en-us/dashboard/collaborate/engagements/1208/feedback/wits/Bugs/351184> 
Huili 

====第12封邮件====

发件人：Yao Huili
发送时间：2020-08-17 19:30:31.351000+00:00
邮件内容:
Hi Guannan， 
CMGE V0-H 明确地不支持虚拟机安装。但考虑到尝试为用户解决实际问题，建议服务部门尝试如下步骤。谢谢！
1.      完整地、准确地还原电科VDI环境中CMGE V0-H 升级到V2020-L步骤。 
2.      升级后第一时间安装CMGEV2020-L中正式多级keyholder。
3.      修改为VDI 激活模式。
4.      查看系统激活状态。
慧莉

====第13封邮件====

发件人：Shi Guannan
发送时间：2020-08-18 10:22:01+00:00
邮件内容:
Hi Huili，
明天有可能到电科现场进行调试。我们会按照研发的建议步骤进行尝试。
请提供V2020-L正式多级keyholder 的安装文件。
2. 升级后第一时间安装CMGEV2020-L中正式多级keyholder
并确认安装方式是否如下：
keyholder安装方法：
1，     将keyholder文件拷贝至 如下路径：
C:\ProgramData\Microsoft\Windows\ClipSVC\Install\KeyHolder
2，     在管理员命令提示符下停止并重新启用 clipsvc服务
net stop clipsvc
net start clipsvc
谢谢~
Guannan

====第14封邮件====

发件人：Shi Guannan
发送时间：2020-08-18 11:43:33.941000+00:00
邮件内容:
Hi  Junjie,
如沟通，请帮忙协调电科进场调试的时间和环境。
目前有如下测试计划：
1． 记录问题虚机的系统环境及软件安装情况；
2． 确认keyholder安装状态，如果确认keyholder未正确安装，升级Cmitclient尝试激活；
3． 若升级CmitClient未解决问题，尝试手动安装keyholder后进行激活测试；
4． 若以上均未解决激活问题，逐一卸载问题设备上安装的软件，进行激活测试。
服务计划到场人员：石冠男 1人
请帮忙协调电科入场流程，谢谢！
Guannan

====第15封邮件====

发件人：Yao Huili
发送时间：2020-08-18 13:57:46.157000+00:00
邮件内容:
Hi Guannan， 
以下安装方法正确，请查收多级keyholder 。 谢谢。
慧莉。

====第16封邮件====

发件人：/o=cmit/ou=Exchange Administrative Group (FYDIBOHF23SPDLT)/cn=Recipients/cn=fab2eab282af4d959e35345f121b0db4
发送时间：2020-08-18 13:59:26.486000+00:00
邮件内容:
也请服务团队尽可能看一下，目前用户升级后的镜像里，是不是没有Root Keyholder

====第17封邮件====

发件人：Shi Guannan
发送时间：2020-08-18 14:29:54.629000+00:00
邮件内容:
Hi Dongji & Huili,
我明天会首先check一下用户升级后的环境中keyholder状态。
我查看了一台本地V0-H升级到V2020的虚机，Archive 文件夹中有三个文件。比纯净的2020多了一个61afd开头的文件。请问这算是正常的安装了Root Keyholder吗？
判断正常安装Root Keyholder的主要条件是什么？
Guannan

====第18封邮件====

发件人：Yao Huili
发送时间：2020-08-18 16:34:57.529000+00:00
邮件内容:
Hi Guannan， 
正常安装了Root keyholder 后C:\ProgramData\Microsoft\Windows\ClipSVC\Archive\KeyHolder会存在对应UUID 的keyholder文件：f912421d-3371-f33c-3cf8-22df25e5851f.xml。 
结合之前讨论，总结如下，供参考。 
1.      完整地、准确地还原电科VDI环境中CMGE V0-H 升级到V2020-L步骤。 
确认系统升级后，确认是否正确安装了root keyholder 。 判断标准：正常安装了Root keyholder 后C:\ProgramData\Microsoft\Windows\ClipSVC\Archive\KeyHolder会存在对应UUID 的keyholder文件：f912421d-3371-f33c-3cf8-22df25e5851f.xml。
2.      升级后第一时间安装CMGEV2020-L中正式多级keyholder。
2.1将keyholder文件拷贝至 如下路径：
C:\ProgramData\Microsoft\Windows\ClipSVC\Install\KeyHolder
2.2 在管理员命令提示符下停止并重新启用 clipsvc服务
net stop clipsvc
net start clipsvc
3.      修改为VDI 激活模式。
4.      查看系统激活状态。
5.      如果激活继续失败，重启CMGE系统，再次查看系统激活状态。
如有疑问，请随时联系。 

====第19封邮件====

发件人：Shi Guannan
发送时间：2020-08-18 17:17:02.314000+00:00
邮件内容:
收到！谢谢Huili，明天现场有结果会随时更新。
Guannan

====第20封邮件====

发件人：Shi Guannan
发送时间：2020-08-19 16:12:27.743000+00:00
邮件内容:
Hi Huili，
今天上午在电科机房现场，分别对5台VDI激活失败虚机进行了如下测试：
1.       查看5台问题设备keyholder当前状态
*  问题虚机中均有2个keyholder文件，含f912421d-3371-f33c-3cf8-22df25e5851f.xml，如下图
*  此状态下VDI激活失败（Create Marker success 但客户端激活失败） 
2.       升级CmitClient版本
*  在其中一台问题虚机上直接双击安装CmitClient 3.1.0.5版本
*  安装完成后等待约1分钟，激活成功
*  激活成功后查看keyholder状态，增加一个451b310a开头的xml文件，之前2个keyholder状态没有变化
3.       安装V2020-L中的正式多级keyholder
*  将keyholder文件拷贝至其中一台问题虚机的ClipSVC\Install\KeyHolder文件夹中，重新启用 clipsvc服务
*  此时查看ClipSVC\Archivel\KeyHolder中的keyholder文件没有变化，激活失败
*  尝试将ClipSVC\Archivel\KeyHolder文件夹下2个xml文件删除，再重新启用clipsvc服务，此时Archive\Keyholder文件夹下重新生成f912421d-3371-f33c-3cf8-22df25e5851f.xml
*  等待约1分钟后激活成功
*  激活成功后查看keyholder状态，增加一个451b310a开头的xml文件
以上为今天在电科现场的测试结果。5台问题虚机均已通过升级CmitClient或重装keyholder的方式激活成功。
另外，电科VDI V0-H升级到V2020-L的详细情况如下：
*  由于使用纯净版V2020-L升级后，会造成电科办公软件运行必要的注册表键值丢失，售前team为电科定制了一版V2020-L镜像作为升级介质。
*  升级镜像定制步骤为：进入audit mode增加/修改注册表键值，然后封装系统抓取定制镜像。
如需抓取相关log或数据，可尝试使用相同的定制升级镜像在本地复现问题。
Guannan

====第21封邮件====

发件人：Shi Guannan
发送时间：2020-08-20 18:18:25.219000+00:00
邮件内容:
Hi Huili，
电科的VDI激活已经在本地复现，详细步骤如下：
1.       虚机安装纯净版V0-H；
2.       将C:\recovery 文件夹移动到其他位置（如果不移动会导致升级失败）；
3.       挂载售前Team 定制的V2020-L，双击setup.exe，选择保留文件和应用的方式 升级系统；
4.       升级完成后，配置VDI mode及host地址，激活失败，与电科现场问题现象一致。
*  客户端uuid 为D8E2c469-xxxx，许可证状态为“通知“；
*  Portal 端激活记录为“创建授权码成功“。
请帮忙确认问题原因，如果需要提供其他信息或log请随时提出。
谢谢!
Guannan

====第22封邮件====

发件人：Yao Huili
发送时间：2020-08-24 09:20:55.106000+00:00
邮件内容:
Hi Guannan， 
1.    如你之前的测试， 安装纯净的V0-H虚机离线升级到纯净的V2020-L，升级后直接配置vdi模式和VDI服务器地址，激活成功。
2.    电科VDI 环境中，成功激活1台，其他3台激活失败。存在激活成功的案例，激活失败并非必现问题。
3.    在公司内使用定制镜像升级后，重现激活失败问题。
综合上述现象，建议检查定制的V2020-L镜像。 

====第23封邮件====

发件人：Shi Guannan
发送时间：2020-08-24 15:25:19.663000+00:00
邮件内容:
Hi Huili,
现在已经很明显VDI激活问题和定制的V2020-L镜像有关系，也正如最开始我们测试的工行基线版本也出现了相同的VDI激活问题。
目前可以提供的信息是  电科定制项和工行定制项是完全不同的，且都没有对激活相关的内容进行修改。
我们未知的还需要解决的问题是：
*  使用定制的V2020-L升级为什么会出现VDI激活问题？
*  或，如何制作定制的V2020-L不会造成升级后的VDI激活问题？
*  或，如何检查定制的V2020-L有什么问题？
目前已知有两个方式可以作为workaround修复已经出现的VDI激活问题：
1.       更新CmitClient客户端版本到3.1.0.5
2.       删除ClipSVC\Archivel\KeyHolder文件夹下已经存在的keyholder，重新安装V2020-L中的正式多级keyholder
相信这两个workaround可以作为排查问题原因的线索，但不是最终解决方案。
电科定制的v2020-L镜像和问题复现环境现在都在本地，有什么需要抓取的log 可随时提出。谢谢！
Guannan

====第24封邮件====

发件人：Yao Huili
发送时间：2020-08-24 16:49:29.823000+00:00
邮件内容:
Hi Guannan， 
请提供一下定制的镜像。 

====第25封邮件====

发件人：Yao Huili
发送时间：2020-08-25 11:30:38.446000+00:00
邮件内容:
Hi Guannan
初步判断是升级后没有重置Keyholder文件导致，V2020-L的标准版本中有相关操作流程。
Huili 

====第26封邮件====

发件人：Shi Guannan
发送时间：2020-08-27 17:08:46.639000+00:00
邮件内容:
Hi  Huili ,
感谢回复。
我理解目前电科出现的VDI激活问题与定制过的 V2020-L镜像有关。
CMGE的客户（尤其是体量大的用户）普遍有定制镜像的需求，所以仍有如下几个疑问：
1.      是否有办法在定制过的V2020-L镜像中加入重置keyholder文件的操作？如何操作？
2.      定制的V2020-L镜像直接部署到客户端是否会影响激活？
3.      定制的镜像除了缺少重置keyholder文件的操作以外，与标准版V2020-L还有那些区别？是否会对系统造成其他影响？
谢谢！
Guannan

====第27封邮件====

发件人：Yao Huili
发送时间：2020-08-28 16:17:40.100000+00:00
邮件内容:
Hi Guannan, 
可通过附件中文件及下述步骤在定制镜像中加入重置keyholder 的操作。 经你拷贝给我的镜像直接部署理论上不会影响激活。 
如有问题，请随时联系。 谢谢
1． Mount install.wim文件
2． 复制附件中文件夹\Scripts，到\Windows\Setup\
3． 复制附件中文件UpgradeConfig.exe，到\Windows\Temp\
4． 复制附件中文件UpgradeSchdTask.exe，到\Windows\Temp\
5． Unmount并commit install.wim文件
6． 制作ISO文件。
Br. Huili 

====第28封邮件====

发件人：Shi Guannan
发送时间：2020-09-07 11:23:38.643000+00:00
邮件内容:
Hi Huili，
感谢回复，已确认电科接受此方案。
感谢支持。
Guannan
