邮件主题：Re:回复：[案例号: CAS-11760-F7B5H0 ] % 国网-国网国际发展有限公司用户反馈电脑关机时出现蓝屏的问题 % 初次响应 CMIT: 0001575

====第1封邮件====

发件人：Wei Liang
发送时间：2024-07-16 15:15:01.814000+00:00
邮件内容:
王先生 您好：
感谢您的电话接听。
根据您提供的信息，我谨在此阐述我们双方针对这个问题所涉及范围界定：
问题定义:
国网国际用户反馈有多台设备关机时出现蓝屏问题，核实蓝屏代码为DRIVER_POWER_STATE_FAILURE，需要协助排查。
问题范围:
我们将协助您分析处理上述问题，并对定义的问题给予最大的技术支持。
如果能及时解决问题，或问题属于产品设计的行为，或问题涉及到三方，我们将考虑关闭案例。如果存在多个问题，则我们考虑拆分案例进行分析。
接下来，我们将开始合作解决这个问题。如果您对以上的问题范围界定有任何异议，请尽快告知。如果您有其他任何疑问。也欢迎随时与我联系。
请您从以下链接下载相关的工具，在问题设备上按照相关操作收集日志，并通过CDUC上传。
CMGElogCollectorV2工具： https://cduc.cmgos.com/download.php?id=1458&token=PcEQH06HPAu7P3p5paWBqHjWbwlqLJdc
1）找一台问题设备，解压CMGETool后双击运行CMGELogCollectorV2.exe，选择内存转储配置，按照以下设置配置完全内存转储。
2）点击设置完成后，需要重启设备使设置生效。
3）先关机复现蓝屏问题，待设备保存dump后，是否能自动重启进入系统，如果无法自动重启，等待一段时间后强制重启。
4）在问题设备上，解压CMGETool后双击运行CMGELogCollectorV2.exe，勾选所有选项，点击收集获取对应的系统日志，将生成的日志压缩包通过CDUC上传。
5）查看C:\Windows\memory.dmp文件，确认此文件是最新生成的，将memory.dmp文件压缩后通过CDUC上传。
日志上传方法：
用户名：gwguoji
密码：gwguoji
注意：添加文件，点击上传后，跳转到新的页面点击保存。

====第2封邮件====

发件人：Wei Liang
发送时间：2024-07-17 15:54:03.714000+00:00
邮件内容:
王先生 您好：
你提供的日志已经收到，我们正在分析排查，有任何进展会及时与您沟通，谢谢。

====第3封邮件====

发件人：王麦熟
发送时间：2024-07-18 10:38:50.008000+00:00
邮件内容:
你好，我想咨询一下，什么时候能出结果和方案，有一台电脑回复出厂设置，过几天又重新复现管理关不上的问题
---- 回复的原邮件 ----

====第4封邮件====

发件人：Wei Liang
发送时间：2024-07-18 11:33:20.413000+00:00
邮件内容:
王先生 您好：
查看您提供的dump文件，显示的蓝屏代码为9f，这表明表明驱动程序处于不一致或无效的电源状态。
查看详细的dump分析信息，arg1等于4，出现这个蓝屏问题的原因是电源状态转换超时，等待与 PnP 子系统同步。
查看资源锁的情况，也显示了与thread ffffbc8fcab5a580有关。
排查dump 中的具体信息，查看thread ffffbc8fcab5a580的情况。
查询其WaitBlockList情况，显示Waiters情况，都是在等待ndis!KWaitEventBase<wistd::integral_constant<enum _EVENT_TYPE,0> >::Wait+0x28
这显示与NDIS有关。NDIS 的全称是 "Network Driver Interface Specification"，即“网络驱动程序接口规范”，是一种标准化接口规范，用于在操作系统上实现网络设备驱动程序。
查看NDIS中加载的相关协议驱动情况，查看是否有三方的驱动信息。
这三个对应的驱动是360LanProtect.sys、EdpPcap.sys和npf.sys。查看驱动详细信息如下。
EdpPcap.sys和npf.sys驱动的时间较老，建议询问三方厂商是否可以升级这两个驱动版本。也可以测试不安装这两个驱动是否能正常关机。
查询到EdpPcap.sys是北信源的驱动，而npf.sys应该是三方的一个抓包工具的驱动。

====第5封邮件====

发件人：Wei Liang
发送时间：2024-07-18 14:34:16.921000+00:00
邮件内容:
王先生 您好：
感谢您的电话接听。
如上一封邮件所说，dump日志显示蓝屏与NDIS有关，这是网络相关的问题。
除了排查三方驱动EdpPcap.sys和npf.sys，也可以尝试更新网卡驱动，验证是否可以解决问题。

====第6封邮件====

发件人：Wei Liang
发送时间：2024-07-22 16:06:12.976000+00:00
邮件内容:
王先生 您好：
刚刚给您的电话没有接通。
来信是想询问当前案例进展。如上次的邮件所说，dump日志显示蓝屏与NDIS有关，这是网络相关的问题。
在排查三方驱动EdpPcap.sys和npf.sys后，也可以尝试更新网卡驱动，请问这些验证测试是否可以解决蓝屏问题。
如果有任何进展或疑问可以回复此邮件，谢谢。

====第7封邮件====

发件人：Wei Liang
发送时间：2024-07-23 10:38:14.822000+00:00
邮件内容:
王先生 您好：
感谢您的电话接听。
如电话中所说，您可以先更新网卡驱动，再测试验证是否能解决关机时蓝屏的问题。
从dump信息看，npf.sys驱动有可能是360安全软件引入的，也可以和应用厂商沟通这个问题，是否有解决方法。
至于其他的设备出现的蓝屏问题，请您按照最开始的邮件说明，将蓝屏dump文件提供给我们进一步排查，谢谢。

====第8封邮件====

发件人：Wei Liang
发送时间：2024-07-24 16:46:57.156000+00:00
邮件内容:
王先生 您好：
我现在还没有看到您上传的日志，等您上传完毕后我再下载排查。您现在提供的dump日志是不是新的问题设备吗？还是就是原先的那一台设备？
原先的那台设备的测试结果怎样，有什么进展？

====第9封邮件====

发件人：Wei Liang
发送时间：2024-07-24 17:17:13.767000+00:00
邮件内容:
王先生 您好：
如果上传数据确实太慢，您可以先尝试在本地压缩后再上传，先测试dump文件压缩后可以节省很多空间。

====第10封邮件====

发件人：Wei Liang
发送时间：2024-07-24 17:23:42.345000+00:00
邮件内容:
王先生 您好：
您上传的日志已经收到，我们正在分析排查，有任何进展会及时与您沟通，谢谢。

====第11封邮件====

发件人：Wei Liang
发送时间：2024-07-25 11:53:18.447000+00:00
邮件内容:
王先生 您好：
排查您新上传的dump文件，与上一次的问题设备一样，报错9f，也是由于NDIS的相关问题导致的蓝屏问题。
在排查三方驱动npf.sys后，也可以尝试更新网卡驱动，验证是否可以解决蓝屏问题。
从dump信息看，npf.sys驱动有可能是360安全软件引入的，也可以和应用厂商沟通这个问题，是否有解决方法。
dump具体分析：
显示的蓝屏代码为9f，这表明表明驱动程序处于不一致或无效的电源状态。
查看详细的dump分析信息，arg1等于4，出现这个蓝屏问题的原因是电源状态转换超时，等待与 PnP 子系统同步。
查看资源锁的情况，也显示了与thread ffffd90923d94600有关。
排查dump 中的具体信息，查看thread ffffd90923d94600的情况。
查询其WaitBlockList情况，显示Waiters情况，都是在等待ndis!KWaitEventBase<wistd::integral_constant<enum _EVENT_TYPE,0> >::Wait+0x28
这显示与NDIS有关，NDIS 的全称是 "Network Driver Interface Specification"，即“网络驱动程序接口规范”，用于在操作系统上实现网络设备驱动程序。
查看NDIS中加载的相关协议驱动情况，查看是否有三方的驱动信息。
这三个对应的驱动是360LanProtect.sys、EdpPcap.sys和npf.sys。查看驱动详细信息如下。
EdpPcap.sys和npf.sys驱动的时间较老，建议询问三方厂商是否可以升级这两个驱动版本。
查看网卡驱动版本，也建议升级网卡驱动后观察是否解决问题。

====第12封邮件====

发件人：Wei Liang
发送时间：2024-07-31 17:38:19.797000+00:00
邮件内容:
王先生 您好：
感谢您的电话接听。
如电话中所说，现在判断是npf.sys驱动导致的关机蓝屏问题，您可以在问题设备上测试将npf.sys驱动重命名后，再测试是否会出现关机蓝屏问题。
如果无法重命名npf.sys，可以在PE环境下重命名此文件。npf.sys文件路径为：C:\Windows\System32\drivers\npf.sys
也可以观察、跟踪其他问题设备在更新了网卡驱动后，再次出现蓝屏问题的概率。
为了测试是哪个应用引入的npf.sys驱动，您可以安装纯净的操作系统后，再逐一安装所需的应用，确认是哪一个应用需要npf.sys驱动。

====第13封邮件====

发件人：Wei Liang
发送时间：2024-08-02 16:49:41.596000+00:00
邮件内容:
王先生 您好：
刚刚给您的电话没有接通。
测试重命名npf.sys驱动后，是否可以解决关机蓝屏问题。
是否已经排查到是哪一个三方应用引入的npf.sys驱动，与三方应用厂商沟通是否能升级驱动或者有其他的驱动替代npf.sys驱动。

====第14封邮件====

发件人：Wei Liang
发送时间：2024-08-05 17:51:11.388000+00:00
邮件内容:
王先生 您好：
感谢您的电话接听。
经过您的测试排查，确认npf.sys驱动是北信源管控软件引入的。请您与北信源沟通是否可以升级此驱动，或者使用其他的抓包工具替代npf.sys驱动功能。
如果无法确认是否一定需要npf驱动，您可以尝试删除npf.sys驱动，确认是否能解决关机蓝屏问题，且管控软件能正常工作，不影响用户正常使用设备。

====第15封邮件====

发件人：Wei Liang
发送时间：2024-08-07 15:04:38.775000+00:00
邮件内容:
王先生 您好：
感谢您的电话接听。
如电话中所说，请您测试在问题设备上移除了npf.sys驱动后，确认是否能解决蓝屏问题，从dump分析和实际测试两方面明确是npf.sys驱动导致的关机蓝屏问题。
如果问题设备删除npf.sys驱动后还是出现蓝屏问题，您可以再次将蓝屏dump压缩后发送给CMIT进一步排查。
如测试明确确认了是npf驱动导致的蓝屏问题，再与三方应用厂商沟通是否可以升级此驱动，或者使用其他的抓包工具驱动替代npf.sys驱动功能

====第16封邮件====

发件人：Wei Liang
发送时间：2024-08-08 17:06:26.635000+00:00
邮件内容:
王先生 您好：
下载了您提供的最新的memory.dump文件，加载这个dump显示数据损坏。
无法基于此dump进一步排查，而且此dump文件压缩后只有26MB左右，与上两个dump文件压缩后的大小有较大的差异。
请您在问题设备上删除这个有问题的dump文件，再次复现蓝屏问题后提供新的dump日志给CMIT进一步分析。

====第17封邮件====

发件人：Wei Liang
发送时间：2024-08-13 11:19:05.320000+00:00
邮件内容:
王先生 您好：
感谢您的电话接听。
从您提供的系统日志可以看到最新的出现蓝屏的时间是8月9日17点46分多，更详细的问题排查还是需要拿到对应的dump文件分析。
您已经删除了此dump文件，需要等待下一次再次出现蓝屏问题后，获取最新的dump文件提供给我们进一步排查问题，谢谢。

====第18封邮件====

发件人：Wei Liang
发送时间：2024-08-15 15:54:27.727000+00:00
邮件内容:
王先生 您好：
来信是想咨询当前案例进展情况。
近期是否有已经删除了npf.sys驱动的设备再次出现蓝屏问题？
如果有问题设备出现蓝屏问题，请您将问题设备的C:\Windows\memory.dmp文件压缩后，通过CDUC上传，提供给我们进一步排查，谢谢。

====第19封邮件====

发件人：Wei Liang
发送时间：2024-08-22 16:56:20.037000+00:00
邮件内容:
王先生 您好：
来信是想咨询当前案例进展情况。
如果有问题设备出现蓝屏问题，请您将问题设备的C:\Windows\memory.dmp文件压缩后，通过CDUC上传，提供给我们进一步排查，谢谢。

====第20封邮件====

发件人：Wei Liang
发送时间：2024-08-26 16:10:06.634000+00:00
邮件内容:
王先生 您好：
查看您最新的dump文件，还是0x9f错误，电源状态转换因等待与 PnP 子系统同步超时导致了蓝屏。
出现timeout超时的原因是 ndis!Ndis::BindEngine::ApplyBindChanges递归调用造成线程死锁，这个是由miniport binding的legacy WinPcap protocol (npf) driver造成的。
查看npf.sys驱动情况：
查询了一些资料，可以尝试使用npcap替代winpcap功能：
https://npcap.com/#download
在安装npcap过程中，注意选择“WinPcap API-compatible Mode”，它会将自己的驱动替换npf.sys驱动。

====第21封邮件====

发件人：Wei Liang
发送时间：2024-08-29 15:24:50.644000+00:00
邮件内容:
王先生 您好：
查看您最新上传的dump文件，还是0x9f错误，只不过具体的报错参数有一点变化。
但最终还是出现 ndis!Ndis::BindEngine::ApplyBindChanges递归调用造成线程死锁，确认是由miniport binding的legacy WinPcap protocol (npf) driver造成的。
这一次很详细的能看到360safe目录中的模块Packet.dll调用了npf驱动。
后续建议：
1）与360方面确认有哪些功能或者策略修改需要使用npf驱动，是否可以对相关策略做调整。
2）尝试使用npcap替代winpcap功能，验证是否解决问题。

====第22封邮件====

发件人：Wei Liang
发送时间：2024-09-02 15:19:52.760000+00:00
邮件内容:
王先生 您好：
感谢您的电话接听。
我在本地测试安装npcap时，提示有其他进程占用npf驱动时，点击“确定”后，npcap后续按照正常的流程安装成功，且C:\Windows\system32\drivers\npf.sys驱动被删除。
您也可以按照npcap的弹窗提示，在“任务管理器”中结束对应的进程后，再点击“确定”按钮，完成npcap的安装。
如果针对当前案件需要我们协助，可以通过邮件联系我们，谢谢。

====第23封邮件====

发件人：Wei Liang
发送时间：2024-09-04 15:38:13.038000+00:00
邮件内容:
王先生 您好：
来信是想咨询当前案例进展情况。
如果针对当前案件需要我们协助，可以通过邮件联系我们，谢谢。

====第24封邮件====

发件人：Wei Liang
发送时间：2024-09-05 17:33:13.902000+00:00
邮件内容:
王先生 您好：
如电话中所说，在问题设备上的360模块的地址为C:\Program Files (x86)\360\360safe\safemon\seccscan\Packet.dll。从对应路径上判断，这个360模块名称可能为seccscan。
可以请360人员确认这个模块功能及配置。
如果针对当前案件需要我们协助，可以通过邮件联系我们，谢谢。

====第25封邮件====

发件人：Wei Liang
发送时间：2024-09-09 15:10:57.429000+00:00
邮件内容:
王先生 您好：
来信是想咨询当前案例进展情况。
如果针对当前案件需要我们协助，可以通过邮件联系我们，谢谢。

====第26封邮件====

发件人：Wei Liang
发送时间：2024-09-12 11:10:01.001000+00:00
邮件内容:
王先生 您好：
来信是想咨询当前案例进展情况。
如果针对当前案件需要我们协助，可以通过邮件联系我们，谢谢。

====第27封邮件====

发件人：Wei Liang
发送时间：2024-09-14 14:42:54.779000+00:00
邮件内容:
王先生 您好：
感谢您的电话接听。
经过您的同意，我将暂时归档此案例。
工单的归档并不会影响我们为您提供技术支持服务，如有其他问题，您可以随时联系我们。
案例总结：
----
问题定义：
国网国际用户反馈有多台设备关机时出现蓝屏问题，核实蓝屏代码为DRIVER_POWER_STATE_FAILURE，需要协助排查。
问题总结：
分析多台问题设备的dump日志，确认是三方应用驱动npf.sys导致ndis!Ndis::BindEngine::ApplyBindChanges递归调用造成线程死锁。WinPcap 的 NPF 驱动程序是基于 NDIS 5.x 版本进行开发的，目前更推荐使用Npcap作为Winpcap的替代方案，Npcap是基于NDIS6.x版本进行开发的，提供了更好的性能、兼容性和安全性。
请用户按照以下建议在问题设备上测试，验证是否可以解决问题。用户暂时无法测试，案例归档。
测试建议：
1）与360方面确认有哪些功能或者策略修改需要使用npf驱动，是否可以对相关策略做调整。
2）尝试使用npcap替代winpcap功能，验证是否解决问题。
以上，如您后续有任何问题，可随时与我们联系，谢谢。

====第28封邮件====

发件人：王麦熟
发送时间：2024-12-12 16:03:21.372000+00:00
邮件内容:
您好，危亮工程是
---- 回复的原邮件 ----

====第29封邮件====

发件人：王麦熟
发送时间：2024-12-12 16:20:15.588000+00:00
邮件内容:
您给联系了吗 
---- 回复的原邮件 ----

====第30封邮件====

发件人：王麦熟
发送时间：2024-12-13 11:18:41.118000+00:00
邮件内容:
危工程师
   给您发了抓包 您给分析谢谢 
在 2024-12-12 16:18:39，"王麦熟" <w13731242724@163.com> 写道：
	您给联系了吗 
	---- 回复的原邮件 ----
