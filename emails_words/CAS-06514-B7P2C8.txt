邮件主题：回复: [案例号: CAS-06514-B7P2C8 ] % |P2|ICBC|工行中心领导反馈安装edge失败 % 初次响应 CMIT:0001161

====第1封邮件====

发件人：Li Qi
发送时间：2022-06-27 17:56:28.403000+00:00
邮件内容:
何先生，您好：
       如刚才电话沟通，我谨以此封邮件阐述我们双方针对这个问题所涉及范围界定： 
问题定义: 
用户反馈升级至V2020-L后无法安装edge，另外system32没有权限。
问题范围: 
我们将协助您分析处理上述问题，并对定义的问题给予最大的技术支持。 
如果能及时解决问题，或问题属于产品设计的行为，或问题涉及到三方，我们将考虑关闭案例。如果存在多个问题，则我们考虑拆分案例进行分析。 
接下来，我们将开始合作解决这个问题。如果您对以上的问题范围界定有任何异议，请尽快告知。如果您有其他任何疑问。也欢迎随时与我联系。
下一步动作：
请提供您需要安装的edge安装包，并上传到CDUC。
日志上传方法：
您可以登陆https://cduc.cmgos.com <https://cduc.cmgos.com/> ，通过数据上传系统上传您所收集的日志信息。
用户名：icbchhc
密码：icbchhc
注意：添加文件，点击上传后，跳转到新的页面点击保存。

====第2封邮件====

发件人：Li Qi
发送时间：2022-06-27 17:59:19.729000+00:00
邮件内容:

====第3封邮件====

发件人：Li Qi
发送时间：2022-06-29 10:47:50.419000+00:00
邮件内容:
何先生，您好：
       已收到您上传的edge安装包，在本地进行了复现安装，可以安装成功，通过对整个安装过程的分析，MSIinstaller在解压文件至本地时出现报错，因此下一步需要您使用附件的procmon工具进行安装失败过程的抓取。并将日志上传至CDUC系统。谢谢
部分日志内容：
安装成功的过程日志：
下一步动作：
       使用附件工具process monitor进行安装失败过程的日志抓取，步骤如下：
Procmon收集方法：
a)      保存附件processmonitor.zip至本地计算机
b)      解压完成后，双击执行procmon.exe
c)      显示如下界面，并点击capture按钮，先暂停收集，准备进行捕获
d)      点击clear按钮，清空当前窗口，然后点击capture按钮，开始捕获
e)     待问题复现后（即安装失败出现报错信息），再次点击capture按钮，停止捕获
f)      点击File menu, 点击Save. 选择"All events" and "Native Process Monitor Format (PML)"点击OK，并将此文件回传给我进行分析，谢谢

====第4封邮件====

发件人：Li Qi
发送时间：2022-06-30 10:14:30.936000+00:00
邮件内容:
何先生，您好：
       如刚才电话沟通，请在安装失败的电脑上帮忙收集如下路径日志：C:\ProgramData\Microsoft\EdgeUpdate\Log\MicrosoftEdgeUpdate.log

====第5封邮件====

发件人：Li Qi
发送时间：2022-07-01 15:42:42.093000+00:00
邮件内容:
何先生，您好：
       如刚才电话沟通，经测试，临时卸载TMS后可以正常安装edge，以下为该案例的总结邮件，请您知悉：
Case No：CAS-06514-B7P2C8
问题描述：
================================
用户反馈升级至V2020-L后无法安装edge，另外system32没有权限。
问题分析：
================================
经分析，edge在安装过程中需要进行诸如环境检查的前置条件判断，此问题的发生是由于前置条件未通过，安装进程直接退出导致。从收集的procmon日志查看，可以看到当进程创建时，有schk.dll的参与。进而该进程就直接退出了。并不像正常安装时，MicrosoftEdgeUpdate.exe在进行一系列的检查安装动作。经后续测试，schk.dll属于TMS组件，临时卸载TMS后，可正常安装edge。
问题总结：
================================
后续，建议在允许的情况下临时卸载TMS后进行edge安装，待安装完成，可继续使用TMS。
经用户确认，暂无其他问题，此case将做关闭处理。
以上为此问题的案例总结，如有任何问题，可随时与我们联系，谢谢

====第6封邮件====

发件人：Li Qi
发送时间：2022-08-02 15:55:36.787000+00:00
邮件内容:
Hi，许先生 & 毓杰：
       收到毓杰发送的edge安装成功日志，通过对比，在执行程序运行过程中，并未找到schk.dll的参与，具体可对比之前的回复邮件内容。
同样，在安装过程的其他动作中，也并未检测到schk.dll的参与，全部由windows组件完成。

====第7封邮件====

发件人：win10升级支持
发送时间：2022-08-05 09:21:53.136000+00:00
邮件内容:
关于edge相关问题，公司答复如下： 
一、原理机制 
DLL注入就是让目标进程加载我们的功能DLL； 
产品实现进程注入的方法： 
实现原理简单说，就是目标进程运行后，在其内存中申请一段空间，将需要注入的DLL路径写入到申请的空间中，然后在目标进程中创建一个线程，该线程来加载注入的DLL，以此来实现DLL注入到目标线程的操作。 
产品使用pcit.exe/pcit_x64.exe来完成32位/64位进程的DLL注入的操作； 
具体实现如下： 
1.  打开已经运行的目标进程，获取该进程操作句柄；（调用API函数——OpenProcess） 
2.  在目标进程中申请一段空间；（调用API函数——VirtualAllocEx） 
3.  将需要注入的DLL路径写入刚刚申请的空间中；（调用API函数——WriteProcessMemory） 
4.  通过访问系统的Kernel32.dll，获取加载DLL所需的API函数LoadLibraryA； 
5.  通过访问系统的ntdll.dll，获取启动线程所需的API函数NtCreateThreadEx； 
6.  在目标进程中创建一个线程（NtCreateThreadEx），在该线程中调用LoadLibraryA来加载需要注入的DLL； 
二、其他补充说明 
注入机制是一张windows提供的常规手段。 
Windows系统中hook（钩子）是微软提供的一种常规的技术手段，通过这种技术可以对几乎所有的Windows 系统中的消息进行拦截、监视、处理。 
TMS 涉及注入功能有DLP打印和文件审计功能，如果有DLP打印和文件审计策略，则会向所有启动的进程中注入，进行监控。 
TMS运行5年过程中，没有发现由于注入，导致操作系统补丁安装失败的问题。 
三、关于问题处置方案 
按照公司评估，注入机制并无问题。 
当前影响edge升级，公司建议从edge方面进行调查，看能否识别到TMS注入机制存在异常逻辑。 
如果直接从TMS角度兼容此问题，我们的方案就是对有关进程进行加白例外。 
四、其他补充 
针对领导提出的问题分析规范化管理。公司说明如下： 
项目组一直严格遵循问题处理时效性的要求，针对疑难问题，也会逐一说明问题原因、解决方案以及版本计划。 
随版本解决时，均经过公司内部严格测试，且也会对问题周边进行必要验证。 
后续我们可就问题处理机制进行进一步规范化管理，针对相关问题可随时做沟通讨论。 
以上  
​
	-----原始邮件-----
	
====第8封邮件====

发件人：Li Qi
发送时间：2022-08-25 11:47:44.908000+00:00
邮件内容:
许先生，您好：
       如之前电话沟通，可参见附件的说明报告来查看该案例的具体分析结论，由于当前暂无操作系统方面的排查工作，经您的同意，此case将暂做归档处理。以下为案例总结，请您知悉：
Case No：CAS-06514-B7P2C8
问题描述：
=================
用户反馈安装edge失败。
问题分析：
=================
具体可参见附件报告内容
问题总结：
=================
经用户同意，此case暂做归档处理。 
以上为此问题的案例总结，如有任何问题，可随时与我们联系，谢谢
