邮件主题：回复: 【外来邮件，注意核实】回复: [案例号: CAS-08159-C0F8X4 ] % |P2|ICBC|陕西分行用户反馈安装12月补丁黑屏问题 % 初次响应 CMIT:0001353

====第1封邮件====

发件人：Wei Liang
发送时间：2023-02-08 17:57:44.862000+00:00
邮件内容:
许先生 您好：
感谢您的电话接听。
根据您提供的信息，我谨在此阐述我们双方针对这个问题所涉及范围界定：
问题定义:
陕西分行用户反馈有一部份设备安装12月补丁（KB5021237）完成，提示重启后出现黑屏问题，只能强制重启设备，又再次提示安装12月补丁，需要协助分析。
问题范围:
我们将协助您分析处理上述问题，并对定义的问题给予最大的技术支持。
如果能及时解决问题，或问题属于产品设计的行为，或问题涉及到三方，我们将考虑关闭案例。如果存在多个问题，则我们考虑拆分案例进行分析。
接下来，我们将开始合作解决这个问题。如果您对以上的问题范围界定有任何异议，请尽快告知。如果您有其他任何疑问。也欢迎随时与我联系。
请按照以下操作先配置手动触发蓝屏操作，再次复现黑屏问题后，手动触发蓝屏并收集相关的日志。
1）运行CMGELogCollectorV2.exe，选择内存转储配置，勾选“我已得到神州网信工程师指导”，再勾选“蓝屏后自动重启”和“设置手动触发内存转储”，可以根据C盘实际可用空间情况配置转储文件的路径（确保C盘可用空间大于当前设备的物理内存容量），点击“设置”后，按照提示重启计算机生效。
2）重启计算机使配置生效后，再次安装12月补丁，并按照提示重启，在重启出现黑屏时，通过键盘组合键左shift +右shift 按住不放，连按两次波浪号键“~”（Esc下方），手动触发蓝屏自动重启，生成memory.dmp文件。
3）触发蓝屏自动重启后，查看是否生成C:\Windows\memory.dmp文件，将memory.dmp文件压缩后通过sftp上传。
4）再次运行CMGELogCollectorV2.exe，在系统日志收集界面，勾选所有选项，点击收集获取对应的系统日志，将生成的日志压缩包通过CDUC上传。

====第2封邮件====

发件人：Wei Liang
发送时间：2023-02-09 18:05:37.908000+00:00
邮件内容:
许先生 您好：
分析了您上传的设备日志，其中黑龙江和河南、福建漳州分行的几台设备的日志均显示，补丁在重启配置过程中“Network Drivers”出现错误，更新失败出现回滚。
错误日志提示如下：
具体的原因和进一步的解决方法有可能需要抓取更详细的日志进行排查分析，其他的日志还在对比查看。
而且在系统日志中发现这些设备有大量的NTFS报错：
建议先备份数据，然后运行chkdsk /r /f C: 尝试进行修复开机时磁盘检查的提示，但这个有数据丢失的风险的，也需要重启。

====第3封邮件====

发件人：Liu Jian
发送时间：2023-02-10 11:04:02.620000+00:00
邮件内容:
目前其他分行帮助进行环境测试结果如下，仅供参考：
i.	目前出现问题的都是台式机，型号联想920t和930t，用笔记本测试正常；
ii.	现象是更新后提示重启，重启后进入系统时黑屏，黑屏后强制重启提示补丁安装失败且回退，部分机器黑屏后无法正常进入系统；
iii.	测试离线更新包手动安装，同样黑屏，黑屏后强制重启，重启后能够进入系统，补丁安装成功；
iv.	测试1月离线更新包，暂无反馈；
Thank you for your time!
----------
Best Regards,
Carl Liu（刘健）
Mobile: + 86 13810968329 | Email: liujian@cmgos.com

====第4封邮件====

发件人：Wei Liang
发送时间：2023-02-10 12:00:14.334000+00:00
邮件内容:
许先生 您好：
感谢您的电话接听。
昨天和今天上传的日志总计为8台设备的日志，对应的分行的计算机名、问题情况、修复建议如下：
分行
计算机名
问题分析小结
修复建议（具体操作见下方说明）
黑龙江分行
LJFHRENHF1
组件损坏
组件修复
福建宁德分行
FJNDHUANGDQ1
文件系统损坏、“Network Drivers”失败
磁盘修复
福建漳州分行
FJZZLINMC1
文件系统损坏、“Network Drivers”失败
磁盘修复
河南三门峡分行
HNSMRENSP1
文件系统损坏、“Network Drivers”失败
磁盘修复
河南三门峡灵宝支行
HNSMHET1
文件系统损坏、组件损坏
磁盘修复、组件修复
河南三门峡分行
HNSMZHANGWF2
文件系统损坏、“Network Drivers”失败
磁盘修复
陕西宝鸡分行
XXBJZHOUW02
文件系统损坏、“Network Drivers”失败
磁盘修复
陕西宝鸡分行
XXBJLIUWY03
文件系统损坏、“Network Drivers”失败
磁盘修复
磁盘修复操作：
1）建议先备份数据；
2）以管理员权限打开cmd命令行，运行chkdsk /r /f C: 尝试进行修复，按照提示重启，在重新启动过程中会尝试文件系统修复操作；
3）文件系统修复完成后，以管理员权限打开cmd命令行，运行命令：sc config netsetupsvc type= own
4）然后安装补丁并重启，看是否可以完成配置；
5）假如补丁更新完成，再运行命令还原配置：sc config netsetupsvc type= share，如果还是无法更新补丁，需要尝试抓取重启应用补丁的过程日志。
组件修复操作：
1）找一台差不多补丁级别，但是成功安装了KB5021237的设备，将C:\Windows共享；
2）确保可以通过\\IP地址的方式访问到这个源，以管理员权限打开cmd命令行，运行如下命令尝试修复： 
Dism /Online /Cleanup-Image /RestoreHealth /Source:\\xxx.xxx.xxx.xxx\c$\windows /LimitAccess  （xxx.xxx.xxx.xxx指共享的设备的IP地址）
3）如果能顺利执行完成，请再安装补丁，看是否能完成补丁更新。
详细日志分析（以FJNDHUANGDQ1为例）：
安装补丁报错是0x800f0922：
CBS日志显示是和网络驱动更新相关，可能是某个网络服务或者三方软件相关，但系统中禁用了许多服务，不好直接判断是什么导致的：
另外，系统日志中有大量NTFS报错，建议先进行文件系统修复操作：

====第5封邮件====

发件人：Wei Liang
发送时间：2023-02-10 13:58:53.537000+00:00
邮件内容:
许先生 您好：
下表更新了当前收集了日志的设备的机型，请您帮忙了解这些设备的使用场景与其他设备的区别，具体的修复建议见上一封邮件。
分行
计算机名
机型
问题分析小结
黑龙江分行
LJFHRENHF1
OptiPlex 7480 AIO
组件损坏
福建宁德分行
FJNDHUANGDQ1
ThinkCentre M920t
文件系统损坏、“Network Drivers”失败
福建漳州分行
FJZZLINMC1
ThinkCentre M920t
文件系统损坏、“Network Drivers”失败
河南三门峡分行
HNSMRENSP1
ThinkCentre M920t
文件系统损坏、“Network Drivers”失败
河南三门峡灵宝支行
HNSMHET1
ThinkCentre M920t
文件系统损坏、组件损坏
河南三门峡分行
HNSMZHANGWF2
ThinkCentre M920t
文件系统损坏、“Network Drivers”失败
陕西宝鸡分行
XXBJZHOUW02
OptiPlex 7070
文件系统损坏、“Network Drivers”失败
陕西宝鸡分行
XXBJLIUWY03
OptiPlex 7070
文件系统损坏、“Network Drivers”失败

====第6封邮件====

发件人：Liu Jian
发送时间：2023-02-10 17:14:27.443000+00:00
邮件内容:
信息同步：
*	1月补丁离线安装包现象与12月补丁离线包一样，安装黑屏，强制重启后进系统显示安装成功；
*	目前重装的机器可以正常安装补丁；
*	结合日志分析，是否“Network Drivers”在补丁安装前就已经损坏？？目前没有证据证明是安装补丁导致驱动损坏还是驱动本身就是损坏
*	另外，福建分行反馈的信息，更新失败的部分机器都有过硬盘损坏的记录，更换过硬盘，不知道是否有关系
Thank you for your time!
----------
Best Regards,
Carl Liu（刘健）
Mobile: + 86 13810968329 | Email: liujian@cmgos.com
_____________________________________________

====第7封邮件====

发件人：win10技术支持
发送时间：2023-02-13 16:35:22.662000+00:00
邮件内容:
根据如下方式可恢复补丁安装，请协助分析出现磁盘损坏的具体原因。
☆☆☆☆☆☆☆☆☆☆☆☆☆☆☆☆☆☆☆
中国工商银行软件开发中心（珠海）
许  翔
系统一部
电话：17606669571
☆☆☆☆☆☆☆☆☆☆☆☆☆☆☆☆☆☆☆ 
________________________________
	-----原始邮件-----
	
====第8封邮件====

发件人：Wei Liang
发送时间：2023-02-13 17:57:40.559000+00:00
邮件内容:
许先生 您好：
关于系统日志中出现NTFS文件系统出现损坏，为什么会出现这种问题，根据经验，遇到最多的情况就是不正常关机导致的。
在问题发生前某些软件等做了一些更改等导致NTFS文件系统损坏了，直到重启/关机/crash时问题发生。由于系统和软硬件的状态都在随时变化，系统也无法随时检查文件系统状态。
NTFS 文件损坏告警
event ID 55, 98
1. 当NTFS从磁盘读任何metadata(e.g. MFT records, directory index blocks, etc.)的时候会执行基本的健全性检查，以确保它结构良好，如果这些检查失败，则该文件被视为已损坏，然后在系统日志里面报NTFS 55，没有读取到这块问题的metadata数据的时候不会报错。
2. 将metadata元数据写入磁盘时，NTFS不会执行这些健全性检查，因为很影响性能。所以metadata元数据文件损坏在系统日志NTFS 55之前已经发生了，可能发生在几分钟之前，也有可能是几个小时之前。
可能原因：
//NTFS 55一般有以下可能原因：
多台服务器或存储同时对磁盘进行写操作
服务器意外重启/强制重启，OS 发出的一些涉及元数据的IO被中断
对磁盘进行变更，特别是扩展或者迁移磁盘/卷
硬件方面的原因，导致OS发出的数据通过SCSI/iSCSI/HBA 这样的硬件设备时IO没有写到正确的位置
文件系统过滤驱动比如杀毒软件，加密软件等 阻止了OS层面的一些IO 或者异常扫描导致文件层面的损坏
备份软件没有正常关闭文件handle
磁盘碎片过多
修复文件系统建议：
1. 保存所有未保存的数据并关闭所有打开的程序单击开始，以管理员模式运行CMD命令行
chkdsk  X: /f
2. 如果NTFS 55消息定期出现，例如每天或每周，请使用/R命令行选项运行chkdsk。此选项允许chkdsk定位硬盘上的坏扇区。请在此操作前备份磁盘，此修复不可逆，防止因修复命令导致数据丢失。
chkdsk  X: /f /R
3. 请确认当前磁盘状态，如果需要修复磁盘状态，都需要将磁盘进行备份，且修复磁盘状态并不是数据恢复。

====第9封邮件====

发件人：Wei Liang
发送时间：2023-02-15 17:21:50.785000+00:00
邮件内容:
许先生 您好：
确认您的问题已经解决，我将归档此案例。
工单的归档并不会影响我们为您提供技术支持服务，如您有其他问题，您可以致电技术支持热线4008180055。
案例总结：
----
问题定义：
陕西分行用户反馈有一部份设备安装12月补丁（KB5021237）完成，提示重启后出现黑屏问题，只能强制重启设备，又再次提示安装12月补丁，需要协助分析。
问题总结：
用户按照提示进行文件系统修复，并调整netsetupsvc服务配置，使其运行在单独的服务进程中，再次安装更新补丁成功。
问题分析：
CBS日志显示是和网络驱动更新相关，可能是某个网络服务或者三方软件相关，但系统中禁用了许多服务，不好直接判断是什么导致的。
另外，系统日志中有大量NTFS报错，建议先进行文件系统修复操作：
修复建议：
磁盘修复操作：
1）建议先备份数据；
2）以管理员权限打开cmd命令行，运行chkdsk /r /f C: 尝试进行修复，按照提示重启，在重新启动过程中会尝试文件系统修复操作；
3）文件系统修复完成后，以管理员权限打开cmd命令行，运行命令：sc config netsetupsvc type= own
4）然后安装补丁并重启，看是否可以完成配置；
5）假如补丁更新完成，再运行命令还原配置：sc config netsetupsvc type= share，如果还是无法更新补丁，需要尝试抓取重启应用补丁的过程日志。
组件修复操作：
1）找一台差不多补丁级别，但是成功安装了KB5021237的设备，将C:\Windows共享；
2）确保可以通过\\IP地址的方式访问到这个源，以管理员权限打开cmd命令行，运行如下命令尝试修复： 
Dism /Online /Cleanup-Image /RestoreHealth /Source:\\xxx.xxx.xxx.xxx\c$\windows /LimitAccess  （xxx.xxx.xxx.xxx指共享的设备的IP地址）
3）如果能顺利执行完成，请再安装补丁，看是否能完成补丁更新。
以上，如您后续有任何问题，可随时与我们联系，谢谢。
