邮件主题：回复: [案例号: CAS-07226-Q6L2N6 ] % 联想OEM用户-农业银行山东潍坊寿光支行用户反馈离线更新安装失败问题 % 初次响应 CMIT:0001267

====第1封邮件====

发件人：Wei Liang
发送时间：2022-09-28 10:01:33.906000+00:00
邮件内容:
许先生 您好：
感谢您的电话接听。
根据您提供的信息，我谨在此阐述我们双方针对这个问题所涉及范围界定：
问题定义:
用户反馈多台设备离线更新补丁KB5013941安装失败，需要协助排查。
问题范围:
我们将协助您分析处理上述问题，并对定义的问题给予最大的技术支持。
如果能及时解决问题，或问题属于产品设计的行为，或问题涉及到三方，我们将考虑关闭案例。如果存在多个问题，则我们考虑拆分案例进行分析。
接下来，我们将开始合作解决这个问题。如果您对以上的问题范围界定有任何异议，请尽快告知。如果您有其他任何疑问。也欢迎随时与我联系。
请您按照以下步骤帮忙收集相关系统日志进行分析。
1）清空C:\Windows\SoftwareDistribution\Download中的所有内容。
2）安装离线更新补丁KB5013941，复现安装失败的问题。
3）下载附件中的日志收集工具CMGELogCollector.zip。
4）在安装更新补丁失败的故障机上解压后运行CMGELogCollector.exe，勾选全部选项，点击“收集”，运行几分钟后会在桌面生成日志压缩包。
如果无法运行日志收集工具CMGElogCollector.exe，请您复制故障机上的C:\Windows\Logs目录和C:\Windows\System32\Winevt\Logs目录，压缩后通过CDUC上传。
日志上传方法：
您可以登陆https://cduc.cmgos.com <https://cduc.cmgos.com/> ，通过数据上传系统上传您所收集的日志信息。
用户名：wfsgzh
密码：wfsgzh
注意：添加文件，点击上传后，跳转到新的页面点击保存。

====第2封邮件====

发件人：Wei Liang
发送时间：2022-09-28 13:30:14.488000+00:00
邮件内容:
许先生 您好：
感谢您的电话接听。
查看您提供的系统日志，可以看到是在9月26日11:35:03提示安装更新补丁KB5013941失败。
而最早的cbs.log记录中的时间是2022-09-26 18:52:05。
安装补丁失败的详细cbs日志被覆盖了，无法查看到安装失败的具体日志。
请您按照以下步骤复现问题，重新收集对应的日志。
1）清空C:\Windows\SoftwareDistribution\Download中的所有内容。
2）安装离线更新补丁KB5013941，复现安装失败的问题。
3）复制故障机上的C:\Windows\Logs目录和C:\Windows\System32\Winevt\Logs目录，压缩后通过CDUC上传。
4）请提供出现此更新补丁失败问题的设备硬件型号。

====第3封邮件====

发件人：Wei Liang
发送时间：2022-09-28 16:27:11.537000+00:00
邮件内容:
许先生 您好：
查看您提供CBS.log提示：加载一个或多个组件失败。（0x800f081f）
涉及的目录为C:\Windows\Winsxs\amd64_microsoft-windows-u..access-userdataapis_31bf3856ad364e35_10.0.17763.1697_none_5752cb98931362d4在故障机上不存在。
怀疑Winsxs目录中有多个组件丢失。
下一步测试建议：
1）查看C:\Windows\Winsxs\目录属性，提供具体截图，如图所示：
2）确认当前故障机的操作系统内部版本，如图所示，用于与正常升级的设备对比Winsxs目录缺少哪些文件。
3）以管理员权限打开cmd命令行，执行以下命令列出已经安装的更新补丁列表输出到C:\kb.txt，将C:\kb.txt文件提供给我们。
wmic qfe list > c:\kb.txt
4）以管理员权限打开cmd命令行，执行以下命令列出winsxs目录的文件列表输出到C:\winsxs.txt，将C:\winsxs.txt文件提供给我们。
tree /f c:\windows\winsxs > c:\winsxs.txt
将C:\Windows\Winsxs\目录属性截图、C:\kb.txt文件和C:\winsxs.txt文件一块通过CDUC上传。

====第4封邮件====

发件人：Wei Liang
发送时间：2022-09-28 17:15:16.776000+00:00
邮件内容:
许先生 您好：
您提供的日志已经收到，有任何进展会及时与您沟通，谢谢。

====第5封邮件====

发件人：Wei Liang
发送时间：2022-09-29 15:01:16.121000+00:00
邮件内容:
许先生 您好：
通过您提供的故障机上的winsxs目录文件列表，与测试环境中的winsxs目录对比缺少很多文件，Winsxs目录中有多个文件缺失。
缺少的那些文件已经压缩上传，您可以通过以下链接下载：
https://cduc.cmgos.com/download.php?id=680&token=np98nciogkMWrWgLTxhMDm0EhYCBqfaV
针对您这台收集日志的故障机，可以按照以下操作步骤反复测试每次安装失败后的cbs.log日志，逐步替换对应文件，确认是否可以正常安装更新补丁KB5013941。
1）离线安装更新补丁KB5013941，如果提示安装失败，报错：0x800f081f。
2）打开C:\Windows\Logs\CBS\cbs.log，搜索“Unable to prestage file”查看最新的日志。
3）查看它的下一条“The payload directory”确认是缺少哪一个目录所在的文件。
4）在下载的winsxs.zip压缩文件中查找是否有日志中提示的目录，将对应的目录及文件复制到C:\Windows\Winsxs\目录，再次验证升级情况。
当前日志是提示C:\Windows\Winsxs\amd64_microsoft-windows-u..access-userdataapis_31bf3856ad364e35_10.0.17763.1697_none_5752cb98931362d4目录不存在，可以尝试把附件中的文件userdataapis.zip解压后复制到C:\Windows\Winsxs目录后，再次验证更新补丁KB5013941安装情况。
如果提示没有权限复制文件夹到C:\Windows\Winsxs\目录，请按照以下操作为C:\Windows\Winsxs\修改安全属性后，再次复制文件夹。
1）右键点击文件夹，打开【属性】对话框，选择【安全】选项卡，单击【高级】按钮；
2）在高级安全设置界面，更改所有者为您当前所在的用户或用户组；
3）确定后，回到文件夹的【安全】选项卡界面，单击【编辑】按钮，在弹出的窗口中选择当前的组或用户名，勾选【完全控制】；（如果没有第2步添加的用户名， 可以手动添加对应的用户名）
4）点击确定后，关闭文件夹的【属性】对话框,，再次测试复制文件夹操作。
神州网信政府版已经发布了最新的V2022-L系统，如果这种修复方式太繁琐，您可以尝试下载V2022-L镜像，升级到最新的系统。
V2022-L镜像下载：
您可以访问以下链接，输入设备上的激活标签上的SN序列号，验证通过后，从CMIT官网下载V2022-L镜像。
如果SN序列号前两位不是AA开头，从以下链接OEM用户下载：
https://download.cmgos.com/oem/login
如果SN序列号前两位是AA开头，从以下链接订单授权下载：
https://download.cmgos.com/pcibOrder/login

====第6封邮件====

发件人：Wei Liang
发送时间：2022-09-30 15:39:28.202000+00:00
邮件内容:
许先生 您好：
感谢您的回复，确认您的问题已经解决，我将归档此案例。
工单的归档并不会影响我们为您提供技术支持服务，如您有其他问题，您可以致电技术支持热线4008180055。
案例总结：
----
问题定义：
用户反馈多台设备离线更新补丁KB5013941安装失败，需要协助排查。
问题总结：
复制正常设备的winsxs目录中的文件补齐缺失的文件后，更新补丁KB5013941安装成功。
日志分析：
查看提供的日志，都是提示：加载一个或多个组件失败。（0x800f081f），涉及到C:\Windows\Winsxs\目录中的文件。
怀疑Winsxs目录中有多个组件丢失。
对比正常能够安装补丁的设备上的Winsxs目录，提供缺失的相关文件，请反复测试复制cbs日志中提到的缺失的文件及目录到故障机的Winsxs目录，验证是否可以正常更新。
以上，如您后续有任何问题，可随时与我们联系，谢谢。
