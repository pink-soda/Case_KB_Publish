邮件主题：[案例号: CAS-06735-S8M2D7 ] % |P2|ICBC|vpn网络环境中登录域控缓慢 % 初次响应 CMIT:0001632

====第1封邮件====

发件人：Wei Liang
发送时间：2022-07-26 17:09:42.388000+00:00
邮件内容:
许先生 您好：
感谢您的电话接听。
根据您提供的信息，我谨在此阐述我们双方针对这个问题所涉及范围界定：
问题定义:
有一些设备登录系统并连接VPN，锁屏后再次登录出现登录缓慢问题，需要协助分析原因。
问题范围:
我们将协助您分析处理上述问题，并对定义的问题给予最大的技术支持。
如果能及时解决问题，或问题属于产品设计的行为，或问题涉及到三方，我们将考虑关闭案例。如果存在多个问题，则我们考虑拆分案例进行分析。
接下来，我们将开始合作解决这个问题。如果您对以上的问题范围界定有任何异议，请尽快告知。如果您有其他任何疑问。也欢迎随时与我联系。
根据当前了解的信息，在vpn处于已连接状态下，测试无法访问内网域控制器。为进一步判断vpn已连接状态下的网络情况，请进行以下测试并记录测试结果。
1）vpn已连接情况下，此时可以正常访问OA系统。
2）打开cmd命令行，运行 set logonserver  ，得到登录的域控制器名，执行 ping 域控制器操作，确认是否可以访问内网域控制器。
如图所示测试环境中查询到域控制器为cmitvmp1001， ping cmitvmp1001 成功。
3）使用一段时间，锁屏后再次登录出现登录缓慢问题。
4）输入用户名密码后，等待一段时间进入系统桌面，此时直接访问内网OA系统并进行相关操作，确认是否可以正常访问内网OA系统。
5）再次测试是否可以ping通内网域控制器。
6）如果无法访问内网OA系统，测试先断开vpn再连接后是否可以正常访问内网OA系统。
获取到相关测试结果后，再确认后续的日志收集和分析方向。

====第2封邮件====

发件人：Wei Liang
发送时间：2022-07-28 17:14:11.269000+00:00
邮件内容:
许先生 您好：
感谢您的电话接听。
请您与用户沟通，提供相关测试结果，我们会根据测试情况进一步分析可能的原因。

====第3封邮件====

发件人：Wei Liang
发送时间：2022-08-03 17:10:15.876000+00:00
邮件内容:
许先生 您好：
感谢您的电话接听。
您的电脑在VPN环境下也复现了解锁登录缓慢的问题，您可以按照上一封邮件说明收集具体日志给我们进一步分析。
如果您确认可以安排好行程来我们办公地点，我们可以现场收集相关日志、进行问题排查。

====第4封邮件====

发件人：Wei Liang
发送时间：2022-08-05 17:02:06.739000+00:00
邮件内容:
许先生 您好：
感谢您的电话接听。
您可以按照以下操作收集具体日志给我们进一步分析。
配置注册表开启了三个日志winlogon.log、netlogon.log和gpsvc.log
为了方便配置操作，我将注册表配置整理成reg注册表文件，在出现解锁缓慢的设备上先导入附件中的gplog.zip中的gplog.reg注册表文件，观察是否复现解锁缓慢问题。
当出现登录缓慢问题后，请复制C:\Windows\security\logs\目录和C:\Windows\debug\目录并压缩后，把这些日志上传给我们。
Procmon日志：
1）下载附件中的procmon.zip，解压后，双击运行procmon.exe，点击accept后，到达如下图的界面：
2）点击图标1，此时procmon为停止抓取状态，如图所示（图标1带x）。
3）在电脑锁屏前点击图标1，，procmon处于抓取状态，如图所示（图标1正常）。
4）锁屏一段时间后，解锁复现问题，经过一段时间登录系统后，点击图标1停止抓取，点击““File”-“save”，选择all events保存pml文件，将此文件压缩后上传。
系统日志：
1）下载附件中的CMGELogCollector.zip，解压后运行CMGELogCollector.exe，勾选全部选项，点击“收集”，运行几分钟后会在桌面生成日志压缩包，将日志上传。

====第5封邮件====

发件人：Wei Liang
发送时间：2022-08-09 11:18:33.506000+00:00
邮件内容:
许先生 您好：
感谢您的电话接听。
您可以按照上一封邮件操作，收集具体日志给我们进一步分析。
如果针对当前案件还有需要我们帮助的地方, 欢迎随时联系我们。

====第6封邮件====

发件人：CRM Case Email
发送时间：2022-08-09 16:54:23.241000+00:00
邮件内容:
许先生，您好
很高兴与您电话沟通，根据沟通的结果：您可以按照之前邮件的操作方式收集日志，并上传。
如果有疑问可回复此邮件。
--------------

====第7封邮件====

发件人：Wei Liang
发送时间：2022-08-11 16:49:37.311000+00:00
邮件内容:
许先生 您好：
来信是想咨询当前案例进展状况。请您将抓取的日志压缩后，通过CDUC或者sftp上传，提供给我们进一步分析。
如果针对当前案件还有需要我们帮助的地方, 欢迎随时联系我们。

====第8封邮件====

发件人：Wei Liang
发送时间：2022-08-12 14:45:14.665000+00:00
邮件内容:
许先生 您好：
您上传的bootlog.zip文件解压后打开报错，提示文件损坏。而且此日志是系统启动和登录过程的日志，并不是锁屏后解锁的procmon日志。
针对连接vpn后，锁屏后解锁缓慢的问题，您可以按照以下方式收集相关日志，压缩后通过CDUC或者sftp上传。
配置注册表开启了三个日志winlogon.log、netlogon.log和gpsvc.log：
为了方便配置操作，我将注册表配置整理成reg注册表文件，在出现解锁缓慢的设备上先导入附件中的gplog.zip中的gplog.reg注册表文件，观察是否复现解锁缓慢问题。
当出现登录缓慢问题后，请复制C:\Windows\security\logs\目录和C:\Windows\debug\目录并压缩后，把这些日志上传给我们。
Procmon日志：
1）下载附件中的procmon.zip，解压后，双击运行procmon.exe，点击accept后，到达如下图的界面：
2）点击图标1，此时procmon为停止抓取状态，如图所示（图标1带x）。
3）在电脑锁屏前点击图标1，procmon处于抓取状态，如图所示（图标1正常）。
4）锁屏一段时间后，解锁复现问题，经过一段时间登录系统后，点击图标1停止抓取（停止抓取后图标1带x），点击““File”-“save”，选择all events保存pml文件，将此文件压缩后上传。
系统日志：
1）下载附件中的CMGELogCollector.zip，解压后运行CMGELogCollector.exe，勾选全部选项，点击“收集”，运行几分钟后会在桌面生成日志压缩包，将日志上传。

====第9封邮件====

发件人：Wei Liang
发送时间：2022-08-15 15:05:26.188000+00:00
邮件内容:
许先生 您好：
请您与最终用户沟通，将收集的相关日志压缩，上传到CDUC或者sftp服务器。
如果针对当前案件还有需要我们帮助的地方, 欢迎随时联系我们。

====第10封邮件====

发件人：Wei Liang
发送时间：2022-08-17 15:06:03.749000+00:00
邮件内容:
许先生 您好：
日志已经收到，有任何进展会及时与您联系，谢谢。

====第11封邮件====

发件人：Wei Liang
发送时间：2022-08-17 18:48:32.859000+00:00
邮件内容:
许先生 您好：
感谢您的电话接听。
经过您的确认，当前的网络配置情况：连接VPN后，无法访问内网域控制器的389端口。
从procmon日志中也能看到，lsass.exe进程在访问内网域控的389端口，但是一直没有得到回复。
查看其stack，它是在查找内网DCName
域用户登录需要去域控上验证凭据后才能登录，当连上VPN后，在解锁登录时，会去查找域控，最终通过DC验证后登录计算机。
如果DC没有响应，但是客户端通过DNS获取了DC列表后，会查找所有DC都没有响应其请求后，最后使用本地缓存的凭据验证并登录。
工行内部有多台DC，且禁止在连接VPN时访问LDAP服务端口389，这就导致了现在VPN环境中无法访问域控的LDAP服务，客户端花费了很长时间在查找可用的DC，最后出现域用户解锁缓慢的情况。
如果想排查当前VPN网络环境下，域用户解锁登录的情况，请您通过以下步骤收集相关日志进行排查：
1）确保C盘有足够空间，创建c:\logs 目录
2）将附件中的logs.zip下载，解压到c:\logs目录，将.txt文件后缀改为.bat，如下图所示：
3）右击start-auth.bat选择以管理员权限运行start-auth.bat，并输入Y 开启日志:
4）右击start-winlogon.bat选择以管理员权限运行start-winlogon.bat
5）锁屏一段时间后，解锁复现问题。
6）经过一段时间登录系统，右键以管理员权限运行stop-winlogon.bat.
7）右键以管理员权限运行stop-auth.bat，并输入Y结束抓取。
8）将生成的authlogs目录、logfile.pml、ds_security.etl打包压缩后上传。

====第12封邮件====

发件人：Wei Liang
发送时间：2022-08-18 17:40:05.216000+00:00
邮件内容:
许先生 您好：
感谢您的电话接听。
您可以按照上一封邮件操作收取域用户解锁过程中的交互过程的相关日志进一步分析。
也请您测试解封UDP 389端口后，连接VPN后，是否再次复现此问题。
如果针对当前案件还有需要我们帮助的地方, 欢迎随时联系我们。

====第13封邮件====

发件人：Wei Liang
发送时间：2022-08-19 18:04:46.669000+00:00
邮件内容:
许先生 您好：
请您查收《VPN处于连接状态下域用户解锁缓慢问题说明》文档。
如果针对当前案件还有需要我们帮助的地方, 欢迎随时联系我们。

====第14封邮件====

发件人：Wei Liang
发送时间：2022-08-22 16:07:43.117000+00:00
邮件内容:
许先生 您好：
您可以按照以下操作方法，收集解锁过程中的认证过程信息等日志，尝试排查vpn网络环境下域用户解锁缓慢的问题。
1）确保C盘有足够空间，创建c:\logs 目录
2）将附件中的logs.zip下载，解压到c:\logs目录，将.txt文件后缀改为.bat，如下图所示：
3）右击start-auth.bat选择以管理员权限运行start-auth.bat，并输入Y 开启日志:
4）右击start-winlogon.bat选择以管理员权限运行start-winlogon.bat
5）锁屏一段时间后，解锁复现问题。
6）经过一段时间登录系统，右键以管理员权限运行stop-winlogon.bat.
7）右键以管理员权限运行stop-auth.bat，并输入Y结束抓取。
8）将生成的authlogs目录、logfile.pml、ds_security.etl打包压缩后上传。
9）压缩C:\System32\Winevt\logs 目录并上传。
如果针对当前案件还有需要我们帮助的地方, 欢迎随时联系我们。

====第15封邮件====

发件人：Wei Liang
发送时间：2022-08-24 16:32:30.769000+00:00
邮件内容:
许先生 您好：
来信是想咨询当前案例进展状况。
您可以按照上一封邮件操作，收集解锁过程中的认证过程信息等日志，尝试排查vpn网络环境下域用户解锁缓慢的问题。
如果针对当前案件还有需要我们帮助的地方, 欢迎随时联系我们。

====第16封邮件====

发件人：Wei Liang
发送时间：2022-08-26 16:58:34.103000+00:00
邮件内容:
许先生 您好：
来信是想咨询当前案例进展状况。
您可以按照邮件中的操作说明，收集解锁过程中的认证过程信息等日志，尝试排查vpn网络环境下域用户解锁缓慢的问题。
如果针对当前案件还有需要我们帮助的地方, 欢迎随时联系我们。

====第17封邮件====

发件人：Wei Liang
发送时间：2022-08-30 17:44:30.479000+00:00
邮件内容:
许先生 您好：
来信是想咨询当前案例进展状况。
您可以按照以下操作说明，收集解锁过程中的认证过程信息等日志，尝试排查vpn网络环境下域用户解锁缓慢的问题。相关的脚本文件已经上传到sftp的“vpn登录缓慢”目录。
1）确保C盘有足够空间，创建c:\logs 目录
2）从sftp中的“vpn登录缓慢”目录下载logs.zip，解压到c:\logs目录，将.txt文件后缀改为.bat，如下图所示：
3）右击start-auth.bat选择以管理员权限运行start-auth.bat，并输入Y 开启日志:
4）右击start-winlogon.bat选择以管理员权限运行start-winlogon.bat
5）锁屏一段时间后，解锁复现问题。
6）经过一段时间登录系统，右键以管理员权限运行stop-winlogon.bat.
7）右键以管理员权限运行stop-auth.bat，并输入Y结束抓取。
8）将生成的authlogs目录、logfile.pml、ds_security.etl打包压缩后上传。
9）压缩C:\System32\Winevt\logs 目录并上传。
如果针对当前案件还有需要我们帮助的地方, 欢迎随时联系我们。

====第18封邮件====

发件人：Wei Liang
发送时间：2022-09-02 11:28:49.508000+00:00
邮件内容:
许先生 您好：
经过您的确认，我将暂时归档此案例。
工单的归档并不会影响我们为您提供技术支持服务，如您有其他问题，您可以致电技术支持热线4008180055。
案例总结：
----
问题定义：
有一些设备登录系统并连接VPN，锁屏后再次登录出现登录缓慢问题，需要协助分析原因。
问题总结：
域用户登录缓慢的情况与网络相关，请解封VPN与域控的网络访问端口，再观察域用户解锁情况。用户当前无法收集更详细的VPN网络环境下域用户解锁验证过程日志，同意暂时归档案例。
处理建议：
1、域用户登录缓慢的情况与网络相关，请解封VPN与域控的网络访问端口，再观察域用户解锁情况。
2、组策略“计算机启动和登录时总是等待网络”会导致域用户在解锁过程中强制同步应用域控推送的组策略，有可能导致域用户解锁时间过长，请测试“禁用”或“未配置”此组策略，再测试域用户解锁情况。
3、如果复现VPN环境下域用户解锁缓慢问题，可以按照以下说明收集解锁过程中的认证过程信息等日志，供进一步排查。
1）确保C盘有足够空间，创建c:\logs 目录
2）从sftp中的“vpn登录缓慢”目录下载logs.zip，解压到c:\logs目录，将.txt文件后缀改为.bat，如下图所示：
3）右击start-auth.bat选择以管理员权限运行start-auth.bat，并输入Y 开启日志:
4）右击start-winlogon.bat选择以管理员权限运行start-winlogon.bat
5）锁屏一段时间后，解锁复现问题。
6）经过一段时间登录系统，右键以管理员权限运行stop-winlogon.bat.
7）右键以管理员权限运行stop-auth.bat，并输入Y结束抓取。
8）将生成的authlogs目录、logfile.pml、ds_security.etl打包压缩后上传。
9）压缩C:\System32\Winevt\logs 目录并上传。
以上，如您后续有任何问题，可随时与我们联系，谢谢。

====第19封邮件====

发件人：Wei Liang
发送时间：2022-12-26 15:28:27.647000+00:00
邮件内容:
许先生 您好：
关于VPN环境下域用户解锁缓慢问题，可以按照以下说明收集解锁过程中的认证过程信息等日志，供进一步排查。
1）确保C盘有足够空间，创建c:\logs 目录
2）下载附件，解压到c:\logs目录，将.txt文件后缀改为.bat，如下图所示：
3）右击start-auth.bat选择以管理员权限运行start-auth.bat，并输入Y 开启日志:
4）右击start-winlogon.bat选择以管理员权限运行start-winlogon.bat
5）锁屏一段时间后，解锁复现问题。
6）经过一段时间登录系统，右键以管理员权限运行stop-winlogon.bat.
7）右键以管理员权限运行stop-auth.bat，并输入Y结束抓取。
8）将生成的authlogs目录、logfile.pml、ds_security.etl打包压缩后上传。
9）压缩C:\System32\Winevt\logs 目录并上传。
