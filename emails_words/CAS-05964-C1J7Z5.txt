邮件主题：回复: 【外来邮件，注意核实】Re:答复: Re:答复: [案例号: CAS-05964-C1J7Z5 ] % |P2|ICBC|Windows jvm兼容性问题排查 % 初次响应 CMIT:0001027

====第1封邮件====

发件人：Wei Liang
发送时间：2022-03-30 18:30:25.214000+00:00
邮件内容:
吴先生 & 许先生 你们好：
感谢您的电话接听。
根据您提供的信息，我谨在此阐述我们双方针对这个问题所涉及范围界定：
问题定义:
用户使用第三方应用 JetBrains Projector server 模式启动新终端应用失败，JVM进程直接退出。
新终端应用通过JDK11运行，直接运行新终端应用成功。
问题范围:
我们将协助您分析处理上述问题，并对定义的问题给予最大的技术支持。
如果能及时解决问题，或问题属于产品设计的行为，或问题涉及到三方，我们将考虑关闭案例。如果存在多个问题，则我们考虑拆分案例进行分析。
接下来，我们将开始合作解决这个问题。如果您对以上的问题范围界定有任何异议，请尽快告知。如果您有其他任何疑问。也欢迎随时与我联系。
您这个问题实际上是第三方应用 JetBrains Projector 提供的一个将本地应用转换到web应用的功能，这个功能在对新终端应用进行转换时失败，为更快、更好的排查这个功能失败问题，建议您寻求第三方应用 JetBrains Projector 厂商的帮助。
在操作系统层面，请您按照以下方法帮忙收集Java运行环境中的JVM相关日志，尝试分析这个问题。
按照以下方式配置：
一、Procmon收集jvm运行访问情况：
1）下载附件中的Procmon.zip，解压后双击procmon.exe运行，点击Accept后，到达此页面，会有有大量条目出现，先后点击1，2暂停抓取并清除当前条目。当前已经是可抓取状态；
2）点击下图的图标开始抓取。
3）复现JetBrains Projector server 模式启动新终端应用失败的问题。
4）此时回到Process Monitor窗口，单击Capture图标，停止抓取；
5）点击File, 点击Save. 选择"All events" and "Native Process Monitor Format (PML)"点击OK。记录文件保存位置；
6）将PML文件重命名为“运行失败日志”、打包压缩通过SFTP上传。
二、Procdump收集jvm userdump:
1）下载附件中的procdump工具并解压。
2）在计算机上创建文件目录 C:\dumps，将procdump.exe 复制到C:\dumps 目录。
3）以管理员权限打开cmd命令行，定位到C:\dumps，运行以下命令配置procdump自动生成转储文件。
cd c:\dumps
procdump.exe -ma -i
4）复现JetBrains Projector server 模式启动新终端应用失败的问题。
5）以管理员权限打开cmd命令行，定位到C:\dumps，运行以下命令取消procdump配置。
cd c:\dumps
procdump.exe -u
6）将C:\dumps 目录下生成的dmp文件压缩，并通过SFTP上传。
为了更安全、快速地传输数据，您可以在Filezilla上使用以下账户信息登入神州网信提供的SFTP服务器。
l  Filezilla client端下载URL：https://filezilla-project.org/download.php?type=client
l  登陆地址：sftp://ocean.cmgos.com
l  用户名为：ICBC    （区分大小写）
l  密码：2qfs52ninbFB
l  端口：22222
登陆之后，上传至/upload/ 文件夹。
电子邮箱： weiliang@cmgos.com
官方网站： www.cmgos.com
________________________________

====第2封邮件====

发件人：吴冕冠
发送时间：2022-03-31 18:03:27.113000+00:00
邮件内容:
您好，如下地址无法登陆，请帮忙看下是否可以登陆
 Filezilla client端下载URL：https://filezilla-project.org/download.php?type=client
l  登陆地址：sftp://ocean.cmgos.com
l  用户名为：ICBC    （区分大小写）
l  密码：2qfs52ninbFB
l  端口：22222
登陆之后，上传至/upload/ 文件夹。
	2022年3月30日 18:30，Wei Liang <weiliang@cmgos.com <mailto:weiliang@cmgos.com> > 写道：
	吴先生 & 许先生 你们好：
	感谢您的电话接听。
	根据您提供的信息，我谨在此阐述我们双方针对这个问题所涉及范围界定：
	问题定义:
	用户使用第三方应用 JetBrains Projector server 模式启动新终端应用失败，JVM进程直接退出。
	新终端应用通过JDK11运行，直接运行新终端应用成功。
	问题范围:
	我们将协助您分析处理上述问题，并对定义的问题给予最大的技术支持。
	如果能及时解决问题，或问题属于产品设计的行为，或问题涉及到三方，我们将考虑关闭案例。如果存在多个问题，则我们考虑拆分案例进行分析。
	接下来，我们将开始合作解决这个问题。如果您对以上的问题范围界定有任何异议，请尽快告知。如果您有其他任何疑问。也欢迎随时与我联系。
	您这个问题实际上是第三方应用 JetBrains Projector 提供的一个将本地应用转换到web应用的功能，这个功能在对新终端应用进行转换时失败，为更快、更好的排查这个功能失败问题，建议您寻求第三方应用 JetBrains Projector 厂商的帮助。
	在操作系统层面，请您按照以下方法帮忙收集Java运行环境中的JVM相关日志，尝试分析这个问题。
	按照以下方式配置：
	一、Procmon收集jvm运行访问情况：
	1）下载附件中的Procmon.zip，解压后双击procmon.exe运行，点击Accept后，到达此页面，会有有大量条目出现，先后点击1，2暂停抓取并清除当前条目。当前已经是可抓取状态；
	<pastedImage.png>
	2）点击下图的图标开始抓取。
	<pastedImage.png>
	3）复现JetBrains Projector server 模式启动新终端应用失败的问题。
	4）此时回到Process Monitor窗口，单击Capture图标，停止抓取；
	<pastedImage.png>
	5）点击File, 点击Save. 选择"All events" and "Native Process Monitor Format (PML)"点击OK。记录文件保存位置；
	<pastedImage.png>
	6）将PML文件重命名为“运行失败日志”、打包压缩通过SFTP上传。
	二、Procdump收集jvm userdump:
	1）下载附件中的procdump工具并解压。
	2）在计算机上创建文件目录 C:\dumps，将procdump.exe 复制到C:\dumps 目录。
	<pastedImage.png>
	3）以管理员权限打开cmd命令行，定位到C:\dumps，运行以下命令配置procdump自动生成转储文件。
	cd c:\dumps
	procdump.exe -ma -i
	<pastedImage.png>
	4）复现JetBrains Projector server 模式启动新终端应用失败的问题。
	5）以管理员权限打开cmd命令行，定位到C:\dumps，运行以下命令取消procdump配置。
	cd c:\dumps
	procdump.exe -u
	<pastedImage.png>
	6）将C:\dumps 目录下生成的dmp文件压缩，并通过SFTP上传。
	为了更安全、快速地传输数据，您可以在Filezilla上使用以下账户信息登入神州网信提供的SFTP服务器。
	l  Filezilla client端下载URL：https://filezilla-project.org/download.php?type=client
	l  登陆地址：sftp://ocean.cmgos.com
	l  用户名为：ICBC    （区分大小写）
	l  密码：2qfs52ninbFB
	l  端口：22222
	登陆之后，上传至/upload/ 文件夹。
	电子邮箱： weiliang@cmgos.com <mailto:weiliang@cmgos.com> 
________________________________
	
====第3封邮件====

发件人：Wei Liang
发送时间：2022-03-31 18:32:37.277000+00:00
邮件内容:
吴先生 您好：
请您指定使用sftp协议，FileZilla Client 快速连接时填写以下信息：（其他客户端有可能默认协议不是sftp协议）
电子邮箱： weiliang@cmgos.com
官方网站： www.cmgos.com
________________________________

====第4封邮件====

发件人：Wei Liang
发送时间：2022-03-31 19:47:20.436000+00:00
邮件内容:
吴先生 您好：
我这边测试使用sftp可以连接，您那边无法连接的话，请您试试使用CDUC通过web页面上传是否可以,，web页面上传最大数据限制为 2GB。
登陆https://cduc.cmgos.com <https://cduc.cmgos.com/> ，通过数据上传系统上传您经过压缩后的日志信息。
用户名：projector
密码：projector
注意：添加文件，点击上传后，跳转到新的页面点击保存。
电子邮箱： weiliang@cmgos.com
官方网站： www.cmgos.com
________________________________

====第5封邮件====

发件人：Wei Liang
发送时间：2022-04-01 16:47:10.632000+00:00
邮件内容:
吴先生 您好：
感谢您的电话接听。
针对procdump.exe未生成相关dmp日志的问题，请您按照以下方式操作：
以管理员权限打开cmd命令行，定位到procdump.exe所在文件夹，运行以下命令：
procdump.exe -e -t -ma -w java.exe c:\dumps（请先创建c:\dumps文件夹，此命令表示等待java.exe启动，当启动java.exe出错异常退出时，会在c:\dumps生成对应dmp文件)
复现应用异常退出的问题，会生成dmp文件，将文件压缩，通过sftp或者cduc上传，相关的procmon日志也一块压缩上传。
如果您这边无法访问sftp或cduc系统，麻烦 许翔 帮忙上传到sftp服务器。
上传方法：
CDUC：
登陆https://cduc.cmgos.com <https://cduc.cmgos.com/> ，通过数据上传系统上传您经过压缩后的日志信息。
用户名：projector
密码：projector
注意：添加文件，点击上传完成后，会跳转到新的页面，请点击保存。
sftp服务器：
在Filezilla上使用以下账户信息登入神州网信提供的SFTP服务器。
l  Filezilla client端下载URL：https://filezilla-project.org/download.php?type=client
l  登陆地址：sftp://ocean.cmgos.com <https://mail.cmgos.com/owa/projection.aspx> 
l  用户名为：ICBC    （区分大小写）
l  密码：2qfs52ninbFB
l  端口：22222
登陆之后，上传至/upload/ 文件夹。
电子邮箱： weiliang@cmgos.com
官方网站： www.cmgos.com
________________________________

====第6封邮件====

发件人：吴冕冠
发送时间：2022-04-01 17:54:55.250000+00:00
邮件内容:
我们现在基本已经定位了是这个语句报错的了，附件是我们在外网自己写的一个小demo,会报和行内新终端工程启动类似的错。  下午我用您提供的两个工具抓了一下日志和dump文件，稍微请 许翔 老师帮忙上传到如下地址，多谢。
登陆https://cduc.cmgos.com <https://cduc.cmgos.com/> ，通过数据上传系统上传您经过压缩后的日志信息。
用户名：projector
密码：projector
Windows Java 11 环境运行会报case中的那个错误。
在 2022-04-01 16:47:09，"Wei Liang" <weiliang@cmgos.com> 写道：
	吴先生 您好：
	感谢您的电话接听。
	针对procdump.exe未生成相关dmp日志的问题，请您按照以下方式操作：
	以管理员权限打开cmd命令行，定位到procdump.exe所在文件夹，运行以下命令：
	procdump.exe -e -t -ma -w java.exe c:\dumps（请先创建c:\dumps文件夹，此命令表示等待java.exe启动，当启动java.exe出错异常退出时，会在c:\dumps生成对应dmp文件)
	复现应用异常退出的问题，会生成dmp文件，将文件压缩，通过sftp或者cduc上传，相关的procmon日志也一块压缩上传。
	如果您这边无法访问sftp或cduc系统，麻烦 许翔 帮忙上传到sftp服务器。
	上传方法：
	CDUC：
	登陆https://cduc.cmgos.com <https://cduc.cmgos.com/> ，通过数据上传系统上传您经过压缩后的日志信息。
	用户名：projector
	密码：projector
	注意：添加文件，点击上传完成后，会跳转到新的页面，请点击保存。
	sftp服务器：
	在Filezilla上使用以下账户信息登入神州网信提供的SFTP服务器。
	l  Filezilla client端下载URL：https://filezilla-project.org/download.php?type=client
	l  登陆地址：sftp://ocean.cmgos.com <https://mail.cmgos.com/owa/projection.aspx> 
	l  用户名为：ICBC    （区分大小写）
	l  密码：2qfs52ninbFB
	l  端口：22222
	登陆之后，上传至/upload/ 文件夹。
	电子邮箱： weiliang@cmgos.com
	官方网站： www.cmgos.com
________________________________
	
====第7封邮件====

发件人：Wei Liang
发送时间：2022-04-01 19:42:43.509000+00:00
邮件内容:
吴先生 您好：
感谢您的回复。
针对您的这个问题，CMIT无法分析Java代码，您可以将Demo提交给JetBrains或者Projector社区寻求支持。
我们会从操作系统层面分析Java应用异常退出情况，但无法确保找出问题根本原因和解决方法，从操作系统层面能提供的技术支持有限。
电子邮箱： weiliang@cmgos.com
官方网站： www.cmgos.com
________________________________

====第8封邮件====

发件人：吴冕冠
发送时间：2022-04-02 11:01:32.941000+00:00
邮件内容:
    这个问题我们已经提交到开源社区了，暂时还没收到社区答复。
    请许老师也帮忙看看能否把昨天共享给您的那个日志压缩包上传到危亮老师提供的CDUC上，方便危亮老师进行底层报错原因分析。
在 2022-04-01 19:42:42，"Wei Liang" <weiliang@cmgos.com> 写道：
	吴先生 您好：
	感谢您的回复。
	针对您的这个问题，CMIT无法分析Java代码，您可以将Demo提交给JetBrains或者Projector社区寻求支持。
	我们会从操作系统层面分析Java应用异常退出情况，但无法确保找出问题根本原因和解决方法，从操作系统层面能提供的技术支持有限。
	电子邮箱： weiliang@cmgos.com
	官方网站： www.cmgos.com
________________________________
	
====第9封邮件====

发件人：Windows Server技术支持
发送时间：2022-04-02 11:18:52.018000+00:00
邮件内容:
已上传
☆☆☆☆☆☆☆☆☆☆☆☆☆☆☆☆☆☆☆
中国工商银行软件开发中心（珠海）
许  翔
系统一部
电话：17606669571
☆☆☆☆☆☆☆☆☆☆☆☆☆☆☆☆☆☆☆ 
	-----原始邮件-----
	
====第10封邮件====

发件人：Wei Liang
发送时间：2022-04-02 11:28:27.198000+00:00
邮件内容:
吴先生 & 许先生 你们好：
日志已经收到，我们会从操作系统层面尝试分析Java应用异常退出问题，但无法确保找出问题根本原因和解决方法，如有任何进展，会及时联系你们。
电子邮箱： weiliang@cmgos.com
官方网站： www.cmgos.com
________________________________

====第11封邮件====

发件人：Wei Liang
发送时间：2022-04-07 17:54:49.109000+00:00
邮件内容:
吴先生 您好：
感谢您的电话接听。
查看java dump中的call stack信息，显示jvm在运行JVM_EnqueueOperation后，java调用系统函数KiUserExceptionDispatch抛出异常退出应用。
查看具体的call stack列表，在退出之前有执行相关调用：jna8160425833267163484!Java_com_sun_jna_Native_getWindowHandle0、awt!DSGetDrawingSurface。
0:000> k
# Child-SP          RetAddr               Call Site
00 000000bd`000f9d78 00007ffe`f75ecb68     ntdll!NtTerminateProcess+0x14
01 000000bd`000f9d80 00007ffe`f685d62a     ntdll!RtlExitUserProcess+0xb8
02 000000bd`000f9db0 00007ffe`f46d0e24     kernel32!ExitProcessImplementation+0xa
03 000000bd`000f9de0 00007ffe`f46d0ccf     ucrtbase!exit_or_terminate_process+0x44
04 000000bd`000f9e10 00007ffe`ce1528e0     ucrtbase!common_exit+0x6f
05 000000bd`000f9e60 00007ffe`ce15063d     jvm!c2v_callSystemExit+0x1fbfa0
06 000000bd`000f9f00 00007ffe`ce293acf     jvm!c2v_callSystemExit+0x1f9cfd
07 000000bd`000f9f70 00007ffe`ce293bc5     jvm!c2v_callSystemExit+0x33d18f
08 000000bd`000fa340 00007ffe`ce293b7b     jvm!c2v_callSystemExit+0x33d285
09 000000bd`000fa3b0 00007ffe`ce157c53     jvm!c2v_callSystemExit+0x33d23b
0a 000000bd`000fa400 00007ffe`ce158308     jvm!c2v_callSystemExit+0x201313
0b 000000bd`000fa5e0 00007ffe`f7624a2f     jvm!c2v_callSystemExit+0x2019c8
0c 000000bd`000fa620 00007ffe`f7584cef     ntdll!RtlpExecuteHandlerForException+0xf
0d 000000bd`000fa650 00007ffe`f762379e     ntdll!RtlDispatchException+0x40f
0e 000000bd`000fad80 00007ffe`cdc2e910     ntdll!KiUserExceptionDispatch+0x2e
0f 000000bd`000fbad8 00007ffe`cded7672     jvm!JVM_EnqueueOperation+0x9de0
10 000000bd`000fbae0 00007ffe`e1605293     jvm!AsyncGetCallTrace+0xe7be2
11 000000bd`000fbb10 00007ffe`e15131ad     awt!DSGetDrawingSurface+0x3f
12 000000bd`000fbb50 0000029d`8755f377     jna8160425833267163484!Java_com_sun_jna_Native_getWindowHandle0+0x26d
13 000000bd`000fc8c0 0000029d`a4fb3348     0x0000029d`8755f377
14 000000bd`000fc8c8 000000bd`000fc948     0x0000029d`a4fb3348
怀疑java异常退出与jna8160425833267163484!Java_com_sun_jna_Native_getWindowHandle0、awt!DSGetDrawingSurface这两个函数有关。
查找相关资料有提示， jna源代码中的Java_com_sun_jna_Native_getWindowHandle0函数说明中有关于headless模式使用的说明：
https://github.com/java-native-access/jna/blob/master/native/dispatch.c
这需要您确认JetBrains Projector-Server模式中的提到的headless与Java中的headless模式有什么联系与区别。
如果您确认Projector中会调用Java中的headless模式，请您先不使用Projector，直接使用Java中的headless模式测试是否可以正常启动您的应用，判断是否与jna源代码中提到的issue有关。关于Java的headless模式说明，您可以通过以下链接查询：
https://www.oracle.com/technical-resources/articles/javase/headless.html
关于您提供的testosgi demo，您也可以导出此demo，并提供具体运行环境配置和执行脚本，方便在相关环境下测试和验证。

====第12封邮件====

发件人：Wei Liang
发送时间：2022-04-11 17:39:05.592000+00:00
邮件内容:
吴先生 您好：
感谢您的回复。经过您的同意，我将归档此案例。
工单的归档并不会影响我们为您提供技术支持服务，如您有其他问题，您可以致电技术支持热线4008180055。
案例总结：
----
问题定义：
用户使用第三方应用 JetBrains Projector server 模式启动新终端应用失败，JVM进程直接退出。
新终端应用通过JDK11运行，直接运行新终端应用成功。
问题总结：
经用户测试，确认与jna组件中的方法Java_com_sun_jna_Native_getWindowHandle0不支持headless模式有关，可以关闭此案例。
问题分析：
查看Java异常退出时的call stack信息，在退出之前有执行相关调用：jna8160425833267163484!Java_com_sun_jna_Native_getWindowHandle0、awt!DSGetDrawingSurface。
0:000> k
# Child-SP          RetAddr               Call Site
00 000000bd`000f9d78 00007ffe`f75ecb68     ntdll!NtTerminateProcess+0x14
01 000000bd`000f9d80 00007ffe`f685d62a     ntdll!RtlExitUserProcess+0xb8
02 000000bd`000f9db0 00007ffe`f46d0e24     kernel32!ExitProcessImplementation+0xa
03 000000bd`000f9de0 00007ffe`f46d0ccf     ucrtbase!exit_or_terminate_process+0x44
04 000000bd`000f9e10 00007ffe`ce1528e0     ucrtbase!common_exit+0x6f
05 000000bd`000f9e60 00007ffe`ce15063d     jvm!c2v_callSystemExit+0x1fbfa0
06 000000bd`000f9f00 00007ffe`ce293acf     jvm!c2v_callSystemExit+0x1f9cfd
07 000000bd`000f9f70 00007ffe`ce293bc5     jvm!c2v_callSystemExit+0x33d18f
08 000000bd`000fa340 00007ffe`ce293b7b     jvm!c2v_callSystemExit+0x33d285
09 000000bd`000fa3b0 00007ffe`ce157c53     jvm!c2v_callSystemExit+0x33d23b
0a 000000bd`000fa400 00007ffe`ce158308     jvm!c2v_callSystemExit+0x201313
0b 000000bd`000fa5e0 00007ffe`f7624a2f     jvm!c2v_callSystemExit+0x2019c8
0c 000000bd`000fa620 00007ffe`f7584cef     ntdll!RtlpExecuteHandlerForException+0xf
0d 000000bd`000fa650 00007ffe`f762379e     ntdll!RtlDispatchException+0x40f
0e 000000bd`000fad80 00007ffe`cdc2e910     ntdll!KiUserExceptionDispatch+0x2e
0f 000000bd`000fbad8 00007ffe`cded7672     jvm!JVM_EnqueueOperation+0x9de0
10 000000bd`000fbae0 00007ffe`e1605293     jvm!AsyncGetCallTrace+0xe7be2
11 000000bd`000fbb10 00007ffe`e15131ad     awt!DSGetDrawingSurface+0x3f
12 000000bd`000fbb50 0000029d`8755f377     jna8160425833267163484!Java_com_sun_jna_Native_getWindowHandle0+0x26d
13 000000bd`000fc8c0 0000029d`a4fb3348     0x0000029d`8755f377
14 000000bd`000fc8c8 000000bd`000fc948     0x0000029d`a4fb3348
怀疑Java异常退出与jna8160425833267163484!Java_com_sun_jna_Native_getWindowHandle0、awt!DSGetDrawingSurface这两个函数有关。
查找相关资料， jna源代码中的Java_com_sun_jna_Native_getWindowHandle0函数说明中有关于headless模式使用的说明：
https://github.com/java-native-access/jna/blob/master/native/dispatch.c
请用户确认JetBrains Projector-Server模式中的提到的headless与Java中的headless模式有什么联系与区别。
请用户不使用Projector，直接使用Java中的headless模式测试是否可以正常运行应用。
以上，如您后续有任何问题，可随时与我们联系，谢谢。
