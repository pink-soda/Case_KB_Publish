邮件主题：回复: [案例号: CAS-07295-W4F8M5 ] % |P2|ICBC|上海分行关于wsus补丁报0x800703f1安装失败问题 % 初次响应 CMIT:0001375

====第1封邮件====

发件人：Wei Liang
发送时间：2022-10-10 10:55:14.034000+00:00
邮件内容:
许先生 您好：
感谢您的电话接听。
根据您提供的信息，我谨在此阐述我们双方针对这个问题所涉及范围界定：
问题定义:
上海分行反馈通过wsus推送安装更新补丁KB5015811或者KB5016623均失败报错0x800703f1，需要协助排查。
问题范围:
我们将协助您分析处理上述问题，并对定义的问题给予最大的技术支持。
如果能及时解决问题，或问题属于产品设计的行为，或问题涉及到三方，我们将考虑关闭案例。如果存在多个问题，则我们考虑拆分案例进行分析。
接下来，我们将开始合作解决这个问题。如果您对以上的问题范围界定有任何异议，请尽快告知。如果您有其他任何疑问。也欢迎随时与我联系。
为防止收集的更新补丁失败的日志记录被覆盖，请您按照以下方法帮忙收集相关系统日志进行分析。
1）清空C:\Windows\SoftwareDistribution\Download中的所有内容。
2）安装更新补丁KB5015811或者KB5016623，复现安装失败的问题。
3）在安装更新补丁失败的故障机上运行CMGELogCollector.exe，勾选全部选项，点击“收集”，运行几分钟后会在桌面生成日志压缩包。
结合工行其他的更新补丁安装失败的类似案例，也可以先尝试暂时卸载TMS后验证更新补丁是否可以正常安装。
日志上传方法：
您可以登陆https://cduc.cmgos.com <https://cduc.cmgos.com/> ，通过数据上传系统上传您所收集的日志信息。
用户名：icbcsupport
密码：icbcsupport
注意：添加文件，点击上传后，跳转到新的页面点击保存。

====第2封邮件====

发件人：Wei Liang
发送时间：2022-10-11 15:39:06.046000+00:00
邮件内容:
许先生 您好：
感谢您的电话接听。
请您与用户沟通，按照上一封邮件说明，先复现补丁安装失败的问题，再使用CMGElogCollector.exe收集相关日志，将日志通过CDUC上传。
如果针对当前案件还有需要我们帮助的地方, 欢迎随时联系我们。

====第3封邮件====

发件人：Wei Liang
发送时间：2022-10-13 13:53:29.114000+00:00
邮件内容:
许先生 您好：
感谢您的电话接听。
查看上传的日志，在CBS.log中显示在更新补丁重启过程中更新驱动oposdrv.inf出错，出现更新回滚，报错：0x800703f1。
查看setupapi.dev.log的日志显示oposdrv.inf驱动更新失败：
日志中未查看到为什么会导致驱动更新失败的原因，其他分行有类似的案例，验证卸载TMS后更新成功。如果无法进行此类测试，请按照以下操作，抓取设备重启过程中更新补丁回滚的更详细的日志排查问题。
测试建议以及抓取日志操作：
1）安装更新补丁KB5015811或者KB5016623，在提示重启的时候先不重启。
2）移除故障机上连接的除USB鼠标外的所有USB外设。
3）将附件中的procmon.zip解压后在故障机上运行procmon.exe，选中options->Enable Boot Logging：
4）配置Boot Logging选项：
5）下载附件中的wpr.zip，解压后运行wprui.exe，按照下图所示配置，即勾选“First level triage”、“CPU usage”、“File I/O activity”、 “Registry I/O activity”、“Handle usage”、“Minifilter I/O activity”后，配置Performance scenario 为Boot，Number of iterations为 1
6）点击“Start”后，选择保存路径，然后点击“Save”，会提示重启设备。
7）重启设备复现更新补丁回滚问题，设备启动后，及时运行procmon.exe，会弹出窗口提示boot log日志已经收集，请点击Yes保存，并将文件存储到为boot_log.pml，将此日志压缩后上传。
8）将保存的wpr ETL日志C:\trace.etl压缩后上传。
9）运行CMGELogCollector.exe，勾选全部选项，点击“收集”，运行几分钟后会在桌面生成日志压缩包，将此日志上传。

====第4封邮件====

发件人：Wei Liang
发送时间：2022-10-13 13:58:02.506000+00:00
邮件内容:
通过WSUS安装补丁时，在“设置”-“更新与安全”界面应该可以查看到更新补丁安装完成后，提示是否立即重启启动，如下图所示：
先不重启，按照上一封邮件操作，收集重启过程中更新补丁回滚的详细日志。

====第5封邮件====

发件人：Wei Liang
发送时间：2022-10-17 17:43:18.782000+00:00
邮件内容:
许先生 您好：
感谢您的电话接听。
请您与最终用户沟通，按照10月13日 13:54发送的邮件说明收集故障机在安装补丁后重启过程中发生回滚的详细的procmon日志以及wpr trace，将这些日志提供给我们排查问题。
如果针对当前案件还有需要我们帮助的地方, 欢迎随时联系我们。

====第6封邮件====

发件人：Wei Liang
发送时间：2022-10-19 16:51:52.963000+00:00
邮件内容:
许先生 您好：
来信是想咨询当前案例进展状况，请您与最终用户沟通获取最新的应用更新补丁失败的具体过程日志，提供给我们进一步排查问题。
如果针对当前案件还有需要我们帮助的地方, 欢迎随时联系我们。

====第7封邮件====

发件人：Wei Liang
发送时间：2022-10-21 11:29:56.412000+00:00
邮件内容:
许先生 您好：
来信是想咨询当前案例进展状况，还未收到更新补丁安装失败的详细日志，您可以将用户收集的相关日志通过CDUC上传，提供给我们进一步分析。
如果针对当前案件还有需要我们帮助的地方, 欢迎随时联系我们。

====第8封邮件====

发件人：Wei Liang
发送时间：2022-10-24 16:37:41.319000+00:00
邮件内容:
许先生 您好：
请您与用户沟通收集更新补丁安装失败的详细日志，提供给我们进一步分析问题。
如果针对当前案件还有需要我们帮助的地方, 欢迎随时联系我们。

====第9封邮件====

发件人：Wei Liang
发送时间：2022-10-26 16:41:24.489000+00:00
邮件内容:
许先生 您好：
经过您的同意，我将暂时归档此案例。
工单的归档并不会影响我们为您提供技术支持服务，如您有其他问题，您可以致电技术支持热线4008180055。
案例总结：
----
问题定义：
上海分行反馈通过wsus推送安装更新补丁KB5015811或者KB5016623均失败报错0x800703f1，需要协助排查。
问题总结：
最终用户重新安装操作系统，暂时归档案例。
日志分析及建议：
在CBS.log中显示在更新补丁重启过程中更新驱动oposdrv.inf出错，出现更新回滚，报错：0x800703f1。
查看setupapi.dev.log的日志显示oposdrv.inf驱动更新失败：
日志中未查看到为什么会导致驱动更新失败的原因，其他分行有类似的案例，验证卸载TMS后更新成功。
如果无法进行此类测试，可以通过配置procmon的Boot Logging以及wpr工具，抓取设备重启过程中更新补丁回滚的更详细的日志排查问题。
以上，如您后续有任何问题，可随时与我们联系，谢谢。
