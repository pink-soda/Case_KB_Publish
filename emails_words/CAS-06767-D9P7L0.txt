邮件主题：回复: [案例号: CAS-06767-D9P7L0 ] % |普通事件|联想|天津农行反馈开机自动修复、蓝屏问题 % 初次响应 CMIT:0001287

====第1封邮件====

发件人：Li Qi
发送时间：2022-08-01 10:46:32.649000+00:00
邮件内容:
藕先生，您好：
       谨以此封邮件阐述我们双方针对这个问题所涉及范围界定： 
问题定义: 
天津农行反馈系统内文件不定期丢失问题，希望可以协助调查文件丢失原因。
问题范围: 
我们将协助您分析处理上述问题，并对定义的问题给予最大的技术支持。 
如果能及时解决问题，或问题属于产品设计的行为，或问题涉及到三方，我们将考虑关闭案例。如果存在多个问题，则我们考虑拆分案例进行分析。 
接下来，我们将开始合作解决这个问题。如果您对以上的问题范围界定有任何异议，请尽快告知。如果您有其他任何疑问。也欢迎随时与我联系。
下一步动作：
从之前收集的系统日志查看，问题电脑存在不正常关机的情况。
系统的不正常关机会意外中断磁盘的读写操作，如当前系统正在运行的应用进程存在磁盘读写动作，则会导致读写失败，进而应用和系统组件文件损坏，当再次运行时则会出现文件丢失或损坏的报错。
       由于用户的反馈为不定期会出现不同文件的丢失，因此接下来建议抓取P2V，以方便在本地进行问题的验证。具体步骤如下：
a.	下载disk2vhd工具保存这台机器上。附件密码为1234
b.	复现问题的电脑，进入命令行。
c.	从命令行运行如下命令：
disk2vhd.exe
d.	取消Use Volume Shadow Copy勾选，选择C盘，然后生成VHDX文件。我们需要一个除C盘之外的盘保存这个文件。

====第2封邮件====

发件人：Li Qi
发送时间：2022-08-01 10:50:25.145000+00:00
邮件内容:
藕先生，您好：
       谨以此封邮件阐述我们双方针对这个问题所涉及范围界定： 
问题定义: 
天津农行反馈系统内文件不定期丢失问题，希望可以协助调查文件丢失原因。
问题范围: 
我们将协助您分析处理上述问题，并对定义的问题给予最大的技术支持。 
如果能及时解决问题，或问题属于产品设计的行为，或问题涉及到三方，我们将考虑关闭案例。如果存在多个问题，则我们考虑拆分案例进行分析。 
接下来，我们将开始合作解决这个问题。如果您对以上的问题范围界定有任何异议，请尽快告知。如果您有其他任何疑问。也欢迎随时与我联系。
下一步动作：
从之前收集的系统日志查看，问题电脑存在不正常关机的情况。
系统的不正常关机会意外中断磁盘的读写操作，如当前系统正在运行的应用进程存在磁盘读写动作，则会导致读写失败，进而应用和系统组件文件损坏，当再次运行时则会出现文件丢失或损坏的报错。
       由于用户的反馈为不定期会出现不同文件的丢失，因此接下来建议抓取P2V，以方便在本地进行问题的验证。具体步骤如下：
a.	下载disk2vhd工具保存这台机器上。附件密码为1234
b.	复现问题的电脑，进入命令行。
c.	从命令行运行如下命令：
disk2vhd.exe
d.	取消Use Volume Shadow Copy勾选，选择C盘，然后生成VHDX文件。我们需要一个除C盘之外的盘保存这个文件。

====第3封邮件====

发件人：Hongfa HF3 Ou
发送时间：2022-08-01 16:57:26.360000+00:00
邮件内容:
辛苦大家参会讨论一下关于开高级case的问题。
谢谢。
________________________________________________________________________________
Microsoft Teams 会议
使用电脑或移动应用加入
点击此处加入会议 <https://teams.microsoft.com/l/meetup-join/19%3ameeting_ZTcxMmQ1YjgtN2Q5NC00ZjkxLTkxNTktOTE2ZDNmZTM1MmRh%40thread.v2/0?context=%7b%22Tid%22%3a%225c7d0b28-bdf8-410c-aa93-4df372b16203%22%2c%22Oid%22%3a%229092ef7c-215c-4ea3-b3c0-565b1acbc1cf%22%7d> 
Meeting ID: 488 582 732 866 
密码: DFbvqp 
Download Teams <https://www.microsoft.com/en-us/microsoft-teams/download-app>  | 在 web 上加入 <https://www.microsoft.com/microsoft-teams/join-a-meeting> 
或呼入(仅音频)
+86 400 120 0423,,489319760# <tel:+864001200423,,489319760#>    China, 所有位置 
电话会议 ID: 489 319 760# 
查找本地号码 <https://dialin.teams.microsoft.com/e95cb7ca-86ab-4954-a7bd-2e18db5104ed?id=489319760>  | 重置 PIN <https://dialin.teams.microsoft.com/usp/pstnconferencing> 
了解更多 <https://aka.ms/JoinTeamsMeeting>  | 会议选项 <https://teams.microsoft.com/meetingOptions/?organizerId=9092ef7c-215c-4ea3-b3c0-565b1acbc1cf&tenantId=5c7d0b28-bdf8-410c-aa93-4df372b16203&threadId=19_meeting_ZTcxMmQ1YjgtN2Q5NC00ZjkxLTkxNTktOTE2ZDNmZTM1MmRh@thread.v2&messageId=0&language=zh-CN> 
OuHongfa (藕宏发)
18910864457
CSD L2 Technical Support

====第4封邮件====

发件人：Liu Jian
发送时间：2022-08-01 16:58:31.499000+00:00
邮件内容:
收到，++ @Li Yanjing <mailto:liyj@cmgos.com> 
Thank you for your time!
----------
Best Regards,
Carl Liu（刘健）
Mobile: + 86 13810968329 | Email: liujian@cmgos.com

====第5封邮件====

发件人：Li Qi
发送时间：2022-08-03 13:07:06.617000+00:00
邮件内容:
藕先生，您好：
       以下为这两天对于农行反馈的“文件损坏或丢失”问题的进度汇报，请查收：
基于之前用户上传的日志，如上封邮件所述，文件的丢失与损坏目前仍然怀疑和不正常关机有关。根据系统日志的判断均是后置判断，并且我们也无法猜测用户在操作系统所记录的意外关机时点正在做什么操作，以及操作系统并未记录的其他时点是否有导致问题相关的操作（例如用户的强制关闭系统导致系统日志并未来得及被记录的情景）。因此无法提供对于文件如何丢失问题的更为有效的说明。
       作为操作系统厂商，对于问题的分析基于最基本的一点，即“case by case”。回到“用户在启动360应用时，提示360文件丢失或损坏”的问题，需要询问三方应用厂商，基于什么样的场景会弹出此提示，如果仅仅是弹框提示的文件损坏，需要由应用厂商回答该文件可能被调用的场景（除应用启动检查外），以此来判断用户的何种操作可能导致此问题。进而避免发生类似情况。我们无法对于应用的执行逻辑进行判断与回答，也并无相应的监测手段与日志记录。
       如果用户再次反馈有关系统文件损坏或丢失的问题，我们可以对此提供协助分析工作。举个例子：如目前正在收集的系统启动出现“自动修复”的问题，该问题本身属于操作系统的no boot范畴，如果进一步判断为系统文件损坏导致，那么对于后续问题的规避，我们可以协助提供分析的手段来预置，并提供系统相关的日志工具来分析，而不是针对全部操作系统内容做不定向的整体监控，这一点无法做到，请您知悉并理解。谢谢。

====第6封邮件====

发件人：Li Qi
发送时间：2022-08-03 13:43:33.686000+00:00
邮件内容:
藕先生，您好：
       以下为这两天对于农行反馈的“文件损坏或丢失”问题的进度汇报，请查收：
基于之前用户上传的日志，如上封邮件所述，文件的丢失与损坏目前仍然怀疑和不正常关机有关。根据系统日志的判断均是后置判断，并且我们也无法猜测用户在操作系统所记录的意外关机时点正在做什么操作，以及操作系统并未记录的其他时点是否有导致问题相关的操作（例如用户的强制关闭系统导致系统日志并未来得及被记录的情景）。因此无法提供对于文件如何丢失问题的更为有效的说明。
       作为操作系统厂商，对于问题的分析基于最基本的一点，即“case by case”。回到“用户在启动360应用时，提示360文件丢失或损坏”的问题，需要询问三方应用厂商，基于什么样的场景会弹出此提示，如果仅仅是弹框提示的文件损坏，需要由应用厂商回答该文件可能被调用的场景（除应用启动检查外），以此来判断用户的何种操作可能导致此问题，进而避免发生类似情况。而且针对三方应用的行为，三方是可以在“事件来源-三方应用”中进行记录的，而操作系统只能通过查看这些记录的行为来排查是否与问题现象有关。我们无法对于应用的执行逻辑进行判断与回答，也并无相应的监测手段与日志记录。
       如果用户再次反馈有关系统文件损坏或丢失的问题，我们可以对此提供协助分析工作。这类分析工作的场景是指其不正常的状态一直记录在内存中，这种情况可以排查问题原因，也是通过事件日志等记录了才可以进行追溯该文件的损坏情况，如果没有记录，也无法排查损坏的来源。而不是针对全部操作系统内容做不定向的整体监控，这一点无法做到，由于没有记录，也就无法排查损坏的来源。并且说明一点，此类问题如果是大批量复现的，在排查到损坏的具体文件时，操作系统可以通过开启针对性的审计来进行预置，监控等动作，但出于系统性能问题考虑，该方式由于产生日志量过大，容易被冲掉也会严重影响系统性能。举个例子：如目前正在收集的系统启动出现“自动修复”的问题，该问题本身属于操作系统的no boot范畴，如果进一步判断为系统文件损坏导致，那么对于后续问题的处理，我们可以协助提供问题分析的手段，并提供系统相关的日志工具。
更新内容：
       基于之前的判断，对于当前问题的日志分析可以检查系统日志的磁盘NTFS方面，其对应的event ID为55,98：
从用户的日志来看，存在该类型日志记录，但并未找到具体到360文件的记录内容。
产生该日志的原因为：
*  多台服务器或存储同时对磁盘进行写操作
*  服务器意外重启/强制重启，OS 发出的一些涉及元数据的IO被中断
*  对磁盘进行变更，特别是扩展或者迁移磁盘/卷
*  硬件方面的原因，导致OS发出的数据通过SCSI/iSCSI/HBA 这样的硬件设备时IO没有写到正确的位置
*  文件系统过滤驱动比如杀毒软件，加密软件等 阻止了OS层面的一些IO 或者异常扫描导致文件层面的corruption
*  备份软件没有正常关闭文件handle
*  磁盘碎片过多
*  HBA驱动/固件问题
该日志的记录分读写两个场景考虑：
1.      当NTFS从磁盘读任何metadata(e.g. MFT records, directory index blocks, etc.)的时候会执行基本的健全性检查，以确保它结构良好，如果这些检查失败，则该文件被视为已损坏，然后在系统日志里面报NTFS 55，没有读取到这块问题的metadata数据的时候不会报错。
2.      将metadata元数据写入磁盘时，NTFS不会执行这些健全性检查，因为很影响性能。所以metadata元数据文件的损坏实际在系统日志NTFS 55之前就已经发生了，可能发生在几分钟之前，也有可能是几个小时之前。
---------
下一步动作：
修复文件系统：
1.     保存所有未保存的数据并关闭所有打开的程序单击开始，以管理员模式运行CMD
Chkdsk  X: /f
2.     如果NTFS 55消息定期出现，例如每天或每周，请使用/R命令行选项运行Chkdsk。此选项允许Chkdsk定位硬盘上的坏扇区。请在此操作前备份磁盘，此修复不可逆，防止因修复命令导致数据丢失。
Chkdsk  X: /f /R
3.     定期进行磁盘检查，确认现在磁盘状态，如果需要修复磁盘状态，都需要将磁盘进行备份，且修复磁盘状态并不是数据恢复。
如果没有出现NTFS的报错，chkdsk也没有提示发现错误，但文件依然没法正常打开，可能从NTFS文件结构上文件是好的，而应用无法正确处理，有可能是应用自身打开关闭文件、修改文件的问题。

====第7封邮件====

发件人：Li Qi
发送时间：2022-08-03 14:02:21.056000+00:00
邮件内容:
藕先生，您好：
       关于上午在用户现场有关“自动修复”问题的排查，经内部讨论，请参照以下内容：
1， 通过PE进入后，查看盘符C盘和I盘后发现均有EFI\Microsoft\Boot\BCD文件的存在。因此请跳转到这两个BCD的目录下后执行“bcdedit /store X:\EFI\Microsoft\Boot\BCD /enum active”，确认下图信息，我们需要首先明确红框内容来确定windows的引导文件。
2， 选择配置正确的引导文件的BCD进行设置，“bcdedit /store X:\EFI\Microsoft\Boot\BCD /set {default} advancedoptions on”和“bcdedit /store Z:\EFI\Microsoft\Boot\BCD /set {default} recoveryenabled no”,以确认图中所示的recoveryenabled = No，advancedoptions = Yes
3， 重新启动系统，查看是否出现报错信息。

====第8封邮件====

发件人：Li Qi
发送时间：2022-08-03 17:35:06.833000+00:00
邮件内容:
藕先生，您好：
       鉴于刚才的远程排查，目前在配置引导正确的情况下，仍然无法启动系统，因此判断当前问题为系统已损坏，经协商，针对此电脑，用户可以接受重装系统或一键恢复的方案。我的建议是：仅限于排查测试用的情况下，接下来此电脑的操作可以选择重装纯净版CMGE系统，供您参考。纯净镜像的安装过程会创建标准的磁盘分区，以避免出现类似引导出现问题，导致无法进入系统的情况。但请您考虑该电脑是否在未来可以为用户还原一键恢复功能或更换备机给用户，用户是否可以接受。如不行的话，我们可以再讨论其他方案。
供参考，纯净镜像的获取及标准安装：
1， 访问如下神州网信官方链接：https://download.cmgos.com/oem/login
2， 在“镜像下载-OEM用户下载”页面中，输入电脑蓝色标签上的SN号后，点击“验证”，获取镜像文件下载链接，并下载至本地
制作安装U盘：
参照如下链接：https://document.cmgos.com/docs/CreateBootableUSB.html
1)       准备一个不小于8GB的U盘
2)       启动当前系统进入桌面环境之后，将U盘插入电脑。在开始菜单中“Windows 系统->命令提示符”上点击右键，选择以管理员身份运行。
3)       在命令提示符窗口中输入diskpart，并回车。
4)       如弹出UAC窗口，请选择允许，进入diskpart程序。
5)       在Diskpart程序中，输入list disk查看当前的磁盘列表。
6)       根据容量查看自己的U盘对应的磁盘号。这里假定第一个磁盘为你的U盘。输入select disk 1选中你的U盘。
7)       输入clean，清除U盘内容。
8)       输入create part primary，用于在U盘中创建主分区。
9)       输入format，格式化刚刚创建好的磁盘分区。磁盘格式默认是FAT32。
10)    输入active，激活主分区。这步非常重要，如果忘记执行这条命令，制作的U盘将无法启动。
11)    输入exit，退出程序。
12)    在本地已下载的Windows 10神州网信政府版安装ISO镜像文件上点击右键，选择“装载”，将里面的内容全部复制到U盘中。
13)    至此，Windows10神州网信政府版启动U盘已经制作完毕。
安装Windows 10 神州网信政府版操作系统
1)       将待安装Windows 10 神州网信政府版操作系统的电脑关机。
2)       将制作的部署U盘插入计算机。
3)       使用U盘启动方式开机（各机型U盘启动方式不同，请根据实际情况查询本机U盘启动方式）。
4)       等待弹出安装界面，输入语言和其他首选项，点击下一步。
5)       点击现在安装。
6)       勾选“我接受许可条款”，点击下一步。
7)       选择“自定义：仅安装Windows（高级）”。
8)       点击下一步。
9)       进入安装进程，等待安装完成即可。
