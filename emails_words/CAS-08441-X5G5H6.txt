邮件主题：回复: [案例号:CAS-08441-X5G5H6] %|普通事件|HP| 使用神州网信系统无法设置共享打印机问题% 案例重新分配 CMIT:0001903

====第1封邮件====

发件人：Li Qi
发送时间：2023-03-13 17:04:22.675000+00:00
邮件内容:
杨先生，您好：
       如刚才远程处理，我谨以此封邮件阐述我们双方针对这个问题所涉及范围界定： 
问题定义: 
用户反馈USB直连打印机正常，设置共享打印机会报错，无法添加网络打印机。
问题范围: 
我们将协助您分析处理上述问题，并对定义的问题给予最大的技术支持。 
如果能及时解决问题，或问题属于产品设计的行为，或问题涉及到三方，我们将考虑关闭案例。如果存在多个问题，则我们考虑拆分案例进行分析。 
接下来，我们将开始合作解决这个问题。如果您对以上的问题范围界定有任何异议，请尽快告知。如果您有其他任何疑问。也欢迎随时与我联系。 
远程处理进度：
通过远程查看，SMB共享访问经过前期的用户设置，可以正常访问。您当前遇到的共享打印机连接问题是针对打印机共享访问时的问题，当前共看到两种问题：
问题1：安装共享打印机时，报错：“你计算机上一个有效的策略使你无法连接到此打印机队列。请与你的系统管理员联系。”
问题2：访问共享打印机时，报错：“你不能访问此共享文件夹，因为你组织的安全策略阻止未经身份验证的来宾访问。”
了解到用户当前的环境为：共享端：windows 7，未设置登录密码，开启guest账户。访问端：CMGE，开启guest账户，更新至最新补丁。
鉴于上面的背景介绍，排错过程如下：
问题1：出现该问题，是由于Microsoft在2021年9月强制增强RPC安全级别导致，临时的解决方案为在共享端修改或创建如下键值为0（默认情况下在增强RPC安全级别后，该键值为1）：
*  HKEY_LOCAL_MACHINE\System\CurrentControlSet\Control\Print，将DWORD类型的RpcAuthnLevelPrivacyEnabled设置为0
*  HKEY_LOCAL_MACHINE\Software\Policies\Microsoft\Windows NT\Printers\PointAndPrint，将DWORD类型的RestrictDriverInstallationToAdministrators设置为0
同时基于安全考虑，将共享端与客户端的guest账户禁用，并且为共享端windows 7设置登录密码。再次按照CMGE开启SMB共享访问的标准方法在客户端进行确认及配置。
但上述临时解决方案并并不能保证能修复现在存在的所有打印机问题。用户目前遇到的问题1并未解决，需要进一步研究。
问题2：由于在共享端增强安全性身份验证，禁用guest账户并设置登录密码导致，按照CMGE开启SMB共享访问的标准方法在客户端配置后该问题解决。
下一步动作：
*  用户可以继续观察是否存在其他共享访问的问题，如遇到，可随时回复此邮件联系。
*  神州网信内部跟进有关问题1的解决方案，如有更新，会第一时间联系用户告知。

====第2封邮件====

发件人：Li Qi
发送时间：2023-03-14 10:51:10.616000+00:00
邮件内容:
杨先生，您好：
       如刚才电话沟通，对于昨天遇到的远程连接问题，接下来我这边需要收集日志进一步查看，请您将附件内容保存至问题客户端和windows 7的共享端，稍后我远程联系您，谢谢。

====第3封邮件====

发件人：Li Qi
发送时间：2023-03-16 16:57:09.122000+00:00
邮件内容:
杨先生，您好：
       感谢您这几天对我工作的支持，经过这几天的排查，目前就您遇到的问题做如下总结，供您和HP的现场工程师参考。需要再次说明一点，连接网络共享打印机的过程可能有很多不同的原因导致失败，以下的方案仅限于当前您遇到的“你计算机上一个有效的策略使你无法连接到此打印队列。请与你的系统管理员联系。”问题
问题现象：
用户实际的现场环境：
1， 使用HP出厂预装的神州网信版操作系统：登录用户名统一为：HP；无登录密码；开启guest账户
2， Windows 7操作系统：登录用户名为：Administrator；无登录密码；开启guest账户
3， 各科室使用一台神州网信版操作系统直连打印机用于共享端；访问端包括同科室的其他神州网信版操作系统及windows 7操作系统
解决方案：
共享端配置：
1， 按照神州网信版操作系统的开启共享访问指导手册，设置组策略“网络访问:本地账户的共享和安全模型”为“经典 – 对本地用户进行身份验证,不改变其本来身份”；“从网络访问此计算机”中添加“everyone”和“administrators”的权限
2， 禁用guest账户
3， 添加或修改注册表键值：HKEY_LOCAL_MACHINE\System\CurrentControlSet\Control\Print 设置DWORD类型的注册表键RpcAuthnLevelPrivacyEnabled 为0
4， 添加或修改注册表键值：HKEY_LOCAL_MACHINE\Software\Policies\Microsoft\Windows NT\Printers设置DWORD类型的注册表键CopyFilesPolicy为0
5， 使用cmd命令“net stop spooler”和“net start spooler”重启打印服务
客户端配置：
1， 参照共享端配置步骤4设置CopyFilesPolicy键值
2， 修改注册表键值：HKEY_LOCAL_MACHINE\SOFTWARE\Policies\Microsoft\Windows NT\Printers\PackagePointAndPrint\PackagePointAndPrintOnly的键值改为0
3， 参照共享端配置步骤5重启打印服务
4， 手动添加打印机，步骤如下：
*  打开控制面板-设备和打印机-添加打印机，打开添加打印机向导
*  选择“我所需的打印机未列出”
*  选择添加本地打印机
*  端口选择“创建新端口”-端口类型为“Local Port”
*  输入端口名：\\共享端IP\打印机名称 <file://共享端IP/打印机名称> （如\\10.196.76.124\Canon <file://10.196.76.124/Canon>  LBP2900，具体参照各科室实际情况）
*  选择“从磁盘安装”，找到本地打印机驱动位置，通过导入inf文件方式完成打印机安装
对于Windows 7访问端，需要注意，由于共享端采用经典方式进行共享访问，因此实际现场的Windows 7环境默认并不能使用正确的用户凭证进行共享访问，因此在上述配置的步骤3前添加一步，手动“添加Windows凭据”，具体方法如下：
*  打开控制面板-凭据管理器，选择“Windows凭据”，点击“添加Windows凭据”
*  输入共享端IP及用户名和密码，点击“确定”
以上，为针对“你计算机上一个有效的策略使你无法连接到此打印队列。请与你的系统管理员联系。”问题的解决方案。请您和现场工程师进行同步，如有其他问题，可随时与我联系，谢谢。

====第4封邮件====

发件人：Li Qi
发送时间：2023-03-21 10:32:43.919000+00:00
邮件内容:
杨先生，您好：
       感谢您的理解，如刚才电话沟通，鉴于您目前所遇到的各类共享访问及连接打印机失败的问题，我稍作总结，供您参考，接下来，如您实际遇到无法解决的共享访问问题，可随时回复此邮件联系我，同时我也会保持每两天与您联系一次来跟进此案例进度，请您知悉：
1，“你计算机上一个有效的策略使你无法连接到此打印队列。请与你的系统管理员联系。”的问题，请参考上一封邮件的配置进行操作，务必从共享端和客户端逐一排查，最后使用本地端口方式添加共享打印机。
2，如遇到共享访问失败的问题，请先检查guest账户是否启用，如启用，请将guest账户禁用后，按照神州网信提供的开启共享访问配置进行检查。具体方法如下：
禁用guest账户：
右键点击开始菜单，选择“计算机管理”，选择本地用户和组，双击guest账户，勾选“账户已禁用”，点击确定。
开启共享访问功能：
1．以管理员身份进入CMD. 运行 gpedit.msc 命令进行组策略编辑，分别设置以下几项：
计算机配置->Windows设置->安全设置->本地策略->安全选项：将网络访问：本地账户的共享和安全模型
默认 仅来宾 修改为 经典-对本地用户进行身份验证……
2．计算机配置->Windows设置->安全设置->本地策略->用户权限分配->从网络访问此计算机
添加everyone和administrators组
如使用Windows 7系统作为共享端进行共享文件，Windows 10神州网信政府版系统如需访问此共享文件，除了需要开启上述2个组策略项外，需要开启以下组策略：

====第5封邮件====

发件人：Li Qi
发送时间：2023-03-23 09:55:30.610000+00:00
邮件内容:
杨先生，您好：
       如刚才电话沟通，经您的确认，当前处理的访问共享打印机问题已解决，此case将做关闭处理，以下为案例总结，请您知悉：
Case No：CAS-08441-X5G5H6
问题描述：
=================
用户反馈USB直连打印机正常，设置共享打印机会报错，无法添加网络打印机。
问题分析：
=================
经远程分析，因认证等级提升导致连接共享打印机出现问题，使用本地端口方式可以正常安装共享打印机，具体方法可参见以往邮件内容，用户已接受此解决方案，并成功解决此问题。
问题总结：
=================
经用户确认，目前问题已解决，该问题做关闭处理。
以上为此问题的案例总结，如有任何问题，可随时与我们联系，谢谢
