邮件主题：回复: [案例号: CAS-12143-P0Y2F1 ] % |P2|ICBC|工行用户反馈Win7系统补丁安装失败问题 % 初次响应 CMIT:0001339

====第1封邮件====

发件人：Wei Liang
发送时间：2024-09-10 14:32:53.379000+00:00
邮件内容:
许先生 您好：
感谢您的电话接听。
根据您提供的信息，我谨在此阐述我们双方针对这个问题所涉及范围界定：
问题定义:
工行用户反馈win7系统安装补丁KB4474419失败，在安装完成重启系统时进度显示9%左右时重启回滚，但是卸载TMS后可以正常安装补丁，需要CMIT协助排查导致补丁安装失败的根本原因。
问题范围:
我们将协助您分析处理上述问题，并对定义的问题给予最大的技术支持。
如果能及时解决问题，或问题属于产品设计的行为，或问题涉及到三方，我们将考虑关闭案例。如果存在多个问题，则我们考虑拆分案例进行分析。
接下来，我们将开始合作解决这个问题。如果您对以上的问题范围界定有任何异议，请尽快告知。如果您有其他任何疑问。也欢迎随时与我联系。
您提供的日志已经收到，正在排查问题，有任何进展会及时与您沟通，谢谢。

====第2封邮件====

发件人：Wei Liang
发送时间：2024-09-10 17:15:11.043000+00:00
邮件内容:
许先生 您好：
感谢您的电话接听。
查看您提供的问题设备的日志，可以看到安装KB4474419失败，报错为：0x80070005
查看详细的cbs日志，是由于更新驱动cpu.inf失败，导致的系统回滚，补丁KB4474419安装失败。
查看cpu.inf驱动安装日志，可以看到是在安装AMD K8 Processor驱动过程中，在添加AmdK8服务时，设置对应的Start Type出现0x00000005（拒绝访问）错误，最终导致整个cpu.inf驱动更新失败。
对比安装补丁成功的设备上的驱动更新过程，可以看到在安装AMD K8 Processor驱动过程时，有添加AmdK8服务，并复制amdk8.sys驱动。
以及AmdPPM服务和amdppm.sys驱动。
下一步计划：
请调整TMS策略，允许C:\Windows\servicing\TrustedInstaller.exe应用修改、更新以下注册表项中的内容。
HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\AmdK8
HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\AmdPPM
HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\intelppm
HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\Processor
HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\ViaC7
并允许将驱动amdk8.sys、amdppm.sys、intelppm.sys、processor.sys、viac7.sys复制到C:\Windows\system32\drivers\目录。

====第3封邮件====

发件人：Wei Liang
发送时间：2024-09-12 14:56:05.567000+00:00
邮件内容:
许先生 您好：
经过一系列的测试，安装完TMS管控应用后，注册表路径HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\下部分注册表键值无法修改，如amdk8、amdppm项和devmgr、gscfmgr等和TMS相关的项中的注册表键值，在修改时会提示更新失败，使用reg命令行修改时会提示“拒绝访问”错误。在安装应用更新补丁时，涉及到相关的驱动更新出现了0x00000005（拒绝访问）错误，导致更新补丁安装失败。
测试中发现，通过在WinPE中删除C:\windows\system32\drivers\krnlmgr.sys驱动，使操作系统启动后不再加载krnlmgr.sys驱动后，可以正常修改对应的HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\amdk8等的注册表键值。
krnlmgr.sys驱动是TMS应用的关键驱动，针对当前的案例问题，需要请应用厂商调整其安全策略，允许C:\Windows\servicing\TrustedInstaller.exe应用修改、更新以下注册表项中的内容。
HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\AmdK8
HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\AmdPPM
HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\intelppm
HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\Processor
HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\ViaC7
并允许将驱动amdk8.sys、amdppm.sys、intelppm.sys、processor.sys、viac7.sys复制到C:\Windows\system32\drivers\目录。
在使用过程中，需要TMS应用根据不同的使用场景配置合适的安全策略。

====第4封邮件====

发件人：Wei Liang
发送时间：2024-09-19 16:18:17.454000+00:00
邮件内容:
许先生 您好：
感谢您的电话接听。
如电话中所说，等您这边忙完近期的事情后，再和您沟通这个案例。
如果针对当前案件需要我们协助，可以通过邮件联系我们，谢谢。

====第5封邮件====

发件人：Wei Liang
发送时间：2024-09-24 11:38:01.070000+00:00
邮件内容:
许先生 您好：
感谢您的电话接听。
经过您的确认，我将暂时归档这个案例。
工单的归档并不会影响我们为您提供技术支持服务，如有其他问题，您可以随时联系我们。
案例总结：
----
问题定义：
工行用户反馈win7系统安装补丁KB4474419失败，在安装完成重启系统时进度显示9%左右时重启回滚，但是卸载TMS后可以正常安装补丁，需要CMIT协助排查导致补丁安装失败的根本原因。
问题总结：
最终用户近期未反馈这个补丁安装问题，同意暂时归档案例。
案例进展：
1、查看cbs日志，是由于更新驱动cpu.inf失败，导致的系统回滚，补丁KB4474419安装失败。
查看cpu.inf驱动安装日志，可以看到是在安装AMD K8 Processor驱动过程中，在添加AmdK8服务时，设置对应的Start Type出现0x00000005（拒绝访问）错误，最终导致整个cpu.inf驱动更新失败。
2、安装完TMS管控应用后，注册表路径HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\下部分注册表键值无法修改，如amdk8、amdppm项和devmgr、gscfmgr等和TMS相关的项中的注册表键值，在修改时会提示更新失败，使用reg命令行修改时会提示“拒绝访问”错误。在安装应用更新补丁时，涉及到相关的驱动更新出现了0x00000005（拒绝访问）错误，导致更新补丁安装失败。
3、测试中发现，通过在WinPE中删除C:\windows\system32\drivers\krnlmgr.sys驱动，使操作系统启动后不再加载krnlmgr.sys驱动后，可以正常修改对应的HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\amdk8等的注册表键值。
4、krnlmgr.sys驱动是TMS应用的关键驱动，针对当前的案例问题，需要请应用厂商调整其安全策略，允许C:\Windows\servicing\TrustedInstaller.exe应用修改、更新相关注册表项中的内容。
在使用过程中，需要TMS应用根据不同的使用场景配置合适的安全策略。
以上，如您后续有任何问题，可随时与我们联系，谢谢。
