<!--
 * @Author: pink-soda luckyli0127@gmail.com
 * @Date: 2024-11-28 14:55:34
 * @LastEditors: pink-soda luckyli0127@gmail.com
 * @LastEditTime: 2024-12-17 17:01:27
 * @FilePath: \test\show.html
 * @Description: 这是默认设置,请设置`customMade`, 打开koroFileHeader查看配置 进行设置: https://github.com/OBKoro1/koro1FileHeader/wiki/%E9%85%8D%E7%BD%AE
-->
<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet"/>
    <title>案例管理系统</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://code.jquery.com/ui/1.13.2/jquery-ui.min.js"></script>
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css">
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f9fafb;
            margin: 0;
            padding: 20px;
            min-width: 1600px;
            overflow-x: auto;
        }
        .container {
            display: flex;
            gap: 20px;
            margin: 0 auto;
            min-width: 1600px;
            position: relative;
        }
        .section {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            height: calc(100vh - 60px);
            overflow-y: auto;
            position: relative;
            min-width: 200px;
            max-width: none;
            flex: 0 0 auto;
        }
        .section:nth-child(1) {
            width: 400px;
            flex: none;
        }
        .section:nth-child(2) {
            width: 350px;
            flex: none;
        }
        .section:nth-child(3) {
            width: 370px;
            flex: none;
        }
        .section:nth-child(4) {
            width: 490px;
            flex: none;
            position: relative;
        }
        .section:nth-child(4) .result-area {
            height: calc(100vh - 200px);
            overflow-y: auto;
            position: relative;
            padding: 20px;
            background: white;
        }
        .section:nth-child(4) h2 {
            position: sticky;
            top: 0;
            background: white;
            padding: 16px 0;
            margin: 0;
            z-index: 10;
        }
        .section::-webkit-scrollbar {
            width: 8px;
        }
        .section::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }
        .section::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 4px;
        }
        .section::-webkit-scrollbar-thumb:hover {
            background: #a1a1a1;
        }
        h2 {
            font-size: 18px;
            font-weight: 500;
            margin-bottom: 24px;
            color: #111827;
        }
        .input-field {
            width: calc(100% - 24px);
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            margin-bottom: 16px;
            font-size: 14px;
        }
        .button {
            width: 100%;
            padding: 8px 16px;
            background-color: #3b82f6;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            margin-bottom: 8px;
        }
        .button.green {
            background-color: #22c55e;
        }
        .result-area {
            margin-top: 24px;
            padding: 16px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            background: #f9fafb;
            font-size: 14px;
        }
        .tag {
            position: relative;
            display: inline-block;
            padding: 4px 12px;
            background-color: #dbeafe;
            color: #1e40af;
            border-radius: 9999px;
            font-size: 14px;
            margin: 4px;
            cursor: default;
        }
        .tag .confidence {
            font-size: 12px;
            color: #4b5563;
            margin-left: 4px;
        }
        .tag:hover {
            background-color: #bfdbfe;
        }
        .info-row {
            display: flex;
            justify-content: space-between;
            font-size: 14px;
            margin-bottom: 8px;
        }
        .info-label {
            color: #6b7280;
        }
        .case-item {
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 16px;
            transition: background-color 0.2s;
        }
        .case-item:hover {
            background-color: #f9fafb;
        }
        .case-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        .case-header .button {
            padding: 6px 14px;
            font-size: 14px;
            font-weight: 500;
            margin: 0;
        }
        .case-header .button i {
            font-size: 16px;
        }
        .chat-area {
            height: 200px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 16px;
            overflow-y: auto;
            background: #fff;
        }
        .input-group {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
        }
        .input-group .input-field {
            flex: 1;
            margin-bottom: 0;
        }
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
        }
        .btn-primary {
            background-color: #3b82f6;
            color: white;
        }
        .btn-secondary {
            background-color: #6b7280;
            color: white;
        }
        .chat-message {
            margin-bottom: 12px;
            padding: 8px 12px;
            border-radius: 8px;
            max-width: 80%;
        }
        .user-message {
            background-color: #e5e7eb;
            margin-left: auto;
        }
        .system-message {
            background-color: #dbeafe;
            margin-right: auto;
        }
        .section-subtitle {
            font-size: 14px;
            color: #6b7280;
            margin-bottom: 12px;
        }
        .summary-btn {
            background-color: #4b5563;
            color: white;
            padding: 6px 14px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            margin-right: 8px;
        }
        .summary-btn:hover {
            background-color: #374151;
            transform: translateY(-1px);
        }
        .case-summary {
            margin-top: 12px;
            padding: 12px;
            background-color: #f3f4f6;
            border-radius: 6px;
            font-size: 14px;
            line-height: 1.5;
            color: #374151;
            border-left: 4px solid #3b82f6;
            display: none;
            transition: all 0.3s ease;
        }
        .button-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .button-group .button {
            width: auto;
            padding: 6px 14px;
            font-size: 14px;
            font-weight: 500;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        .button-group .button i {
            font-size: 16px;
        }
        .message-time {
            font-size: 12px;
            color: #6b7280;
            margin-right: 8px;
        }
        
        .message-content {
            display: inline-block;
        }
        
        .chat-message {
            display: flex;
            align-items: baseline;
            margin-bottom: 12px;
            padding: 8px 12px;
            border-radius: 8px;
            max-width: 80%;
        }
        
        .user-message {
            background-color: #e5e7eb;
            margin-left: auto;
            flex-direction: row-reverse;
        }
        
        .user-message .message-time {
            margin-right: 0;
            margin-left: 8px;
        }
        
        .system-message {
            background-color: #dbeafe;
            margin-right: auto;
        }
        .pdf-page {
            margin-bottom: 20px;
            padding: 20px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            background: white;
            width: calc(100% - 40px);
        }
        .pdf-text {
            font-size: 14px;
            line-height: 1.6;
            margin-bottom: 16px;
        }
        .pdf-images {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin: 16px 0;
        }
        .pdf-image {
            max-width: 100%;
            height: auto;
            border-radius: 4px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            transition: transform 0.2s;
        }
        .pdf-image:hover {
            transform: scale(1.02);
            cursor: pointer;
        }
        .page-number {
            text-align: right;
            color: #6b7280;
            font-size: 12px;
            margin-top: 8px;
            border-top: 1px solid #e5e7eb;
            padding-top: 8px;
        }
        .email-generator {
            margin-top: 20px;
            padding: 16px;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
        }
        .email-reference {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 16px;
        }
        .reference-select {
            flex: 1;  /* 让下拉框占据剩余空间 */
            padding: 6px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 14px;
        }
        .email-dialog {
            margin-top: 16px;
        }
        .progress-input {
            width: 100%;
            min-height: 120px;
            padding: 12px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            margin-bottom: 12px;
            font-size: 14px;
            resize: vertical;
            white-space: pre-wrap;
            overflow-y: auto;
            line-height: 1.5;
        }
        .email-header {
            margin-bottom: 12px;
        }
        .email-input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 14px;
            margin-bottom: 12px;
        }
        .generated-email {
            margin-top: 16px;
            padding: 16px;
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            min-height: 120px;
            width: calc(100% - 32px);
            font-size: 14px;
            line-height: 1.6;
            white-space: pre-wrap;
            overflow-y: auto;
            outline: none;
            resize: vertical;
            padding-right: 40px;
            margin-top: 0;  /* 移除顶部边距，因为现在由容器控制 */
            position: relative;
        }
        .copy-button {
            position: absolute;
            top: 8px;
            right: 2px;
            padding: 8px;
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid #d1d5db;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
            z-index: 10;
            display: none;
        }
        .template-selector {
            position: absolute;
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid #d1d5db;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            max-height: 300px;
            min-width: 200px;
            overflow-y: auto;
            z-index: 1000;
            padding: 10px;
            backdrop-filter: blur(5px);
        }
        .template-item {
            display: flex;
            align-items: center;
            padding: 8px 12px;
            cursor: pointer;
            transition: background 0.2s;
            border-radius: 4px;
            margin-bottom: 4px;
        }
        .template-item:hover {
            background: rgba(243, 244, 246, 0.8);
        }
        .template-item i {
            margin-right: 8px;
            color: #666;
        }
        .resizer {
            width: 5px;
            height: 100%;
            background: #e5e7eb;
            position: absolute;
            right: -2.5px;
            top: 0;
            cursor: col-resize;
            transition: background 0.2s;
            z-index: 100;
        }
        .resizer:hover {
            background: #3b82f6;
        }
        .section:nth-child(4) .result-area::-webkit-scrollbar {
            width: 8px;
        }
        .section:nth-child(4) .result-area::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }
        .section:nth-child(4) .result-area::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 4px;
        }
        .section:nth-child(4) .result-area::-webkit-scrollbar-thumb:hover {
            background: #a1a1a1;
        }
        .generated-email-container {
            position: relative;
            margin-top: 16px;
        }
        .tooltip-inner {
            background-color: #1e293b;
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 13px;
            line-height: 1.4;
        }
        
        .tooltip.show {
            opacity: 0.95;
        }

        /* 添加工具提示样式 */
        .tooltip {
            position: absolute;
            z-index: 1070;
            display: block;
            margin: 0;
            font-family: Arial, sans-serif;
            font-style: normal;
            font-weight: 400;
            line-height: 1.5;
            text-align: left;
            text-decoration: none;
            text-shadow: none;
            text-transform: none;
            letter-spacing: normal;
            word-break: normal;
            word-spacing: normal;
            white-space: normal;
            line-break: auto;
            font-size: 12px;
            word-wrap: break-word;
            opacity: 0;
            transition: opacity 0.15s linear;
        }

        .tooltip.show {
            opacity: 1;
        }

        .tooltip-inner {
            max-width: 300px;
            padding: 8px 12px;
            color: #fff;
            text-align: left;
            background-color: #000;
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
    </style>
</head>
<body>
    <!-- 在 body 标签下添加进度显示器 -->
    <div id="progressIndicator" style="
        position: fixed;
        top: 20px;
        right: 20px;
        background: white;
        padding: 15px;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        z-index: 1000;
        min-width: 200px;
    ">
        <div class="progress-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
            <span>处理进度</span>
            <span id="progressStatus" style="color: #666;">准备就绪</span>
        </div>
        <div class="progress-bar-container" style="background: #f3f4f6; height: 6px; border-radius: 3px; overflow: hidden;">
            <div id="progressBar" style="width: 0%; height: 100%; background: #3b82f6; transition: width 0.3s ease;"></div>
        </div>
        <div id="progressMessage" style="margin-top: 8px; font-size: 12px; color: #666;"></div>
    </div>

    <div class="container" style="position: relative;">
        <!-- 案例信息收集部分 -->
        <div class="section">
            <h2>案例信息收集</h2>
            <input type="text" id="caseId" class="input-field" placeholder="请输入案例编号">
            <button onclick="collectInfo()" class="button">收集信息</button>
            <div id="collectResult" class="result-area">
                <div class="info-row">
                    <span class="info-label">客户名称：</span>
                    <span>-</span>
                </div>
                <div class="info-row">
                    <span class="info-label">联系人：</span>
                    <span>-</span>
                </div>
                <div class="info-row">
                    <span class="info-label">联系电话：</span>
                    <span>-</span>
                </div>
                <div class="info-row">
                    <span class="info-label">案例标题：</span>
                    <span>-</span>
                </div>
                <div class="info-row">
                    <span class="info-label">系统版本：</span>
                    <span>-</span>
                </div>
                <div class="info-row">
                    <span class="info-label">case_owner：</span>
                    <span>-</span>
                </div>
                <div class="info-row">
                    <span class="info-label">案例进度：</span>
                    <span>-</span>
                </div>
            </div>
            <!-- 添加邮件生成部分 -->
            <div id="emailGenerator" class="email-generator" style="display: none;">
                <div class="email-reference">
                    <span>请参照案例</span>
                    <select id="referenceCaseSelect" class="reference-select" onchange="handleCaseSelect()">
                        <option value="">选择参考案例</option>
                    </select>
                    <span>生成邮件</span>
                </div>
                <div id="emailDialog" class="email-dialog" style="display: none;">
                    <textarea id="progressDescription" 
                              class="progress-input" 
                              placeholder="请输入当前进度描述..."></textarea>
                    <div class="email-header">
                        <div class="email-input-group">
                            <label>发送给：</label>
                            <textarea id="emailTo" class="email-input" rows="3"></textarea>
                        </div>
                        <div class="email-input-group">
                            <label>抄送给：</label>
                            <textarea id="emailCc" class="email-input" rows="3"></textarea>
                        </div>
                    </div>
                    <button onclick="generateEmail()" class="button">
                        <i class="fas fa-envelope"></i> 生成邮件
                    </button>
                    <div class="generated-email-container" style="position: relative;">
                        <div id="generatedEmail" class="generated-email" contenteditable="true"></div>
                        <button class="copy-button" onclick="copyEmailContent()" title="复制内容">
                            <i class="fas fa-copy"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 案例分类部分 -->
        <div class="section">
            <h2>案例分类</h2>
            <button onclick="queryCaseCategory()" class="button">
                <i class="fas fa-chevron-down"></i> 查询类别
            </button>
            <div id="tagContainer" class="tag-container"></div>
            <!-- 标签描述识别部分 -->
            <div class="section-subtitle">标签描述识别</div>
            <div id="chatArea" class="chat-area">
                <!-- 聊天消息将在这里显示 -->
            </div>
            <div class="input-group">
                <input type="text" id="tagDescription" class="input-field" placeholder="输入消息...">
                <div class="input-group-append">
                    <button class="btn btn-primary" onclick="sendDescription()">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                    <button class="btn btn-secondary" onclick="addNewTag()">
                        <i class="fas fa-plus"></i>
                    </button>
                </div>
            </div>
            
            <button onclick="confirmClassification()" class="button green">确认分类</button>
        </div>

        <!-- 历史案例列表部分 -->
        <div class="section" style="display: none;">
            <h2>历史案例列表</h2>
            <div id="similarCaseList" class="result-area">
                <!-- 动态内容将在这里显示 -->
            </div>
        </div>

        <!-- 案例详情部分 -->
        <div class="section" style="display: none;">
            <h2>历史邮件</h2>
            <div id="caseDetails" class="result-area">
                <!-- 动态内容将在这里显示 -->
            </div>
        </div>
    </div>

    <!-- All existing scripts remain unchanged -->
    <script>
        // ... (all existing JavaScript code remains unchanged) ...

        // 修改 updateTagDisplay 函数
        function updateTagDisplay() {
            const container = document.getElementById('tagContainer');
            const { categories, confidence_scores, explanations } = window.currentRecognitionResult || 
                { categories: [], confidence_scores: [], explanations: [] };
            
            // 清除现有的工具提示
            $('.tag[data-toggle="tooltip"]').tooltip('dispose');
            
            container.innerHTML = categories.map((category, index) => {
                const confidence = confidence_scores[index];
                const explanation = explanations[0] || ''; // 使用第一个解释
                const categoryLevels = category.split(' - ');
                const lastLevel = categoryLevels[categoryLevels.length - 1];
                
                return `
                    <div class="tag" 
                         data-toggle="tooltip" 
                         data-placement="top"
                         title="${explanation}"
                         style="display: inline-block; margin: 4px;">
                        ${lastLevel}
                        <span class="confidence">(${(confidence * 100).toFixed(0)}%)</span>
                        <span class="remove-tag" onclick="removeTag('${category}')">&times;</span>
                    </div>
                `;
            }).join('');
            
            // 重新初始化所有工具提示
            $('[data-toggle="tooltip"]').tooltip({
                container: 'body',
                placement: 'top',
                html: true,
                trigger: 'hover',
                template: `
                    <div class="tooltip" role="tooltip">
                        <div class="tooltip-inner"></div>
                    </div>
                `
            });
        }

        // 确保在页面加载完成后初始化工具提示
        document.addEventListener('DOMContentLoaded', function() {
            // 初始化工具提示
            $('[data-toggle="tooltip"]').tooltip({
                container: 'body',
                placement: 'top',
                html: true,
                trigger: 'hover'
            });
        });

        // 修改 sendDescription 函数
        async function sendDescription() {
            const description = document.getElementById('tagDescription').value.trim();
            if (!description) return;
            
            addMessageToChat(description, 'user');
            updateProgress(30, '分析中...', '正在分析描述文本');
            
            try {
                const response = await fetch('/tag-description', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ description: description })
                });
                
                const data = await response.json();
                console.log('Complete server response:', data);
                
                if (data.status === 'success' && data.result) {
                    const result = data.result;
                    
                    // 存储识别结果，使用正确的字段名
                    window.latestRecognitionResult = {
                        categories: result.categories || result.analysis || [],  // 兼容两种字段名
                        confidence_scores: result.confidence_scores || result.confidence || [],
                        explanations: [result.explanation]
                    };
                    
                    // 构建系统回复消息
                    let systemMessage = '';
                    
                    // 确保数据存在再进行遍历
                    const categories = result.categories || result.analysis || [];
                    const confidences = result.confidence_scores || result.confidence || [];
                    
                    if (categories.length > 0) {
                        categories.forEach((category, index) => {
                            // 获取分类的最后一级
                            const categoryLevels = category.split(' - ');
                            const lastLevel = categoryLevels[categoryLevels.length - 1];
                            const confidence = confidences[index];
                            
                            systemMessage += `${lastLevel} (${(confidence * 100).toFixed(0)}%)\n`;
                        });
                        
                        // 显示系统回复
                        addMessageToChat(systemMessage, 'system');
                        
                        // 更新标签显示
                        updateTagDisplay();
                        
                        // 更新进度条
                        updateProgress(100, '完成', '分析完成');
                    } else {
                        updateProgress(0, '错误', '未获取到分类结果');
                        addMessageToChat('未能识别出分类', 'system');
                    }
                } else {
                    updateProgress(0, '错误', '分类失败');
                    addMessageToChat('分类失败，请重试', 'system');
                }
            } catch (error) {
                updateProgress(0, '错误', '处理失败');
                console.error('Error details:', error);
                addMessageToChat('处理请求时出错: ' + error.message, 'system');
            }
            
            document.getElementById('tagDescription').value = '';
        }

        // 添加新标签的函数
        function addNewTag() {
            if (!window.latestRecognitionResult) {
                addMessageToChat('请先进行分类识别', 'system');
                return;
            }
            
            // 获取当前的识别结果
            const currentResult = window.currentRecognitionResult || {
                categories: [],
                confidence_scores: [],
                explanations: []
            };
            
            // 获取新的标签数据
            const newResult = window.latestRecognitionResult;
            
            // 合并新旧标签，避免重复（使用完整的分类路径进���比较）
            if (newResult.categories) {
                newResult.categories.forEach((category, index) => {
                    if (!currentResult.categories.includes(category)) {
                        currentResult.categories.push(category);
                        currentResult.confidence_scores.push(newResult.confidence_scores[index]);
                        if (newResult.explanations) {
                            currentResult.explanations.push(newResult.explanations[0]);
                        }
                    }
                });
            }
            
            // 更新当前识别结果
            window.currentRecognitionResult = currentResult;
            
            // 更新显示
            updateTagDisplay();
            
            // 更新进度条
            updateProgress(100, '完成', '标签添加成功');
            
            // 清除最新的识别结果，为下一次准备
            window.latestRecognitionResult = null;
        }

        // 移除标签的函数
        function removeTag(category) {
            if (!window.currentRecognitionResult) return;
            
            const index = window.currentRecognitionResult.categories.indexOf(category);
            if (index > -1) {
                window.currentRecognitionResult.categories.splice(index, 1);
                window.currentRecognitionResult.confidence_scores.splice(index, 1);
                if (window.currentRecognitionResult.explanations) {
                    window.currentRecognitionResult.explanations.splice(index, 1);
                }
            }
            
            updateTagDisplay();
            updateProgress(100, '完成', '标签移除成功');
        }

        // 修改 confirmClassification 函数
        async function confirmClassification() {
            const tagElements = document.getElementById('tagContainer').getElementsByClassName('tag');
            const tags = Array.from(tagElements).map(el => {
                const text = el.textContent.trim();
                return text.split(' (')[0].trim();
            });
            
            if (tags.length === 0) {
                addMessageToChat('请先添加标签', 'system');
                return;
            }

            try {
                const response = await fetch('/search-similar-cases', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ tags })
                });
                
                const data = await response.json();
                if (data.cases) {
                    // 显示历史案例列表
                    document.querySelector('.section:nth-child(3)').style.display = 'block';
                    updateCaseList(data.cases);
                    
                    // 更新下拉框选项并显示邮件生成器
                    const select = document.getElementById('referenceCaseSelect');
                    select.innerHTML = '<option value="">选择参考案例</option>' + 
                        data.cases.map(item => 
                            `<option value="${item.case_id}">${item.case_id}</option>`
                        ).join('');
                    
                    document.getElementById('emailGenerator').style.display = 'block';
                }
            } catch (error) {
                console.error('Error:', error);
                addMessageToChat('搜索相似案例失败', 'system');
            }
        }

        // 修改 updateCaseList 函数
        function updateCaseList(cases) {
            const sortedCases = cases.sort((a, b) => b.similarity_score - a.similarity_score);
            const caseList = document.getElementById('similarCaseList');
            
            caseList.innerHTML = sortedCases.map(item => `
                <div class="case-item">
                    <div class="case-header">
                        <span class="case-id">${item.case_id}</span>
                        <div class="button-group">
                            <button class="summary-btn" onclick="showSummary('${item.case_id}')">总结</button>
                            <button class="button" onclick="getCaseDetails('${item.case_id}')">
                                <i class="fas fa-eye"></i> 详情
                            </button>
                        </div>
                    </div>
                    <div id="summary-${item.case_id}" class="case-summary" style="display: none;"></div>
                    <div class="tags">
                        ${Array.isArray(item.categories) 
                            ? item.categories.map(tag => `<span class="tag">${tag}</span>`).join('')
                            : ''}
                    </div>
                </div>
            `).join('');
        }
            
        // 修改 collectInfo 函数
        async function collectInfo() {
            const caseId = document.getElementById('caseId').value;
            updateProgress(0, '收集信息中...', '正在获案例信息');       

            try {
                const response = await fetch('/collect-info', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ case_id: caseId })
                });
                
                const data = await response.json();
                if (data.status === 'success') {
                    updateCollectResult(data);
                    updateProgress(100, '完成', '案例信息收集完成');
                } else {
                    updateProgress(0, '错误', data.message || '收集信息失败');
                }
            } catch (error) {
                console.error('Error:', error);
                updateProgress(0, '错误', '收集信息失败');
            }
        }

        async function handleCaseSelect() {
            const select = document.getElementById('referenceCaseSelect');
            const emailDialog = document.getElementById('emailDialog');
            const caseDetails = document.getElementById('caseDetails');
            
            if (select.value) {
                emailDialog.style.display = 'block';
                
                // 加载选中案例的PDF内容
                try {
                    const response = await fetch('/load-case-email', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            case_id: select.value
                        })
                    });
                    
                    const data = await response.json();
                    if (data.success) {
                        // 更新历史邮件显示域
                        caseDetails.innerHTML = data.pages.map((page, pageIndex) => `
                            <div class="pdf-page">
                                <div class="pdf-text">${page.text}</div>
                                ${page.images ? `
                                    <div class="pdf-images">
                                        ${page.images.map(image => `
                                            <img src="${image}" class="pdf-image" alt="Page ${pageIndex + 1} image">
                                        `).join('')}
                                    </div>
                                ` : ''}
                                <div class="page-number">第 ${pageIndex + 1} 页</div>
                            </div>
                        `).join('');
                        
                        // 显示第四个section（历史邮件区域）
                        document.querySelector('.section:nth-child(4)').style.display = 'block';
                    }
                } catch (error) {
                    console.error('Error:', error);
                }
            } else {
                emailDialog.style.display = 'none';
                // 清空并隐藏历史邮件区域
                caseDetails.innerHTML = '';
                document.querySelector('.section:nth-child(4)').style.display = 'none';
            }
        }

        // 修改 updateCollectResult 函数
        function updateCollectResult(result) {
            const collectResult = document.getElementById('collectResult');
            collectResult.innerHTML = `
                <div class="info-row">
                    <span class="info-label">客户名称：</span>
                    <span>${result.customer_name || '-'}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">联系人：</span>
                    <span>${result.contact_person || '-'}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">联系电话：</span>
                    <span>${result.contact_phone || '-'}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">案例标题：</span>
                    <span>${result.project_subject || '-'}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">系统版本：</span>
                    <span>${result.system_version || '-'}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">case_owner：</span>
                    <span>${result.project_owner || '-'}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">案例进度：</span>
                    <span>${result.project_scale || '-'}</span>
                </div>
            `;
        }

        // 添加进度更新函数
        function updateProgress(percent, status, message) {
            const progressBar = document.getElementById('progressBar');
            const progressStatus = document.getElementById('progressStatus');
            const progressMessage = document.getElementById('progressMessage');
            
            progressBar.style.width = `${percent}%`;
            progressStatus.textContent = status;
            progressMessage.textContent = message;
            
            if (percent === 100) {
                progressBar.style.background = '#22c55e';  // 完成时显示绿色
            } else if (percent === 0) {
                progressBar.style.background = '#3b82f6';  // 初始状态显示蓝色
            }
        }

        // 添加生成邮件功能
        async function generateEmail() {
            const caseId = document.getElementById('referenceCaseSelect').value;
            const progress = document.getElementById('progressDescription').value.trim();
            const emailTo = document.getElementById('emailTo').value.trim();
            const emailCc = document.getElementById('emailCc').value.trim();
            
            if (!caseId || !progress) {
                addMessageToChat('请选择参考案例并填写进度描述', 'system');
                return;
            }

            updateProgress(30, '生成中...', '正在生成邮件内容');

            try {
                const response = await fetch('/generate-email', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        reference_case_id: caseId,
                        progress_description: progress,
                        reference_emails: document.getElementById('caseDetails').textContent,
                        case_info: {
                            customer_name: document.querySelector('.info-row:nth-child(1) span:last-child').textContent,
                            contact_person: document.querySelector('.info-row:nth-child(2) span:last-child').textContent,
                            contact_phone: document.querySelector('.info-row:nth-child(3) span:last-child').textContent,
                            project_subject: document.querySelector('.info-row:nth-child(4) span:last-child').textContent,
                            system_version: document.querySelector('.info-row:nth-child(5) span:last-child').textContent,
                            project_owner: document.querySelector('.info-row:nth-child(6) span:last-child').textContent,
                            project_scale: document.querySelector('.info-row:nth-child(7) span:last-child').textContent
                        }
                    })
                });

                const data = await response.json();
                if (data.success) {
                    const generatedEmail = document.getElementById('generatedEmail');
                    generatedEmail.textContent = data.email;
                    updateProgress(100, '完成', '邮件生成完成');
                    
                    // 显示复��按钮
                    document.querySelector('.copy-button').style.display = 'block';
                    
                    // 初始化模板选择功能
                    initTemplateSelector();
                } else {
                    updateProgress(0, '错误', '生成失败');
                    addMessageToChat('生成邮件失败：' + data.message, 'system');
                }
            } catch (error) {
                console.error('Error:', error);
                updateProgress(0, '错误', '生成失败');
                addMessageToChat('生成邮件失败，请重试', 'system');
            }
        }

        // 修改模选择器初始化函数
        function initTemplateSelector() {
            const emailContent = document.getElementById('generatedEmail');
            const selector = document.createElement('div');
            selector.className = 'template-selector';
            selector.style.display = 'none';
            document.body.appendChild(selector);  // 改为添加到 body
            
            emailContent.addEventListener('input', async function(e) {
                const selection = window.getSelection();
                const range = selection.getRangeAt(0);
                const cursorPos = range.startOffset;
                const text = this.textContent;
                
                const textBeforeCursor = text.substring(0, cursorPos);
                const lastAtIndex = textBeforeCursor.lastIndexOf('@');
                
                if (lastAtIndex !== -1 && lastAtIndex === cursorPos - 1) {
                    const rect = range.getBoundingClientRect();
                    
                    // 使用绝对定位相对于视窗
                    selector.style.position = 'fixed';
                    selector.style.left = `${rect.left}px`;
                    selector.style.top = `${rect.bottom + 5}px`;
                    
                    try {
                        const localFiles = await fetch('/scan-local-pdfs').then(res => res.json());
                        
                        selector.innerHTML = `
                            ${localFiles.pdfs.map(pdf => `
                                <div class="template-item" data-path="${pdf.path}">
                                    <i class="fas fa-file-pdf"></i>
                                    ${pdf.name}
                                </div>
                            `).join('')}
                        `;
                        
                        selector.style.display = 'block';
                        
                        // 修改击事件处理
                        selector.querySelectorAll('.template-item').forEach(item => {
                            item.onclick = async function(e) {
                                e.stopPropagation();
                                const templatePath = this.dataset.path;
                                await insertTemplate(templatePath, range);
                                selector.style.display = 'none';
                            };
                        });
                    } catch (error) {
                        console.error('Error loading PDFs:', error);
                    }
                } else {
                    selector.style.display = 'none';
                }
            });

            // 添加全局点击事件来关闭选择器
            document.addEventListener('click', function(e) {
                if (!selector.contains(e.target) && !e.target.closest('#generatedEmail')) {
                    selector.style.display = 'none';
                }
            });

            // 添加 ESC 键关闭选择器
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    selector.style.display = 'none';
                }
            });
        }

        // 添加 insertTemplate 函数
        async function insertTemplate(templatePath, range) {
            try {
                const response = await fetch('/get-template-content', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ path: templatePath })
                });
                
                const result = await response.json();
                if (result.success) {
                    // 删除@符号
                    range.setStart(range.startContainer, range.startOffset - 1);
                    range.deleteContents();
                    
                    // 创建一个临时容器
                    const tempContainer = document.createElement('div');
                    
                    // 按顺序插入内容块
                    result.content_blocks.forEach(block => {
                        if (block.type === 'text') {
                            const textNode = document.createTextNode(block.content);
                            tempContainer.appendChild(textNode);
                            tempContainer.appendChild(document.createElement('br'));
                        } else if (block.type === 'image') {
                            const img = document.createElement('img');
                            img.src = block.content;
                            img.style.maxWidth = '100%';
                            img.style.height = 'auto';
                            img.style.margin = '10px 0';
                            tempContainer.appendChild(img);
                            tempContainer.appendChild(document.createElement('br'));
                        }
                    });
                    
                    // 插入所有内容
                    range.insertNode(tempContainer);
                    
                    // 移动光标到内容末尾
                    range.setStartAfter(tempContainer);
                    range.collapse(true);
                    const selection = window.getSelection();
                    selection.removeAllRanges();
                    selection.addRange(range);
                }
            } catch (error) {
                console.error('Error inserting template:', error);
            }
        }

        // 页面加载完成时初始化进度条
        document.addEventListener('DOMContentLoaded', () => {
            updateProgress(0, '准备就绪', '等待操作');
        });

        // 添加复制功能
        function copyEmailContent() {
            const emailContent = document.getElementById('generatedEmail').textContent;
            navigator.clipboard.writeText(emailContent).then(() => {
                // 可以添加复制成功的提示
                const copyButton = document.querySelector('.copy-button');
                const originalIcon = copyButton.innerHTML;
                copyButton.innerHTML = '<i class="fas fa-check"></i>';
                setTimeout(() => {
                    copyButton.innerHTML = originalIcon;
                }, 1500);
            }).catch(err => {
                console.error('复制失败:', err);
            });
        }

        // 在 script 标签中添加 queryCaseCategory 函数
        async function queryCaseCategory() {
            const caseId = document.getElementById('caseId').value;
            if (!caseId) {
                addMessageToChat('请先输入案例编号', 'system');
                return;
            }

            updateProgress(30, '分析中...', '正在分析案例类别');

            try {
                const response = await fetch('/query-category', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ case_id: caseId })
                });

                const data = await response.json();
                console.log('Response data:', data);

                if (data.status === 'success' && data.result) {
                    window.currentRecognitionResult = {
                        categories: data.result.analysis,
                        confidence_scores: data.result.confidence,
                        explanations: [data.result.explanation]
                    };

                    updateTagDisplay();

                    if (data.result.explanation) {
                        addMessageToChat(data.result.explanation, 'system');
                    }

                    updateProgress(100, '完成', '案例分类完成');
                } else {
                    updateProgress(0, '错误', '分类失败');
                    addMessageToChat('分类失败，请尝试手动输入描述进行分类。', 'system');
                }
            } catch (error) {
                console.error('Error:', error);
                updateProgress(0, '错误', '分类失败');
                addMessageToChat('分类过程出现错误，请稍后重试或尝试手动输入描述。', 'system');
            }
        }

        // 在 script 标签中添加 addMessageToChat 函数
        function addMessageToChat(message, type) {
            const chatArea = document.getElementById('chatArea');
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message ${type}-message`;
            
            // 添加时间戳
            const timestamp = new Date().toLocaleTimeString();
            const timeSpan = document.createElement('span');
            timeSpan.className = 'message-time';
            timeSpan.textContent = timestamp;
            
            // 添加消息内容，保留换行格式
            const contentSpan = document.createElement('span');
            contentSpan.className = 'message-content';
            contentSpan.innerHTML = message.replace(/\n/g, '<br>');
            
            messageDiv.appendChild(timeSpan);
            messageDiv.appendChild(contentSpan);
            chatArea.appendChild(messageDiv);
            
            // 滚动到底部
            chatArea.scrollTop = chatArea.scrollHeight;
        }
        // 页面加载时初始化
        document.addEventListener('DOMContentLoaded', () => {
            initTemplateSelector();
            
            // 初始化邮箱自动补全
            const emailSuffixes = [
                '@cmgos.com',
                '@qq.com',
                '@163.com',
                '@126.com',
                '@gmail.com',
                '@hotmail.com',
                '@outlook.com',
                '@yahoo.com',
                '@foxmail.com'
            ];
            
            $('#emailTo, #emailCc').autocomplete({
                source: function(request, response) {
                    const term = request.term;
                    if (term.includes('@')) {
                        const prefix = term.split('@')[0];
                        response(emailSuffixes.map(suffix => prefix + suffix));
                    } else {
                        response([]);
                    }
                },
                minLength: 1
            });
        });
        // 在 script 标签中添加回车发送功能
        document.getElementById('tagDescription').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendDescription();
            }
        });

        // 添加 showSummary 函数
        async function showSummary(caseId) {
            try {
                const response = await fetch('/get-case-summary', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ case_id: caseId })
                });
                
                const data = await response.json();
                if (data.success) {
                    const summaryDiv = document.getElementById(`summary-${caseId}`);
                    summaryDiv.textContent = data.summary;
                    summaryDiv.style.display = summaryDiv.style.display === 'none' ? 'block' : 'none';
                }
            } catch (error) {
                console.error('Error:', error);
            }
        }

        // 添加 getCaseDetails 函数
        async function getCaseDetails(caseId) {
            try {
                const response = await fetch('/get-case-details', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ case_id: caseId })
                });
                
                const data = await response.json();
                if (data.status === 'success') {
                    document.querySelector('.section:nth-child(4)').style.display = 'block';
                    updateCaseDetails(data.details);
                }
            } catch (error) {
                console.error('Error:', error);
            }
        }

        // 添加 updateCaseDetails 函数
        function updateCaseDetails(details) {
            const caseDetails = document.getElementById('caseDetails');
            caseDetails.innerHTML = details.pages.map((page, pageIndex) => `
                <div class="pdf-page">
                    <div class="pdf-text">${page.text}</div>
                    ${page.images ? `
                        <div class="pdf-images">
                            ${page.images.map(image => `
                                <img src="${image.data}" class="pdf-image" alt="Page ${pageIndex + 1} image">
                            `).join('')}
                        </div>
                    ` : ''}
                    <div class="page-number">第 ${pageIndex + 1} 页</div>
                </div>
            `).join('');
        }

        // 在 script 标签中添加拖拽调节功能
        function initResizers() {
            const sections = document.querySelectorAll('.section');
            sections.forEach((section, index) => {
                if (index < sections.length - 1) {
                    // 创建调节器
                    const resizer = document.createElement('div');
                    resizer.className = 'resizer';
                    section.appendChild(resizer);
                    
                    let x = 0;
                    let w = 0;
                    let nextW = 0;
                    
                    const mouseDownHandler = function(e) {
                        x = e.clientX;
                        const styles = window.getComputedStyle(section);
                        w = parseInt(styles.width, 10);
                        const nextSection = section.nextElementSibling;
                        const nextStyles = window.getComputedStyle(nextSection);
                        nextW = parseInt(nextStyles.width, 10);
                        
                        document.addEventListener('mousemove', mouseMoveHandler);
                        document.addEventListener('mouseup', mouseUpHandler);
                        
                        // 添加正在调整的视觉反馈
                        resizer.style.background = '#3b82f6';
                    };
                    
                    const mouseMoveHandler = function(e) {
                        const dx = e.clientX - x;
                        const newWidth = w + dx;
                        const nextSection = section.nextElementSibling;
                        const newNextWidth = nextW - dx;
                        
                        // 检查最小宽度
                        if (newWidth >= 200 && newNextWidth >= 200) {
                            section.style.width = `${newWidth}px`;
                            nextSection.style.width = `${newNextWidth}px`;
                        }
                    };
                    
                    const mouseUpHandler = function() {
                        document.removeEventListener('mousemove', mouseMoveHandler);
                        document.removeEventListener('mouseup', mouseUpHandler);
                        
                        // 移除视觉反馈
                        resizer.style.background = '#e5e7eb';
                    };
                    
                    resizer.addEventListener('mousedown', mouseDownHandler);
                }
            });
        }

        // 在页面加载时初始化调节器
        document.addEventListener('DOMContentLoaded', function() {
            initResizers();
            // ... 其他初始化代码 ...
        });
    </script>
</body>
</html>

